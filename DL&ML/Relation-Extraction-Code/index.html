<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0"/><style data-href="/styles.d53766664f3eaba3db40.css" id="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-webkit-input-placeholder,textarea::-webkit-input-placeholder{color:#a0aec0}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#a0aec0}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}</style><meta name="generator" content="Gatsby 2.32.13"/><style type="text/css">
    .toc-header.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .toc-header.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .toc-header svg,
    h2 .toc-header svg,
    h3 .toc-header svg,
    h4 .toc-header svg,
    h5 .toc-header svg,
    h6 .toc-header svg {
      visibility: hidden;
    }
    h1:hover .toc-header svg,
    h2:hover .toc-header svg,
    h3:hover .toc-header svg,
    h4:hover .toc-header svg,
    h5:hover .toc-header svg,
    h6:hover .toc-header svg,
    h1 .toc-header:focus svg,
    h2 .toc-header:focus svg,
    h3 .toc-header:focus svg,
    h4 .toc-header:focus svg,
    h5 .toc-header:focus svg,
    h6 .toc-header:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32-1c5857f550ca5d27138682501fbd1e0a.png" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#3F4145"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512-1c5857f550ca5d27138682501fbd1e0a.png"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">RBERT for Relation Extraction: full code &amp; Wandb log | Young Jin&#x27;s Blog</title><meta data-react-helmet="true" name="description" content="Model Performance and log on weights and biases(wandb) 📈 Train and evaluation logs are visualized in this wandb link   Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5…"/><meta data-react-helmet="true" property="og:title" content="RBERT for Relation Extraction: full code &amp; Wandb log"/><meta data-react-helmet="true" property="og:image" content="/static/social-image-a1864c5d52ffceef83c1d6baedf4493b.png"/><meta data-react-helmet="true" property="og:description" content="Model Performance and log on weights and biases(wandb) 📈 Train and evaluation logs are visualized in this wandb link   Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:image" content="/static/social-image-a1864c5d52ffceef83c1d6baedf4493b.png"/><meta data-react-helmet="true" name="twitter:creator" content="Young Jin Ahn"/><meta data-react-helmet="true" name="twitter:title" content="RBERT for Relation Extraction: full code &amp; Wandb log"/><meta data-react-helmet="true" name="twitter:description" content="Model Performance and log on weights and biases(wandb) 📈 Train and evaluation logs are visualized in this wandb link   Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5…"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-b241e174f085821f3cec.js"/><link as="script" rel="preload" href="/framework-eb684e3e828ad13b3940.js"/><link as="script" rel="preload" href="/styles-84a9bc99193fe5828ffe.js"/><link as="script" rel="preload" href="/dc6a8720040df98778fe970bf6c000a41750d3ae-17eb047fb821ccbad0b0.js"/><link as="script" rel="preload" href="/app-97235b1800926a9fde68.js"/><link as="script" rel="preload" href="/d7eeaac4-dcbe97e7a5aa158c9d08.js"/><link as="script" rel="preload" href="/5e2a4920-da90abce4a08c86a094c.js"/><link as="script" rel="preload" href="/1bfc9850-b75b1f0cbf7150b5a94a.js"/><link as="script" rel="preload" href="/commons-605bc03228d7488be604.js"/><link as="script" rel="preload" href="/7a297f752dcfe258c0b0106d89edb3a916af916e-39861a37ba6e027ab9fb.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2baa1e84574778159db5.js"/><link as="fetch" rel="preload" href="/page-data/DL&amp;ML/Relation-Extraction-Code/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1081905842.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3911196313.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><noscript><style data-emotion-css="1vyo7ug">.css-1vyo7ug{position:fixed;bottom:0;left:0;margin-left:0.5rem;margin-bottom:0.5rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;box-shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06);-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-radius:0.25rem;--text-opacity:1;color:rgba(255,255,255,var(--text-opacity));font-size:0.875rem;font-weight:700;padding-left:1rem;padding-right:1rem;padding-top:0.75rem;padding-bottom:0.75rem;background-color:#86a8e7;z-index:9999;}</style><div class="css-1vyo7ug"><style data-emotion-css="5x4yj0">.css-5x4yj0{fill:currentColor;width:1.5rem;height:1.5rem;margin-right:0.5rem;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 192 512" class="css-5x4yj0" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 424.229h20V279.771H20c-11.046 0-20-8.954-20-20V212c0-11.046 8.954-20 20-20h112c11.046 0 20 8.954 20 20v212.229h20c11.046 0 20 8.954 20 20V492c0 11.046-8.954 20-20 20H20c-11.046 0-20-8.954-20-20v-47.771c0-11.046 8.954-20 20-20zM96 0C56.235 0 24 32.235 24 72s32.235 72 72 72 72-32.235 72-72S135.764 0 96 0z"></path></svg><style data-emotion-css="1f2k2gl">.css-1f2k2gl{margin-left:0.5rem;}</style><div class="css-1f2k2gl">Please enable JavaScript to use this site.<br/>JavaScript를 활성화 시켜주세요.</div></div></noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="f6s0ma">.css-f6s0ma{-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);background-color:#FFFFFF;color:#333333;}</style><style data-emotion-css="acifd">.css-acifd{min-height:100vh;-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);background-color:#FFFFFF;color:#333333;}</style><div class="css-acifd e60ayux0"><style data-emotion-css="8ezs2g">.css-8ezs2g{min-height:calc(100vh - 100px);}</style><div class="css-8ezs2g"><style data-emotion-css="1yxw6gp">.css-1yxw6gp{background:linear-gradient( 90deg,#7f7fd5,#86a8e7 );}</style><div class="css-1yxw6gp"><style data-emotion-css="1mqm4zt">.css-1mqm4zt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;max-width:1280px;margin-left:auto;margin-right:auto;padding:1.25rem;}</style><nav class="css-1mqm4zt e1czdvww0"><style data-emotion-css="1usmgm5">.css-1usmgm5{font-size:1.25rem;--text-opacity:1;color:rgba(255,255,255,var(--text-opacity));font-weight:700;}</style><a class="css-1usmgm5" href="/">Young Jin Ahn&#x27;s Blog</a><a aria-label="search page" href="/search"><style data-emotion-css="47445j">.css-47445j{--text-opacity:1;color:rgba(255,255,255,var(--text-opacity));margin-top:auto;margin-bottom:auto;width:2rem;height:2rem;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="css-47445j" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></a></nav></div><style data-emotion-css="aod07n">.css-aod07n{background:linear-gradient( 90deg,#7f7fd5,#86a8e7 );position:fixed;width:100%;box-shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06);z-index:100;-webkit-transition:all 300ms cubic-bezier(0,0,0.2,1);transition:all 300ms cubic-bezier(0,0,0.2,1);top:-100px;}</style><div class="css-aod07n"><nav class="css-1mqm4zt e1czdvww0"><a class="css-1usmgm5" href="/">Young Jin Ahn&#x27;s Blog</a><a aria-label="search page" href="/search"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="css-47445j" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></a></nav></div><style data-emotion-css="w27u98">.css-w27u98{margin-top:1rem;padding-left:1rem;padding-right:1rem;}</style><div class="blog-post-container css-w27u98"><div class="blog-post"><style data-emotion-css="1bdwg0l">.css-1bdwg0l{width:100%;max-width:768px;margin-left:auto;margin-right:auto;}</style><div class="css-1bdwg0l eyldt480"><style data-emotion-css="1abxlfd">.css-1abxlfd{font-size:2.25rem;font-weight:700;margin-bottom:1rem;}@media (min-width:768px){.css-1abxlfd{font-size:3rem;}}</style><h1 class="blog-title css-1abxlfd">RBERT for Relation Extraction: full code &amp; Wandb log</h1><style data-emotion-css="cpn9zx">.css-cpn9zx{font-size:1rem;margin-bottom:1rem;}</style><h2 class="blog-date css-cpn9zx">2021-10-09</h2><style data-emotion-css="cet0rr">.css-cet0rr{margin-bottom:0.5rem;}</style><div class="blog-tags css-cet0rr"><style data-emotion-css="1ak4bcm">.css-1ak4bcm{white-space:nowrap;-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);font-size:1rem;font-weight:700;border-radius:9999px;margin-right:0.5rem;margin-top:0.25rem;margin-bottom:0.25rem;padding-top:0.25rem;padding-bottom:0.25rem;padding-left:0.75rem;padding-right:0.75rem;background-color:#edf2f7;color:#3737B9;}</style><button class="css-1ak4bcm">NLP</button><button class="css-1ak4bcm">Competition</button></div><style data-emotion-css="1l4w6pd">.css-1l4w6pd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><div class="css-1l4w6pd"><style data-emotion-css="yapsbb">.css-yapsbb{border-radius:9999px;width:100%;height:1px;--bg-opacity:1;background-color:rgba(247,250,252,var(--bg-opacity));background:linear-gradient( 270deg,#7f7fd5,#86a8e7,#91eac9 );}</style><div class="css-yapsbb"></div></div></div><div class="blog-content"><style data-emotion-css="19vk1qv">.css-19vk1qv{-webkit-scrollbar-width:thin;-moz-scrollbar-width:thin;-ms-scrollbar-width:thin;scrollbar-width:thin;-webkit-scrollbar-color:gray transparent;-moz-scrollbar-color:gray transparent;-ms-scrollbar-color:gray transparent;scrollbar-color:gray transparent;display:none;}.css-19vk1qv::-webkit-scrollbar{width:4px;}.css-19vk1qv::-webkit-scrollbar-track{background-color:transparent;}.css-19vk1qv::-webkit-scrollbar-thumb{border-radius:9999px;background-color:gray;}.css-19vk1qv::-webkit-scrollbar-button{width:0;height:0;}@media screen and (min-width:1280px){.css-19vk1qv{float:right;position:-webkit-sticky;position:sticky;top:100px;width:calc((100vw - 720px) / 2 - 80px);max-width:250px;margin-right:1rem;overflow:auto;word-break:break-word;max-height:calc(100vh - 200px);fontsize:1rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;border-left-width:4px;border-image:linear-gradient( 180deg,#7f7fd5,#86a8e7,#91eac9 );border-image-slice:1;}}</style><div class="css-19vk1qv"><style data-emotion-css="13af3fo">.css-13af3fo{margin-left:1rem;margin-right:1rem;}</style><div class="css-13af3fo"><style data-emotion-css="17i5xbf">.css-17i5xbf{font-weight:700;margin-bottom:0.5rem;font-size:1.125rem;--text-opacity:1;color:rgba(74,85,104,var(--text-opacity));}</style><h3 class="css-17i5xbf">TOC</h3><style data-emotion-css="1me4zjn">.css-1me4zjn ul{margin-left:0.5rem;}.css-1me4zjn ul > li a:hover{color:#555555;}.css-1me4zjn ul > li a{-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);--text-opacity:1;color:rgba(160,174,192,var(--text-opacity));font-size:0.875rem;}.css-1me4zjn ul > li a[href=""]{font-size:0.95rem;color:#555555;}</style><div class="css-1me4zjn"><ul>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#model-performance-and-log-on-weights-and-biaseswandb">Model Performance and log on <code>weights and biases(wandb)</code></a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#rbert-explanation">RBERT explanation</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#config">Config</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#dataset">Dataset</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#evaluation-function">Evaluation function</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#custom-model-rbert-and-loss">Custom Model RBERT and Loss</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#train">Train</a></li>
<li><a href="/DL&#x26;ML/Relation-Extraction-Code/#inference-for-the-test-dataset">Inference for the Test Dataset</a></li>
</ul></div></div></div><div class="css-1bdwg0l eyldt480"><div><style data-emotion-css="c0q8g3">.css-c0q8g3{font-size:1rem;word-break:break-word;}.css-c0q8g3 h1 > a > svg,.css-c0q8g3 h2 > a > svg,.css-c0q8g3 h3 > a > svg,.css-c0q8g3 h4 > a > svg,.css-c0q8g3 h5 > a > svg,.css-c0q8g3 h6 > a > svg{fill:#000;}.css-c0q8g3 h1,.css-c0q8g3 h2{font-size:1.25rem;font-weight:600;margin-top:1.5rem;margin-bottom:1.5rem;}.css-c0q8g3 h3,.css-c0q8g3 h4,.css-c0q8g3 h5,.css-c0q8g3 h6{font-size:1.125rem;margin-top:1.5rem;margin-bottom:1.5rem;font-weight:600;}@media (min-width:640px){.css-c0q8g3 h1,.css-c0q8g3 h2{font-size:1.5rem;}.css-c0q8g3 h3,.css-c0q8g3 h4,.css-c0q8g3 h5,.css-c0q8g3 h6{font-size:1.25rem;}}.css-c0q8g3 a{color:#3737B9;}.css-c0q8g3 a:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-c0q8g3 p{margin:0.3rem;margin-top:0.75rem;margin-bottom:0.75rem;}.css-c0q8g3 ul,.css-c0q8g3 ol{margin:0.3rem;margin-left:2rem;}.css-c0q8g3 li > p,.css-c0q8g3 li > ul,.css-c0q8g3 li > ol{margin-bottom:0;}.css-c0q8g3 ol{list-style-type:decimal;}.css-c0q8g3 ul{list-style-type:disc;}.css-c0q8g3 blockquote{padding:0.5rem;background-color:#eee;margin:0.3rem;margin-top:0.5rem;margin-bottom:0.5rem;border-left-width:4px;border-color:#86a8e7;}.css-c0q8g3 blockquote > p{margin:0.5rem;}.css-c0q8g3 blockquote > h1,.css-c0q8g3 blockquote > h2,.css-c0q8g3 blockquote > h3,.css-c0q8g3 blockquote > h4,.css-c0q8g3 blockquote > h5{margin-top:0.5rem;margin-bottom:0.5rem;}.css-c0q8g3 td,.css-c0q8g3 th{padding-left:0.5rem;padding-right:0.5rem;padding-top:0.25rem;padding-bottom:0.25rem;border-width:1px;border-color:#86a8e7;}.css-c0q8g3 tr:nth-of-type(even){background-color:#eee;}.css-c0q8g3 th{background-color:#eee;}.css-c0q8g3 table{margin-bottom:1.5rem;display:block;max-width:-webkit-fit-content;max-width:-moz-fit-content;max-width:fit-content;margin:0 auto;overflow-x:auto;white-space:nowrap;}.css-c0q8g3 p > code,.css-c0q8g3 li > code{padding-top:0.1rem;padding-bottom:0.1rem;padding-right:0.25rem;padding-left:0.25rem;border-radius:0.25rem;color:#3737B9;background-color:#eee;white-space:pre-line;}.css-c0q8g3 pre.grvsc-container{margin-top:24px;margin-bottom:24px;}.css-c0q8g3 hr{margin-top:24px;margin-bottom:24px;height:2px;border:none;background:linear-gradient( 270deg,#7f7fd5,#86a8e7,#91eac9 );}</style><div class="markdown css-c0q8g3"><h2 id="model-performance-and-log-on-weights-and-biaseswandb" style="position:relative;"><a href="#model-performance-and-log-on-weights-and-biaseswandb" aria-label="model performance and log on weights and biaseswandb permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Model Performance and log on <code>weights and biases(wandb)</code></h2>
<p><a href="https://wandb.ai/snoop2head/KLUE-RE/runs/htwirbkj?workspace=user-snoop2head">📈 Train and evaluation logs are visualized in this wandb link</a></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 101.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAACfklEQVQ4y3VUWbLbMAzLLRJttmVZXuK8l057/7OxILQ4bzr94GijQFIEdBvnJHPO4oZRbBhoxoc+b/Z53nyan2s+sJtOHtbR7sZKwMW8bWK97/vGeV544JxrAC3rKimvBLnTz3O/A94roA2jDHEGSJBHmOio5y4EZDmJW57i80vi+Vvi8ZawfXHt0pOBb6UElKPO4yxu3sQMGKcF8xX7UQwArZY3JrHc38XCTESG6WAQg+DGuQJoPEABZmPmIS+pM8AVUDMsgXGJwSN9eIfzTIyeoanRCbKcGDPBmMmgZdsCqG+pvl7Hoc5rA7VJCtg6pCVYgFm8hUUZdnkR3GhprlzSC/+z1rxbcxzmLOOywzYZ09rHeXuyGZqBBh+m+I+NaOLERramwHmcJomzHkSOZT5LBke1VH0WD9+JZ0liSpiXcU6LpCWTEbdG2ELUobxNewZ/kfynX7jer67V1Oc2KTpIqtzzo1Jn4oGOvhr597HX19UuPwCWxdi7pKPHgalrU8v9bIq+pfr4ocit7dsuvd4pjwdOsj+fjPhwoXewsUF5GPMmx+ubtmx7IX+jTVOKG6P4uIhPOxXjwUUPpei+KsA26SmlwFdSTEfQinwFj1VRl1Iq+3mBEsu8YKhnd5WpWk6bhBUaBvlDPrE+KIYOyAyp0U08HKkUZEpHZGua9DQwM8xXplQXtKwZfkpPATWiR0T9FDgnYOwZts+Dz1KlSV8Fx32tlNJjOQR7VTuvedr5hs3PTamcA6SUX0b9BwjYRD+vh+TzLcvzW7La+Yvz4/1H/FRk5fAppHWX5fiCvWBn9f+S7fWm5rv09AdxWjo1W63OG8eaMi6f4fKtT/cX5hAeTcDY8mgAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Screen Shot 2021-10-08 at 9.08.50 AM"
        title="Screen Shot 2021-10-08 at 9.08.50 AM"
        src="/static/389718d5896d837fed4ea0b06015c2ad/c1b63/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png"
        srcset="/static/389718d5896d837fed4ea0b06015c2ad/5a46d/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 300w,
/static/389718d5896d837fed4ea0b06015c2ad/0a47e/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 600w,
/static/389718d5896d837fed4ea0b06015c2ad/c1b63/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 1200w,
/static/389718d5896d837fed4ea0b06015c2ad/d61c2/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 1800w,
/static/389718d5896d837fed4ea0b06015c2ad/922e6/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 2140w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWElEQVQoz31SSZLEMAjLM9r7njjp6v8/jxFy0jWHqTkQMAiZIG+pNjnOU9S7mMSG+DU9/2d/YTaPj5r1QYzzjEPK9Ho21sEHNr/0DHsxp9h4x+6b2wg0FollrQ8Zx5TaOghwSSisc5oQ2GxillB36ccpFrGNBfUMbJbNEZjuApIomjxgXVzZxfWLhIqLmFyJPXJ+fMQCx7if4tsEYVqEloRFXJ0kIJHGAGnTyxgShXtvi/Atvh4rBk57jI/PhLAy1k0KbOeKCT4IXIQqQll1Ek6SeQ4xuOvNcfmO49pUv/ugf9agZ+xPRXC5kSTsHxDuIHuvCREbaADCSIVVpUeY3/GjIAl1h3opV/MWi9+0+G2HiR12ri+CKmtTKlXaGFJ7p9KqssbHnBRDn4xia4e684LC1+1P+nldHGyJgkB/PZYiIWeSx1xoCTn3PHYf+D4jMHrJg+EZXus/TD8PRlN3dxMAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image-20211008090942237"
        title="image-20211008090942237"
        src="/static/13edf247729d58d03b24b33312f5acb6/c1b63/image-20211008090942237.png"
        srcset="/static/13edf247729d58d03b24b33312f5acb6/5a46d/image-20211008090942237.png 300w,
/static/13edf247729d58d03b24b33312f5acb6/0a47e/image-20211008090942237.png 600w,
/static/13edf247729d58d03b24b33312f5acb6/c1b63/image-20211008090942237.png 1200w,
/static/13edf247729d58d03b24b33312f5acb6/d61c2/image-20211008090942237.png 1800w,
/static/13edf247729d58d03b24b33312f5acb6/de9fe/image-20211008090942237.png 2146w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p>Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5 epochs). This was different from concat baseline model where its' evaluation loss sparks around 2000 steps(or 3 epochs). We concluded that providing more information of <code>[CLS]</code>, subject entity, object entity's hidden features enabled models to find deeper local minimum.</p>
<h2 id="rbert-explanation" style="position:relative;"><a href="#rbert-explanation" aria-label="rbert explanation permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RBERT explanation</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACQUlEQVQoz22S/U/acBDG+f//g+3X/bQtbskS52aWKEanm4IiBlARaIv0jb7T0pa2n51VYIle0t63T++eu+8910Csqip5Pfunp5TzqoRsVbFYrkiykjSviNMCJ0yJBVsVpcSV5MWKDYdYY31Y+yeLFzkz/Y6j8x16wwPiOKJzdM7eh120/ohQCuR5iea4/Lzp1DlFWdYcjaeP8oXMjHx2u232r1sMBn0+7f3m+lbBtgyOTi/Y+dXGDyJJroSwQnEcvl61+N8a6+48z6N/f8vO4QmtkUYlFR80SzpU8eVfGMUMVZPxRGURRfVYHucGnfEZaQaOHxIny+2VSyEo8hzX8VkmKUVRYNoOrgRKxdo7rs/cDV5GBJarM9KOpVv4uN+me6dtO1wTjx9t5v6CXFS57CvcK2aNq7pbdzjU7M317LnJaHAqolUct/qMNfO1KFPDRjcsPN+nOxgxnDyKSAsmms7DRGOszraEUvz8x1l9XoQhWZY+E1ZVuSGc2xau64qyMVHg0+te1dhCSJMkRtdnpGlax0aOx+XhXwrZuTzLt6I8tyhzFOfEqahqEwQhYZ5x8GdA/2EqOxnX2Ey3WK03TBLiMKrxSISqCYPIY2qqeGlCOlIJ7vqIJIShQ9a5pNnuMVAs1J6BGzhClqJNdIYDDS/x8KKQZRZvxtZQZg90ZLBm6pE1T1C/fcZYBmjKAOvde2bTG9m9gOaXG8bTIX5ic9aUQt8vMAIF0zFERGNLyBtmmaaoXLzCl7Jn87nzVspGg38DYY4iv+/zZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="image-20211008224657844"
        title="image-20211008224657844"
        src="/static/55ce894326815cec56f7c0f1037120b6/c1b63/image-20211008224657844.png"
        srcset="/static/55ce894326815cec56f7c0f1037120b6/5a46d/image-20211008224657844.png 300w,
/static/55ce894326815cec56f7c0f1037120b6/0a47e/image-20211008224657844.png 600w,
/static/55ce894326815cec56f7c0f1037120b6/c1b63/image-20211008224657844.png 1200w,
/static/55ce894326815cec56f7c0f1037120b6/5ba90/image-20211008224657844.png 1604w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
    </span></p>
<p>RBERT extracts hidden features wrapped around the entity markers commences average pooling. <strong>Key is to concatenate 1) [CLS], 2) Subject entity tokens’ hidden features' average, 3) Object entity tokens’ hidden features' average.</strong> Furthermore, in this competition, I customized to include entity wrappers around target entities and pooled those tokens also. This was to include more contextual information which divided target entities and other tokens. This is different from the original proposal at <a href="https://arxiv.org/pdf/1905.08284v1.pdf">Enriching Pre-trained Language Model with Entity Information for Relation Classification, Wu et al. 2019</a>.</p>
<h2 id="config" style="position:relative;"><a href="#config" aria-label="config permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Config</h2>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="0"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">&quot;&quot;&quot; define train data and test data path &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> os</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> glob </span><span class="mtk10 mtki">import</span><span class="mtk1"> glob</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">os.environ[</span><span class="mtk6">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;false&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">os.environ[</span><span class="mtk6">&quot;CUDA_LAUNCH_BLOCKING&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;1&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># root path</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">ROOT_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">abspath</span><span class="mtk1">(</span><span class="mtk6">&quot;.&quot;</span><span class="mtk1">) </span><span class="mtk5 mtki"># this makes compatible absolute path both for local and server</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># directory paths</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&#39;dataset&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">TRAIN_DATA_DIR</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;train&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">TEST_DATA_DIR</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;test&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">PRIDICTION_DIR</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&#39;prediction&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">BASELINE_DIR</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&#39;baseline-code&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># files paths</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">TRAIN_FILE_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">glob</span><span class="mtk1">(os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">TRAIN_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;*&#39;</span><span class="mtk1">))[</span><span class="mtk7">0</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">TEST_FILE_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">glob</span><span class="mtk1">(os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">TEST_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;*&#39;</span><span class="mtk1">))[</span><span class="mtk7">0</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">SAMPLE_SUBMISSION_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">PRIDICTION_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;sample_submission.csv&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">PORORO_TRAIN_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;train_pororo_sub.csv&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">PORORO_TEST_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;test_pororo_sub.csv&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">PORORO_SPECIAL_TOKEN_PATH</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">ROOT_DATA_DIR</span><span class="mtk1">, </span><span class="mtk6">&#39;pororo_special_token.txt&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk7">TRAIN_FILE_PATH</span><span class="mtk1">, </span><span class="mtk7">TEST_FILE_PATH</span><span class="mtk1">,</span><span class="mtk7">SAMPLE_SUBMISSION_PATH</span><span class="mtk1">)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="1"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">/opt/ml/klue-level2-nlp-15/dataset/train/train.csv /opt/ml/klue-level2-nlp-15/dataset/test/test_data.csv /opt/ml/klue-level2-nlp-15/prediction/sample_submission.csv</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="2"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">&quot;&quot;&quot; Set configuration as dictionary format &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> wandb</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> datetime </span><span class="mtk10 mtki">import</span><span class="mtk1"> datetime</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> easydict </span><span class="mtk10 mtki">import</span><span class="mtk1"> EasyDict</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># login wandb and get today&#39;s date until hour and minute</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">wandb.</span><span class="mtk3">login</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">today </span><span class="mtk8">=</span><span class="mtk1"> datetime.</span><span class="mtk3">now</span><span class="mtk1">().</span><span class="mtk3">strftime</span><span class="mtk1">(</span><span class="mtk6">&quot;%m</span><span class="mtk7">%d</span><span class="mtk6">_%H:%M&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># Debug set to true in order to debug high-layer code.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># CFG Configuration</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> wandb.config </span><span class="mtk5 mtki"># wandb.config provides functionality of easydict.EasyDict</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.</span><span class="mtk7">DEBUG</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">False</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># Dataset Config as constants</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_labels </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">30</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_workers </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">4</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.batch_size </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">40</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># Train configuration</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.user_name </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;snoop2head&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.file_base_name </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk10">f</span><span class="mtk6">&quot;</span><span class="mtk7">{CFG</span><span class="mtk1">.user_name</span><span class="mtk7">}</span><span class="mtk6">_</span><span class="mtk7">{</span><span class="mtk1">today</span><span class="mtk7">}</span><span class="mtk6">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.model_name </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;klue/roberta-large&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_folds </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">5</span><span class="mtk1"> </span><span class="mtk5 mtki"># 5 Fold as default</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_epochs </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">5</span><span class="mtk1"> </span><span class="mtk5 mtki"># loss is increasing after 5 epochs for xlm-roberta-large and 3 epochs for klue/roberta-large</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.max_token_length </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">128</span><span class="mtk1"> </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">4</span><span class="mtk1"> </span><span class="mtk5 mtki"># refer to EDA where Q3 is 119, there are only 460 sentences out of 32k train set</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.stopwords </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.learning_rate </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">5e-5</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.weight_decay </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1e-2</span><span class="mtk1"> </span><span class="mtk5 mtki"># https://paperswithcode.com/method/weight-decay</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.input_size </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">768</span><span class="mtk1"> </span><span class="mtk5 mtki"># 768 for klue/roberta-large, 1024 for klue/roberta-large</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.output_size </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">768</span><span class="mtk1"> </span><span class="mtk5 mtki"># 768 for klue/roberta-large, 1024 for klue/roberta-large</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_rnn_layers </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">3</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.dropout_rate </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0.1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># training steps configurations</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.save_steps </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">500</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.early_stopping_patience </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">5</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.warmup_steps </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">500</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.logging_steps </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">100</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.evaluation_strategy </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&#39;epoch&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.evaluation_steps </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">500</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># Directory configuration</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.result_dir </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&quot;results&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.saved_model_dir </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&quot;best_models&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.logging_dir </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&quot;logs&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.baseline_dir </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(os.path.</span><span class="mtk3">dirname</span><span class="mtk1">(</span><span class="mtk7">ROOT_PATH</span><span class="mtk1">), </span><span class="mtk6">&#39;baseline-code&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># file configuration</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.result_file </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.result_dir, </span><span class="mtk10">f</span><span class="mtk6">&quot;</span><span class="mtk7">{CFG</span><span class="mtk1">.file_base_name</span><span class="mtk7">}</span><span class="mtk6">.csv&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.saved_model_file </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.saved_model_dir, </span><span class="mtk10">f</span><span class="mtk6">&quot;</span><span class="mtk7">{CFG</span><span class="mtk1">.file_base_name</span><span class="mtk7">}</span><span class="mtk6">.pth&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.logging_file </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.logging_dir, </span><span class="mtk10">f</span><span class="mtk6">&quot;</span><span class="mtk7">{CFG</span><span class="mtk1">.file_base_name</span><span class="mtk7">}</span><span class="mtk6">.log&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.label_to_num_file </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.baseline_dir, </span><span class="mtk6">&#39;dict_label_to_num.pkl&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.num_to_label_file </span><span class="mtk8">=</span><span class="mtk1"> os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.baseline_dir, </span><span class="mtk6">&quot;dict_num_to_label.pkl&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.train_file_path </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">TRAIN_FILE_PATH</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.test_file_path </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">TEST_FILE_PATH</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.sample_submission_file_path </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">SAMPLE_SUBMISSION_PATH</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># Other configurations</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk7">CFG</span><span class="mtk1">.load_best_model_at_end </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">True</span></span></span></code></pre>
<h2 id="dataset" style="position:relative;"><a href="#dataset" aria-label="dataset permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dataset</h2>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="3"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> pandas </span><span class="mtk10 mtki">as</span><span class="mtk1"> pd</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> numpy </span><span class="mtk10 mtki">as</span><span class="mtk1"> np</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch.utils.data </span><span class="mtk10 mtki">import</span><span class="mtk1"> Dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> transformers </span><span class="mtk10 mtki">import</span><span class="mtk1"> AutoTokenizer, AutoConfig, AutoModelForSequenceClassification, Trainer, TrainingArguments</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> sklearn.model_selection </span><span class="mtk10 mtki">import</span><span class="mtk1"> StratifiedKFold</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># read pororo dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> pd.</span><span class="mtk3">read_csv</span><span class="mtk1">(</span><span class="mtk7">PORORO_TRAIN_PATH</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># remove the first index column</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> df_pororo_dataset.</span><span class="mtk3">drop</span><span class="mtk1">(df_pororo_dataset.columns[</span><span class="mtk7">0</span><span class="mtk1">], </span><span class="mtk4 mtki">axis</span><span class="mtk8">=</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="4"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> random</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">seed_everything</span><span class="mtk1">(</span><span class="mtk7 mtki">seed</span><span class="mtk1">) :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    torch.</span><span class="mtk3">manual_seed</span><span class="mtk1">(seed)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    torch.cuda.</span><span class="mtk3">manual_seed</span><span class="mtk1">(seed)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    torch.cuda.</span><span class="mtk3">manual_seed_all</span><span class="mtk1">(seed) </span><span class="mtk5 mtki"># if use multi-GPU</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    torch.backends.cudnn.deterministic </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">True</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    torch.backends.cudnn.benchmark </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">False</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    np.random.</span><span class="mtk3">seed</span><span class="mtk1">(seed)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    random.</span><span class="mtk3">seed</span><span class="mtk1">(seed)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">seed_everything</span><span class="mtk1">(</span><span class="mtk7">42</span><span class="mtk1">)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="5"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> pickle </span><span class="mtk10 mtki">as</span><span class="mtk1"> pickle</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">label_to_num</span><span class="mtk1">(</span><span class="mtk7 mtki">label</span><span class="mtk1">=</span><span class="mtk7">None</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk6">&quot;&quot;&quot; change the string labels into numerics &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  num_label </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">BASELINE_DIR</span><span class="mtk1">, </span><span class="mtk6">&quot;dict_label_to_num.pkl&quot;</span><span class="mtk1">), </span><span class="mtk6">&#39;rb&#39;</span><span class="mtk1">) </span><span class="mtk10 mtki">as</span><span class="mtk1"> f:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    dict_label_to_num </span><span class="mtk8">=</span><span class="mtk1"> pickle.</span><span class="mtk3">load</span><span class="mtk1">(f)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">for</span><span class="mtk1"> v </span><span class="mtk10">in</span><span class="mtk1"> label:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    num_label.</span><span class="mtk3">append</span><span class="mtk1">(dict_label_to_num[v])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">return</span><span class="mtk1"> num_label</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="6"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">class</span><span class="mtk1"> </span><span class="mtk11">CustomDataset</span><span class="mtk1">(</span><span class="mtk11">Dataset</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__init__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">dataset</span><span class="mtk1">, </span><span class="mtk7 mtki">tokenizer</span><span class="mtk1">, </span><span class="mtk7 mtki">is_training</span><span class="mtk1">: </span><span class="mtk8">bool</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">True</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># pandas.Dataframe dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.dataset </span><span class="mtk8">=</span><span class="mtk1"> dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.sentence </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.dataset[</span><span class="mtk6">&quot;sentence&quot;</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.subject_entity </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.dataset[</span><span class="mtk6">&quot;subject_entity&quot;</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.object_entity </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.dataset[</span><span class="mtk6">&quot;object_entity&quot;</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">if</span><span class="mtk1"> is_training:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">self</span><span class="mtk1">.train_label </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">label_to_num</span><span class="mtk1">(</span><span class="mtk11">self</span><span class="mtk1">.dataset[</span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">].values)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">if</span><span class="mtk1"> </span><span class="mtk10">not</span><span class="mtk1"> is_training:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">self</span><span class="mtk1">.train_label </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.dataset[</span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">].values</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.label </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">tensor</span><span class="mtk1">(</span><span class="mtk11">self</span><span class="mtk1">.train_label)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># tokenizer and etc</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.tokenizer </span><span class="mtk8">=</span><span class="mtk1"> tokenizer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__getitem__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">idx</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        sentence </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.sentence[idx]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.subject_entity[idx]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_entity </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.object_entity[idx]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        label </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.label[idx]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># concat entity in the beginning</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        concat_entity </span><span class="mtk8">=</span><span class="mtk1"> subject_entity </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk6">&quot;[SEP]&quot;</span><span class="mtk1"> </span><span class="mtk8">+</span><span class="mtk1"> object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># tokenize</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">tokenizer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            concat_entity,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            sentence,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">return_tensors</span><span class="mtk8">=</span><span class="mtk6">&quot;pt&quot;</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">padding</span><span class="mtk8">=</span><span class="mtk6">&quot;max_length&quot;</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">truncation</span><span class="mtk8">=</span><span class="mtk7">True</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">max_length</span><span class="mtk8">=</span><span class="mtk7">RBERT_CFG</span><span class="mtk1">.max_token_length,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">add_special_tokens</span><span class="mtk8">=</span><span class="mtk7">True</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">return_token_type_ids</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">,  </span><span class="mtk5 mtki"># for RoBERTa</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># RoBERTa&#39;s provided masks (do not include token_type_ids for RoBERTa)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict[</span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> encoded_dict[</span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">].</span><span class="mtk3">squeeze</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict[</span><span class="mtk6">&quot;attention_mask&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> encoded_dict[</span><span class="mtk6">&quot;attention_mask&quot;</span><span class="mtk1">].</span><span class="mtk3">squeeze</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># add subject and object entity masks where masks notate where the entity is</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity_mask, object_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">add_entity_mask</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            encoded_dict, subject_entity, object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict[</span><span class="mtk6">&quot;subject_mask&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> subject_entity_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict[</span><span class="mtk6">&quot;object_mask&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> object_entity_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># fill label</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        encoded_dict[</span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> label</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> encoded_dict</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__len__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk11">self</span><span class="mtk1">.dataset)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">add_entity_mask</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">encoded_dict</span><span class="mtk1">, </span><span class="mtk7 mtki">subject_entity</span><span class="mtk1">, </span><span class="mtk7 mtki">object_entity</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk6">&quot;&quot;&quot;add entity token to input_ids&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># print(&quot;tokenized input ids: \n&quot;,encoded_dict[&#39;input_ids&#39;])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># initialize entity masks</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">zeros</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.max_token_length, </span><span class="mtk4 mtki">dtype</span><span class="mtk8">=int</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">zeros</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.max_token_length, </span><span class="mtk4 mtki">dtype</span><span class="mtk8">=int</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># get token_id from encoding subject_entity and object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity_token_ids </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.tokenizer.</span><span class="mtk3">encode</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            subject_entity, </span><span class="mtk4 mtki">add_special_tokens</span><span class="mtk8">=</span><span class="mtk7">False</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_entity_token_ids </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.tokenizer.</span><span class="mtk3">encode</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            object_entity, </span><span class="mtk4 mtki">add_special_tokens</span><span class="mtk8">=</span><span class="mtk7">False</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># print(&quot;entity token&#39;s input ids: &quot;,subject_entity_token_ids, object_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># get the length of subject_entity and object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity_length </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(subject_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_entity_length </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(object_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># find coordinates of subject_entity_token_ids inside the encoded_dict[&quot;input_ids&quot;]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_coordinates </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">where</span><span class="mtk1">(encoded_dict[</span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">] </span><span class="mtk8">==</span><span class="mtk1"> subject_entity_token_ids[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_coordinates </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk8">int</span><span class="mtk1">, subject_coordinates[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># change the subject_coordinates into int type</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">for</span><span class="mtk1"> subject_index </span><span class="mtk10">in</span><span class="mtk1"> subject_coordinates:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            subject_entity_mask[</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                subject_index : subject_index </span><span class="mtk8">+</span><span class="mtk1"> subject_entity_length</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># find coordinates of object_entity_token_ids inside the encoded_dict[&quot;input_ids&quot;]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_coordinates </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">where</span><span class="mtk1">(encoded_dict[</span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">] </span><span class="mtk8">==</span><span class="mtk1"> object_entity_token_ids[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_coordinates </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk8">int</span><span class="mtk1">, object_coordinates[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># change the object_coordinates into int type</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">for</span><span class="mtk1"> object_index </span><span class="mtk10">in</span><span class="mtk1"> object_coordinates:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            object_entity_mask[object_index : object_index </span><span class="mtk8">+</span><span class="mtk1"> object_entity_length] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># print(subject_entity_mask)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># print(object_entity_mask)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> torch.</span><span class="mtk3">Tensor</span><span class="mtk1">(subject_entity_mask), torch.</span><span class="mtk3">Tensor</span><span class="mtk1">(object_entity_mask)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="7"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">&quot;&quot;&quot;Debugging add_entity_mask_sample function with sample code&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">tokenizer </span><span class="mtk8">=</span><span class="mtk1"> AutoTokenizer.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">special_token_list </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk7">PORORO_SPECIAL_TOKEN_PATH</span><span class="mtk1">, </span><span class="mtk6">&#39;r&#39;</span><span class="mtk1">, </span><span class="mtk4 mtki">encoding</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&#39;UTF-8&#39;</span><span class="mtk1">) </span><span class="mtk10 mtki">as</span><span class="mtk1"> f :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">for</span><span class="mtk1"> token </span><span class="mtk10">in</span><span class="mtk1"> f :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        special_token_list.</span><span class="mtk3">append</span><span class="mtk1">(token.</span><span class="mtk3">split</span><span class="mtk1">(</span><span class="mtk6">&#39;</span><span class="mtk8">\n</span><span class="mtk6">&#39;</span><span class="mtk1">)[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">added_token_num </span><span class="mtk8">=</span><span class="mtk1"> tokenizer.</span><span class="mtk3">add_special_tokens</span><span class="mtk1">({</span><span class="mtk6">&quot;additional_special_tokens&quot;</span><span class="mtk1">:</span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk8">set</span><span class="mtk1">(special_token_list))})</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">sample_item </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">CustomDataset</span><span class="mtk1">(df_pororo_dataset, tokenizer)[</span><span class="mtk7">0</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">decoded_item </span><span class="mtk8">=</span><span class="mtk1"> tokenizer.</span><span class="mtk3">decode</span><span class="mtk1">(sample_item[</span><span class="mtk6">&#39;input_ids&#39;</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">add_entity_mask_sample</span><span class="mtk1">(</span><span class="mtk7 mtki">item</span><span class="mtk1">, </span><span class="mtk7 mtki">subject_entity</span><span class="mtk1">, </span><span class="mtk7 mtki">object_entity</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># add entity token to input_ids</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk6">&quot;tokenized input ids: </span><span class="mtk8">\n</span><span class="mtk6">&quot;</span><span class="mtk1">,item[</span><span class="mtk6">&#39;input_ids&#39;</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># initialize entity masks</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    subject_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">zeros</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.max_token_length, </span><span class="mtk4 mtki">dtype</span><span class="mtk8">=int</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    object_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">zeros</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.max_token_length, </span><span class="mtk4 mtki">dtype</span><span class="mtk8">=int</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># get token_id from encoding subject_entity and object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    subject_entity_token_ids </span><span class="mtk8">=</span><span class="mtk1"> tokenizer.</span><span class="mtk3">encode</span><span class="mtk1">(subject_entity, </span><span class="mtk4 mtki">add_special_tokens</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    object_entity_token_ids </span><span class="mtk8">=</span><span class="mtk1"> tokenizer.</span><span class="mtk3">encode</span><span class="mtk1">(object_entity, </span><span class="mtk4 mtki">add_special_tokens</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># print(&quot;entity token&#39;s input ids: &quot;,subject_entity_token_ids, object_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># get the length of subject_entity and object_entity</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    subject_entity_length </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(subject_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    object_entity_length </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">len</span><span class="mtk1">(object_entity_token_ids)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># find coordinates of subject_entity_token_ids inside the item[&quot;input_ids&quot;]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    subject_coordinate </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">where</span><span class="mtk1">(item[</span><span class="mtk6">&#39;input_ids&#39;</span><span class="mtk1">] </span><span class="mtk8">==</span><span class="mtk1"> subject_entity_token_ids[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    subject_coordinate </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk8">int</span><span class="mtk1">, subject_coordinate[</span><span class="mtk7">0</span><span class="mtk1">])) </span><span class="mtk5 mtki"># change the subject_coordinate into int type</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">for</span><span class="mtk1"> subject_index </span><span class="mtk10">in</span><span class="mtk1"> subject_coordinate:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        subject_entity_mask[subject_index:subject_index</span><span class="mtk8">+</span><span class="mtk1">subject_entity_length] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># find coordinates of object_entity_token_ids inside the item[&quot;input_ids&quot;]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    object_coordinate </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">where</span><span class="mtk1">(item[</span><span class="mtk6">&#39;input_ids&#39;</span><span class="mtk1">] </span><span class="mtk8">==</span><span class="mtk1"> object_entity_token_ids[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    object_coordinate </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk8">map</span><span class="mtk1">(</span><span class="mtk8">int</span><span class="mtk1">, object_coordinate[</span><span class="mtk7">0</span><span class="mtk1">])) </span><span class="mtk5 mtki"># change the object_coordinate into int type</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">for</span><span class="mtk1"> object_index </span><span class="mtk10">in</span><span class="mtk1"> object_coordinate:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        object_entity_mask[object_index:object_index</span><span class="mtk8">+</span><span class="mtk1">object_entity_length] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># print(subject_entity_mask)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk5 mtki"># print(object_entity_mask)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">return</span><span class="mtk1"> subject_entity_mask, object_entity_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># print(sample_item)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(decoded_item)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">subject_entity_mask, object_entity_mask </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">add_entity_mask_sample</span><span class="mtk1">(sample_item, </span><span class="mtk6">&#39;[SUB-PERSON]비틀즈[/SUB-PERSON]&#39;</span><span class="mtk1">	, </span><span class="mtk6">&#39;[OBJ-PERSON]조지 해리슨[/OBJ-PERSON]&#39;</span><span class="mtk1">)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="8"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">[CLS]&#39;[SUB-PERSON] 비틀즈 [/SUB-PERSON]&#39;[SEP]&#39;[OBJ-PERSON] 조지 해리슨 [/OBJ-PERSON]&#39;[SEP] 〈 Something 〉 는 [OBJ-PERSON] 조지 해리슨 [/OBJ-PERSON] 이 쓰고 [SUB-PERSON] 비틀즈 [/SUB-PERSON] 가 1969년 앨범 《 Abbey Road 》 에 담은 노래다. [SEP] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">(array([0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),</span></span>
<span class="grvsc-line"><span class="grvsc-source"> array([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]))</span></span></code></pre>
<ul>
<li><code>[SUB-PERSON] 비틀즈 [/SUB-PERSON]</code> is given example's subject entity.</li>
<li><code>[OBJ-PERSON] 조지 해리슨 [/OBJ-PERSON]</code> is given example's object entity.</li>
<li>As shown on the result above, we can see that entity masks annotates the location of the corresponding entities with 1 and rest of tokens as 0.</li>
<li>Rather than using entities’ token only, surrounding entity markers were also pooled. This was to include more contextual information which divided target entities and other tokens. This is different from the original proposal at <a href="https://arxiv.org/pdf/1905.08284v1.pdf">Enriching Pre-trained Language Model with Entity Information for Relation Classification, Wu et al. 2019</a>.</li>
</ul>
<h2 id="evaluation-function" style="position:relative;"><a href="#evaluation-function" aria-label="evaluation function permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Evaluation function</h2>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="9"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">class</span><span class="mtk1"> </span><span class="mtk11">Metrics</span><span class="mtk1">(</span><span class="mtk8">object</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__init__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">reset</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">reset</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.val </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.avg </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.sum </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.count </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">update</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">val</span><span class="mtk1">, </span><span class="mtk7 mtki">n</span><span class="mtk1">=</span><span class="mtk7">1</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.val </span><span class="mtk8">=</span><span class="mtk1"> val</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.sum </span><span class="mtk8">+=</span><span class="mtk1"> val </span><span class="mtk8">*</span><span class="mtk1"> n</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.count </span><span class="mtk8">+=</span><span class="mtk1"> n</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.avg </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.sum </span><span class="mtk8">/</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.count</span></span></span></code></pre>
<h2 id="custom-model-rbert-and-loss" style="position:relative;"><a href="#custom-model-rbert-and-loss" aria-label="custom model rbert and loss permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Model RBERT and Loss</h2>
<p><img src="https://user-images.githubusercontent.com/28896432/68673458-1b090d00-0597-11ea-96b1-7c1453e6edbb.png" alt="img"></p>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="10"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch </span><span class="mtk10 mtki">import</span><span class="mtk1"> nn</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch.nn </span><span class="mtk10 mtki">as</span><span class="mtk1"> nn</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> transformers </span><span class="mtk10 mtki">import</span><span class="mtk1"> AutoModel, AutoConfig, AutoTokenizer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">class</span><span class="mtk1"> </span><span class="mtk11">FCLayer</span><span class="mtk1">(</span><span class="mtk11">nn</span><span class="mtk1">.</span><span class="mtk11">Module</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk6">&quot;&quot;&quot;R-BERT: https://github.com/monologg/R-BERT/blob/master/model.py&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__init__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">input_dim</span><span class="mtk1">, </span><span class="mtk7 mtki">output_dim</span><span class="mtk1">, </span><span class="mtk7 mtki">dropout_rate</span><span class="mtk1">=</span><span class="mtk7">0.0</span><span class="mtk1">, </span><span class="mtk7 mtki">use_activation</span><span class="mtk1">=</span><span class="mtk7">True</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk8">super</span><span class="mtk1">(FCLayer, </span><span class="mtk11">self</span><span class="mtk1">).</span><span class="mtk8">__init__</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.use_activation </span><span class="mtk8">=</span><span class="mtk1"> use_activation</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.dropout </span><span class="mtk8">=</span><span class="mtk1"> nn.</span><span class="mtk3">Dropout</span><span class="mtk1">(dropout_rate)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.linear </span><span class="mtk8">=</span><span class="mtk1"> nn.</span><span class="mtk3">Linear</span><span class="mtk1">(input_dim, output_dim)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.tanh </span><span class="mtk8">=</span><span class="mtk1"> nn.</span><span class="mtk3">Tanh</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">forward</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">x</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        x </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">dropout</span><span class="mtk1">(x)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">if</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.use_activation:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            x </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">tanh</span><span class="mtk1">(x)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">linear</span><span class="mtk1">(x)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">class</span><span class="mtk1"> </span><span class="mtk11">RBERT</span><span class="mtk1">(</span><span class="mtk11">nn</span><span class="mtk1">.</span><span class="mtk11">Module</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk6">&quot;&quot;&quot;R-BERT: https://github.com/monologg/R-BERT/blob/master/model.py&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__init__</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11 mtki">self</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">model_name</span><span class="mtk1">: </span><span class="mtk8">str</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;klue/roberta-large&quot;</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">num_labels</span><span class="mtk1">: </span><span class="mtk8">int</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">30</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">dropout_rate</span><span class="mtk1">: </span><span class="mtk8">float</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0.1</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">special_tokens_dict</span><span class="mtk1">: </span><span class="mtk8">dict</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">None</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">is_train</span><span class="mtk1">: </span><span class="mtk8">bool</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">True</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk8">super</span><span class="mtk1">(</span><span class="mtk7">RBERT</span><span class="mtk1">, </span><span class="mtk11">self</span><span class="mtk1">).</span><span class="mtk8">__init__</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.model_name </span><span class="mtk8">=</span><span class="mtk1"> model_name</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.tokenizer </span><span class="mtk8">=</span><span class="mtk1"> AutoTokenizer.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        config </span><span class="mtk8">=</span><span class="mtk1"> AutoConfig.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.backbone_model </span><span class="mtk8">=</span><span class="mtk1"> AutoModel.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(model_name, </span><span class="mtk4 mtki">config</span><span class="mtk8">=</span><span class="mtk1">config)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.dropout_rate </span><span class="mtk8">=</span><span class="mtk1"> dropout_rate</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.num_labels </span><span class="mtk8">=</span><span class="mtk1"> num_labels</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        config.num_labels </span><span class="mtk8">=</span><span class="mtk1"> num_labels</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># add special tokens</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.special_tokens_dict </span><span class="mtk8">=</span><span class="mtk1"> special_tokens_dict</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.backbone_model.</span><span class="mtk3">resize_token_embeddings</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(</span><span class="mtk11">self</span><span class="mtk1">.tokenizer))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.cls_fc_layer </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">FCLayer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            config.hidden_size, config.hidden_size, </span><span class="mtk11">self</span><span class="mtk1">.dropout_rate</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.entity_fc_layer </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">FCLayer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            config.hidden_size, config.hidden_size, </span><span class="mtk11">self</span><span class="mtk1">.dropout_rate</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.label_classifier </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">FCLayer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            config.hidden_size </span><span class="mtk8">*</span><span class="mtk1"> </span><span class="mtk7">3</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">self</span><span class="mtk1">.num_labels,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk11">self</span><span class="mtk1">.dropout_rate,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">use_activation</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">entity_average</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">hidden_output</span><span class="mtk1">, </span><span class="mtk7 mtki">e_mask</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk6">&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">        Average the entity hidden state vectors (H_i ~ H_j)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">        :param hidden_output: [batch_size, j-i+1, dim]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">        :param e_mask: [batch_size, max_seq_len]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">                e.g. e_mask[0] == [0, 0, 0, 1, 1, 1, 0, 0, ... 0]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">        :return: [batch_size, dim]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">        &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        e_mask_unsqueeze </span><span class="mtk8">=</span><span class="mtk1"> e_mask.</span><span class="mtk3">unsqueeze</span><span class="mtk1">(</span><span class="mtk7">1</span><span class="mtk1">)  </span><span class="mtk5 mtki"># [b, 1, j-i+1]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        length_tensor </span><span class="mtk8">=</span><span class="mtk1"> (e_mask </span><span class="mtk8">!=</span><span class="mtk1"> </span><span class="mtk7">0</span><span class="mtk1">).</span><span class="mtk3">sum</span><span class="mtk1">(</span><span class="mtk4 mtki">dim</span><span class="mtk8">=</span><span class="mtk7">1</span><span class="mtk1">).</span><span class="mtk3">unsqueeze</span><span class="mtk1">(</span><span class="mtk7">1</span><span class="mtk1">)  </span><span class="mtk5 mtki"># [batch_size, 1]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># [b, 1, j-i+1] * [b, j-i+1, dim] = [b, 1, dim] -&gt; [b, dim]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        sum_vector </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">bmm</span><span class="mtk1">(e_mask_unsqueeze.</span><span class="mtk3">float</span><span class="mtk1">(), hidden_output).</span><span class="mtk3">squeeze</span><span class="mtk1">(</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        avg_vector </span><span class="mtk8">=</span><span class="mtk1"> sum_vector.</span><span class="mtk3">float</span><span class="mtk1">() </span><span class="mtk8">/</span><span class="mtk1"> length_tensor.</span><span class="mtk3">float</span><span class="mtk1">()  </span><span class="mtk5 mtki"># broadcasting</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> avg_vector</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">forward</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11 mtki">self</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">input_ids</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">attention_mask</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">subject_mask</span><span class="mtk1">=</span><span class="mtk7">None</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">object_mask</span><span class="mtk1">=</span><span class="mtk7">None</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk7 mtki">labels</span><span class="mtk1">=</span><span class="mtk7">None</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        outputs </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">backbone_model</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">input_ids</span><span class="mtk8">=</span><span class="mtk1">input_ids, </span><span class="mtk4 mtki">attention_mask</span><span class="mtk8">=</span><span class="mtk1">attention_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        sequence_output </span><span class="mtk8">=</span><span class="mtk1"> outputs[</span><span class="mtk6">&quot;last_hidden_state&quot;</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        pooled_output </span><span class="mtk8">=</span><span class="mtk1"> outputs[</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk6">&quot;pooler_output&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ]  </span><span class="mtk5 mtki"># [CLS] token&#39;s hidden featrues(hidden state)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># hidden state&#39;s average in between entities</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># print(sequence_output.shape, subject_mask.shape)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        e1_h </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">entity_average</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            sequence_output, subject_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># token in between subject entities -&gt;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        e2_h </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">entity_average</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            sequence_output, object_mask</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># token in between object entities</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># Dropout -&gt; tanh -&gt; fc_layer (Share FC layer for e1 and e2)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        pooled_output </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">cls_fc_layer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            pooled_output</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># [CLS] token -&gt; hidden state | green on diagram</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        e1_h </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">entity_fc_layer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            e1_h</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># subject entity&#39;s fully connected layer | yellow on diagram</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        e2_h </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">entity_fc_layer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            e2_h</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )  </span><span class="mtk5 mtki"># object entity&#39;s fully connected layer | red on diagram</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># Concat -&gt; fc_layer / [CLS], subject_average, object_average</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        concat_h </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">cat</span><span class="mtk1">([pooled_output, e1_h, e2_h], </span><span class="mtk4 mtki">dim</span><span class="mtk8">=-</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        logits </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.</span><span class="mtk3">label_classifier</span><span class="mtk1">(concat_h)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> logits</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># WILL USE FOCAL LOSS INSTEAD OF MSELoss and CrossEntropyLoss</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># outputs = (logits,) + outputs[2:]  # add hidden states and attention if they are here</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># # Softmax</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># if labels is not None:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#     if self.num_labels == 1:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#         loss_fct = nn.MSELoss()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#         loss = loss_fct(logits.view(-1), labels.view(-1))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#     else:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#         loss_fct = nn.CrossEntropyLoss()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#         loss = loss_fct(logits.view(-1, self.num_labels), labels.view(-1))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#     outputs = (loss,) + outputs</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki">#  return outputs  # (loss), logits, (hidden_states), (attentions)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="11"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch.nn </span><span class="mtk10 mtki">as</span><span class="mtk1"> nn</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">import</span><span class="mtk1"> torch.nn.functional </span><span class="mtk10 mtki">as</span><span class="mtk1"> F</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch.autograd </span><span class="mtk10 mtki">import</span><span class="mtk1"> Variable</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">class</span><span class="mtk1"> </span><span class="mtk11">FocalLoss</span><span class="mtk1">(</span><span class="mtk11">nn</span><span class="mtk1">.</span><span class="mtk11">Module</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk8">__init__</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">weight</span><span class="mtk1">=</span><span class="mtk7">None</span><span class="mtk1">, </span><span class="mtk7 mtki">gamma</span><span class="mtk1">=</span><span class="mtk7">2.0</span><span class="mtk1">, </span><span class="mtk7 mtki">reduction</span><span class="mtk1">=</span><span class="mtk6">&quot;mean&quot;</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        nn.Module.</span><span class="mtk8">__init__</span><span class="mtk1">(</span><span class="mtk11">self</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.weight </span><span class="mtk8">=</span><span class="mtk1"> weight</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.gamma </span><span class="mtk8">=</span><span class="mtk1"> gamma</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk11">self</span><span class="mtk1">.reduction </span><span class="mtk8">=</span><span class="mtk1"> reduction</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">forward</span><span class="mtk1">(</span><span class="mtk11 mtki">self</span><span class="mtk1">, </span><span class="mtk7 mtki">input_tensor</span><span class="mtk1">, </span><span class="mtk7 mtki">target_tensor</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        log_prob </span><span class="mtk8">=</span><span class="mtk1"> F.</span><span class="mtk3">log_softmax</span><span class="mtk1">(input_tensor, </span><span class="mtk4 mtki">dim</span><span class="mtk8">=-</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        prob </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">exp</span><span class="mtk1">(log_prob)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">return</span><span class="mtk1"> F.</span><span class="mtk3">nll_loss</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            ((</span><span class="mtk7">1</span><span class="mtk1"> </span><span class="mtk8">-</span><span class="mtk1"> prob) </span><span class="mtk8">**</span><span class="mtk1"> </span><span class="mtk11">self</span><span class="mtk1">.gamma) </span><span class="mtk8">*</span><span class="mtk1"> log_prob,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            target_tensor,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">weight</span><span class="mtk8">=</span><span class="mtk11">self</span><span class="mtk1">.weight,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">reduction</span><span class="mtk8">=</span><span class="mtk11">self</span><span class="mtk1">.reduction,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span></code></pre>
<h2 id="train" style="position:relative;"><a href="#train" aria-label="train permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Train</h2>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="12"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">device </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">device</span><span class="mtk1">(</span><span class="mtk6">&#39;cuda:0&#39;</span><span class="mtk1"> </span><span class="mtk10 mtki">if</span><span class="mtk1"> torch.cuda.</span><span class="mtk3">is_available</span><span class="mtk1">() </span><span class="mtk10 mtki">and</span><span class="mtk1"> </span><span class="mtk7">CFG</span><span class="mtk1">.</span><span class="mtk7">DEBUG</span><span class="mtk1"> </span><span class="mtk8">==</span><span class="mtk1"> </span><span class="mtk7">False</span><span class="mtk1"> </span><span class="mtk10 mtki">else</span><span class="mtk1"> </span><span class="mtk6">&#39;cpu&#39;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(device)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="13"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">cuda:0</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="14"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># fetch tokenizer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">tokenizer </span><span class="mtk8">=</span><span class="mtk1"> AutoTokenizer.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># fetch special tokens annotated with ner task</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">special_token_list </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk7">PORORO_SPECIAL_TOKEN_PATH</span><span class="mtk1">, </span><span class="mtk6">&#39;r&#39;</span><span class="mtk1">, </span><span class="mtk4 mtki">encoding</span><span class="mtk1"> </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&#39;UTF-8&#39;</span><span class="mtk1">) </span><span class="mtk10 mtki">as</span><span class="mtk1"> f :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">for</span><span class="mtk1"> token </span><span class="mtk10">in</span><span class="mtk1"> f :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        special_token_list.</span><span class="mtk3">append</span><span class="mtk1">(token.</span><span class="mtk3">split</span><span class="mtk1">(</span><span class="mtk6">&#39;</span><span class="mtk8">\n</span><span class="mtk6">&#39;</span><span class="mtk1">)[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># add special pororo ner tokens to the tokenizer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">added_token_num </span><span class="mtk8">=</span><span class="mtk1"> tokenizer.</span><span class="mtk3">add_special_tokens</span><span class="mtk1">({</span><span class="mtk6">&quot;additional_special_tokens&quot;</span><span class="mtk1">:</span><span class="mtk8">list</span><span class="mtk1">(</span><span class="mtk8">set</span><span class="mtk1">(special_token_list))})</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">added_token_num</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="15"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">74</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="16"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">criterion </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">FocalLoss</span><span class="mtk1">(</span><span class="mtk4 mtki">gamma</span><span class="mtk8">=</span><span class="mtk7">1.0</span><span class="mtk1">) </span><span class="mtk5 mtki"># 0.0 equals to CrossEntropy</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="17"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># read pororo ner labeled dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> pd.</span><span class="mtk3">read_csv</span><span class="mtk1">(</span><span class="mtk7">PORORO_TRAIN_PATH</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># remove the first index column</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> df_pororo_dataset.</span><span class="mtk3">drop</span><span class="mtk1">(df_pororo_dataset.columns[</span><span class="mtk7">0</span><span class="mtk1">], </span><span class="mtk4 mtki">axis</span><span class="mtk8">=</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset.</span><span class="mtk3">head</span><span class="mtk1">(</span><span class="mtk7">2</span><span class="mtk1">)</span></span></span></code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre class="grvsc-container one-dark-pro" data-language="" data-index="18"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">.dataframe tbody tr th {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    vertical-align: top;</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">.dataframe thead th {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    text-align: right;</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>sentence</th>
      <th>label</th>
      <th>subject_entity</th>
      <th>object_entity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>〈Something〉는 [OBJ-PERSON]조지 해리슨[/OBJ-PERSON]이 ...</td>
      <td>no_relation</td>
      <td>'[SUB-PERSON]비틀즈[/SUB-PERSON]'</td>
      <td>'[OBJ-PERSON]조지 해리슨[/OBJ-PERSON]'</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>호남이 기반인 바른미래당·[OBJ-ORGANIZATION]대안신당[/OBJ-ORGA...</td>
      <td>no_relation</td>
      <td>'[SUB-ORGANIZATION]민주평화당[/SUB-ORGANIZATION]'</td>
      <td>'[OBJ-ORGANIZATION]대안신당[/OBJ-ORGANIZATION]'</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="19"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> sklearn.metrics </span><span class="mtk10 mtki">import</span><span class="mtk1"> f1_score, confusion_matrix</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch.utils.data.dataset </span><span class="mtk10 mtki">import</span><span class="mtk1"> Subset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch.utils.data </span><span class="mtk10 mtki">import</span><span class="mtk1"> DataLoader</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> transformers </span><span class="mtk10 mtki">import</span><span class="mtk1"> get_cosine_schedule_with_warmup</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> adamp </span><span class="mtk10 mtki">import</span><span class="mtk1"> AdamP</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> transformers </span><span class="mtk10 mtki">import</span><span class="mtk1"> AdamW</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> tqdm </span><span class="mtk10 mtki">import</span><span class="mtk1"> tqdm</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> easydict </span><span class="mtk10 mtki">import</span><span class="mtk1"> EasyDict</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># read pororo dataset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> pd.</span><span class="mtk3">read_csv</span><span class="mtk1">(</span><span class="mtk7">DATA_CFG</span><span class="mtk1">.pororo_train_path)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># remove the first index column</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_pororo_dataset </span><span class="mtk8">=</span><span class="mtk1"> df_pororo_dataset.</span><span class="mtk3">drop</span><span class="mtk1">(df_pororo_dataset.columns[</span><span class="mtk7">0</span><span class="mtk1">], </span><span class="mtk4 mtki">axis</span><span class="mtk8">=</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># fetch tokenizer</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">tokenizer </span><span class="mtk8">=</span><span class="mtk1"> AutoTokenizer.</span><span class="mtk3">from_pretrained</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># fetch special tokens annotated with ner task</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">special_token_list </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(</span><span class="mtk7">DATA_CFG</span><span class="mtk1">.pororo_special_token_path, </span><span class="mtk6">&quot;r&quot;</span><span class="mtk1">, </span><span class="mtk4 mtki">encoding</span><span class="mtk8">=</span><span class="mtk6">&quot;UTF-8&quot;</span><span class="mtk1">) </span><span class="mtk10 mtki">as</span><span class="mtk1"> f:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">for</span><span class="mtk1"> token </span><span class="mtk10">in</span><span class="mtk1"> f:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    special_token_list.</span><span class="mtk3">append</span><span class="mtk1">(token.</span><span class="mtk3">split</span><span class="mtk1">(</span><span class="mtk6">&quot;</span><span class="mtk8">\n</span><span class="mtk6">&quot;</span><span class="mtk1">)[</span><span class="mtk7">0</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">if</span><span class="mtk1"> torch.cuda.</span><span class="mtk3">is_available</span><span class="mtk1">() </span><span class="mtk10">and</span><span class="mtk1"> </span><span class="mtk7">CFG</span><span class="mtk1">.debug </span><span class="mtk8">==</span><span class="mtk1"> </span><span class="mtk7">False</span><span class="mtk1">:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      device </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">device</span><span class="mtk1">(</span><span class="mtk6">&quot;cuda&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk10">f</span><span class="mtk6">&quot;There are </span><span class="mtk7">{</span><span class="mtk1">torch.cuda.</span><span class="mtk3">device_count</span><span class="mtk1">()</span><span class="mtk7">}</span><span class="mtk6"> GPU(s) available.&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk6">&quot;GPU Name:&quot;</span><span class="mtk1">, torch.cuda.</span><span class="mtk3">get_device_name</span><span class="mtk1">(</span><span class="mtk7">0</span><span class="mtk1">))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      </span><span class="mtk10 mtki">else</span><span class="mtk1">:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk6">&quot;No GPU, using CPU.&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        device </span><span class="mtk8">=</span><span class="mtk1"> torch.</span><span class="mtk3">device</span><span class="mtk1">(</span><span class="mtk6">&quot;cpu&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        criterion </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">FocalLoss</span><span class="mtk1">(</span><span class="mtk4 mtki">gamma</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.gamma)  </span><span class="mtk5 mtki"># 0.0 equals to CrossEntropy</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        train_data </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">RBERT_Dataset</span><span class="mtk1">(df_pororo_dataset, tokenizer)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        dev_data </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">RBERT_Dataset</span><span class="mtk1">(df_pororo_dataset, tokenizer)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        stf </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">StratifiedKFold</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk4 mtki">n_splits</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.num_folds, </span><span class="mtk4 mtki">shuffle</span><span class="mtk8">=</span><span class="mtk7">True</span><span class="mtk1">, </span><span class="mtk4 mtki">random_state</span><span class="mtk8">=</span><span class="mtk3">seed_everything</span><span class="mtk1">(</span><span class="mtk7">42</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk10 mtki">for</span><span class="mtk1"> fold_num, (train_idx, dev_idx) </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk8">enumerate</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          stf.</span><span class="mtk3">split</span><span class="mtk1">(df_pororo_dataset, </span><span class="mtk8">list</span><span class="mtk1">(df_pororo_dataset[</span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">]))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        ):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk10">f</span><span class="mtk6">&quot;#################### Fold: </span><span class="mtk7">{</span><span class="mtk1">fold_num </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">1}</span><span class="mtk6"> ######################&quot;</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          train_set </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">Subset</span><span class="mtk1">(train_data, train_idx)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          dev_set </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">Subset</span><span class="mtk1">(dev_data, dev_idx)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          train_loader </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">DataLoader</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            train_set,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">batch_size</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.batch_size,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">shuffle</span><span class="mtk8">=</span><span class="mtk7">True</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">num_workers</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.num_workers,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          dev_loader </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">DataLoader</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            dev_set,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">batch_size</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.batch_size,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">shuffle</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">num_workers</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.num_workers,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># fetch model</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          model </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">RBERT</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.model_name)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          model.</span><span class="mtk3">to</span><span class="mtk1">(device)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># fetch loss function, optimizer, scheduler outside of torch library</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># https://github.com/clovaai/AdamP</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          optimizer </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">AdamP</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            model.</span><span class="mtk3">parameters</span><span class="mtk1">(),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">lr</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.learning_rate,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">betas</span><span class="mtk8">=</span><span class="mtk1">(</span><span class="mtk7">0.9</span><span class="mtk1">, </span><span class="mtk7">0.999</span><span class="mtk1">),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">weight_decay</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.weight_decay,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># optimizer = AdamW(model.parameters(), lr=CFG.learning_rate, betas=(0.9, 0.999), weight_decay=CFG.weight_decay) # AdamP is better</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># https://huggingface.co/transformers/main_classes/optimizer_schedules.html</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          scheduler </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">get_cosine_schedule_with_warmup</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            optimizer,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">num_warmup_steps</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.warmup_steps,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk4 mtki">num_training_steps</span><span class="mtk8">=len</span><span class="mtk1">(train_loader) </span><span class="mtk8">*</span><span class="mtk1"> </span><span class="mtk7">CFG</span><span class="mtk1">.num_epochs,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          best_eval_loss </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">1.0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          steps </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk5 mtki"># fetch training loop</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">          </span><span class="mtk10 mtki">for</span><span class="mtk1"> epoch </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk3">tqdm</span><span class="mtk1">(</span><span class="mtk8">range</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">.num_epochs)):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            train_loss </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">Metrics</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            dev_loss </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">Metrics</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk10 mtki">for</span><span class="mtk1"> _, batch </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk8">enumerate</span><span class="mtk1">(train_loader):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              optimizer.</span><span class="mtk3">zero_grad</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># print(item)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># assign forward() arguments to the device</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              label </span><span class="mtk8">=</span><span class="mtk1"> batch[</span><span class="mtk7">4</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              inputs </span><span class="mtk8">=</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">: batch[</span><span class="mtk7">0</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk6">&quot;attention_mask&quot;</span><span class="mtk1">: batch[</span><span class="mtk7">1</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk6">&quot;subject_mask&quot;</span><span class="mtk1">: batch[</span><span class="mtk7">2</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk5 mtki"># &#39;token_type_ids&#39; # NOT FOR ROBERTA!</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk6">&quot;object_mask&quot;</span><span class="mtk1">: batch[</span><span class="mtk7">3</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">: label,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># model to training mode</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              model.</span><span class="mtk3">train</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              pred_logits </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">model</span><span class="mtk1">(**inputs)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              loss </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">criterion</span><span class="mtk1">(pred_logits, label)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># backward</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              loss.</span><span class="mtk3">backward</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              optimizer.</span><span class="mtk3">step</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              scheduler.</span><span class="mtk3">step</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># update metrics</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              train_loss.</span><span class="mtk3">update</span><span class="mtk1">(loss.</span><span class="mtk3">item</span><span class="mtk1">(), </span><span class="mtk8">len</span><span class="mtk1">(label))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              steps </span><span class="mtk8">+=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk5 mtki"># for every 100 steps</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">              </span><span class="mtk10 mtki">if</span><span class="mtk1"> steps </span><span class="mtk8">%</span><span class="mtk1"> </span><span class="mtk7">100</span><span class="mtk1"> </span><span class="mtk8">==</span><span class="mtk1"> </span><span class="mtk7">0</span><span class="mtk1">:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk8">print</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk6">&quot;Epoch: </span><span class="mtk7">{}</span><span class="mtk6">/</span><span class="mtk7">{}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(epoch </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">1</span><span class="mtk1">, </span><span class="mtk7">CFG</span><span class="mtk1">.num_epochs),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk6">&quot;Step: </span><span class="mtk7">{}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(steps),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk6">&quot;Train Loss: </span><span class="mtk7">{</span><span class="mtk10">:.4f</span><span class="mtk7">}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(train_loss.avg),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                </span><span class="mtk10 mtki">for</span><span class="mtk1"> dev_batch </span><span class="mtk10">in</span><span class="mtk1"> dev_loader:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  dev_label </span><span class="mtk8">=</span><span class="mtk1"> dev_batch[</span><span class="mtk7">4</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  dev_inputs </span><span class="mtk8">=</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">: dev_batch[</span><span class="mtk7">0</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;attention_mask&quot;</span><span class="mtk1">: dev_batch[</span><span class="mtk7">1</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;subject_mask&quot;</span><span class="mtk1">: dev_batch[</span><span class="mtk7">2</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk5 mtki"># &#39;token_type_ids&#39; # NOT FOR ROBERTA!</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;object_mask&quot;</span><span class="mtk1">: dev_batch[</span><span class="mtk7">3</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;label&quot;</span><span class="mtk1">: dev_label,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk5 mtki"># switch model to eval mode</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  model.</span><span class="mtk3">eval</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  dev_pred_logits </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">model</span><span class="mtk1">(**dev_inputs)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  loss </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">criterion</span><span class="mtk1">(dev_pred_logits, dev_label)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk5 mtki"># update metrics</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  dev_loss.</span><span class="mtk3">update</span><span class="mtk1">(loss.</span><span class="mtk3">item</span><span class="mtk1">(), </span><span class="mtk8">len</span><span class="mtk1">(dev_label))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk5 mtki"># print metrics</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk8">print</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;Epoch: </span><span class="mtk7">{}</span><span class="mtk6">/</span><span class="mtk7">{}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(epoch </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">1</span><span class="mtk1">, </span><span class="mtk7">CFG</span><span class="mtk1">.num_epochs),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;Step: </span><span class="mtk7">{}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(steps),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk6">&quot;Dev Loss: </span><span class="mtk7">{</span><span class="mtk10">:.4f</span><span class="mtk7">}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(dev_loss.avg),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                  </span><span class="mtk10 mtki">if</span><span class="mtk1"> best_eval_loss </span><span class="mtk8">&gt;</span><span class="mtk1"> dev_loss.avg:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    best_eval_loss </span><span class="mtk8">=</span><span class="mtk1"> dev_loss.avg</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    torch.</span><span class="mtk3">save</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      model.</span><span class="mtk3">state_dict</span><span class="mtk1">(),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      </span><span class="mtk6">&quot;./results/</span><span class="mtk7">{}</span><span class="mtk6">-fold-</span><span class="mtk7">{}</span><span class="mtk6">-best-eval-loss-model.pt&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        fold_num </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">1</span><span class="mtk1">, </span><span class="mtk7">CFG</span><span class="mtk1">.num_folds</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      ),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk8">print</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      </span><span class="mtk6">&quot;Saved model with lowest validation loss: </span><span class="mtk7">{</span><span class="mtk10">:.4f</span><span class="mtk7">}</span><span class="mtk6">&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        best_eval_loss</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    early_stop </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                    </span><span class="mtk10 mtki">else</span><span class="mtk1">:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      early_stop </span><span class="mtk8">+=</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                      </span><span class="mtk10 mtki">if</span><span class="mtk1"> early_stop </span><span class="mtk8">&gt;</span><span class="mtk1"> </span><span class="mtk7">2</span><span class="mtk1">:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        </span><span class="mtk10 mtki">break</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        </span><span class="mtk5 mtki"># Prevent OOM error</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        model.</span><span class="mtk3">cpu</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        </span><span class="mtk10 mtki">del</span><span class="mtk1"> model</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">                        torch.cuda.</span><span class="mtk3">empty_cache</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk6">&quot;#################### TRAIN IS OVER! ######################&quot;</span><span class="mtk1">)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="20"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">#################### Fold: 1 ######################</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 100 Train Loss: 2.6070 Train Acc: 0.2928</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 100 Dev Loss: 1.6841 Dev Acc: 0.4740</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 200 Train Loss: 1.1751 Train Acc: 0.6205</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 200 Dev Loss: 0.7841 Dev Acc: 0.7094</span></span>
<span class="grvsc-line"><span class="grvsc-source">Saved model with lowest validation loss: 0.7841</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 300 Train Loss: 0.7315 Train Acc: 0.7128</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 300 Dev Loss: 0.6191 Dev Acc: 0.7390</span></span>
<span class="grvsc-line"><span class="grvsc-source">Saved model with lowest validation loss: 0.6191</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 400 Train Loss: 0.6154 Train Acc: 0.7340</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 400 Dev Loss: 0.5609 Dev Acc: 0.7464</span></span>
<span class="grvsc-line"><span class="grvsc-source">Saved model with lowest validation loss: 0.5609</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 500 Train Loss: 0.5744 Train Acc: 0.7425</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 500 Dev Loss: 0.5403 Dev Acc: 0.7556</span></span>
<span class="grvsc-line"><span class="grvsc-source">Saved model with lowest validation loss: 0.5403</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 600 Train Loss: 0.5574 Train Acc: 0.7448</span></span>
<span class="grvsc-line"><span class="grvsc-source">Epoch: 1/5 Step: 600 Dev Loss: 0.4909 Dev Acc: 0.7582</span></span>
<span class="grvsc-line"><span class="grvsc-source">Saved model with lowest validation loss: 0.4909</span></span>
<span class="grvsc-line"><span class="grvsc-source">...</span></span>
<span class="grvsc-line"><span class="grvsc-source">100%|██████████| 5/5 [1:45:35&lt;00:00, 1267.16s/it]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">#################### Fold: 2 ######################</span></span>
<span class="grvsc-line"><span class="grvsc-source">...</span></span>
<span class="grvsc-line"><span class="grvsc-source">100%|██████████| 5/5 [1:44:46&lt;00:00, 1257.26s/it]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">#################### Fold: 3 ######################</span></span>
<span class="grvsc-line"><span class="grvsc-source">...</span></span>
<span class="grvsc-line"><span class="grvsc-source">100%|██████████| 5/5 [1:44:38&lt;00:00, 1255.74s/it]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">#################### Fold: 4 ######################</span></span>
<span class="grvsc-line"><span class="grvsc-source">...</span></span>
<span class="grvsc-line"><span class="grvsc-source">100%|██████████| 5/5 [1:46:05&lt;00:00, 1273.11s/it]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">#################### Fold: 5 ######################</span></span>
<span class="grvsc-line"><span class="grvsc-source">...</span></span>
<span class="grvsc-line"><span class="grvsc-source">100%|██████████| 5/5 [1:47:18&lt;00:00, 1287.77s/it]</span></span>
<span class="grvsc-line"><span class="grvsc-source">#################### TRAIN IS OVER! ######################</span></span></code></pre>
<p><a href="https://wandb.ai/snoop2head/KLUE-RE/runs/htwirbkj?workspace=user-snoop2head">📈 Train and evaluation logs are visualized in wandb</a></p>
<h2 id="inference-for-the-test-dataset" style="position:relative;"><a href="#inference-for-the-test-dataset" aria-label="inference for the test dataset permalink" class="toc-header before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inference for the Test Dataset</h2>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="21"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10">def</span><span class="mtk1"> </span><span class="mtk3">num_to_label</span><span class="mtk1">(</span><span class="mtk7 mtki">label</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk6">&quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">    숫자로 되어 있던 class를 원본 문자열 라벨로 변환 합니다.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">  &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  origin_label </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">with</span><span class="mtk1"> </span><span class="mtk8">open</span><span class="mtk1">(os.path.</span><span class="mtk3">join</span><span class="mtk1">(</span><span class="mtk7">BASELINE_DIR</span><span class="mtk1">, </span><span class="mtk6">&quot;dict_num_to_label.pkl&quot;</span><span class="mtk1">), </span><span class="mtk6">&#39;rb&#39;</span><span class="mtk1">) </span><span class="mtk10 mtki">as</span><span class="mtk1"> f:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    dict_num_to_label </span><span class="mtk8">=</span><span class="mtk1"> pickle.</span><span class="mtk3">load</span><span class="mtk1">(f)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">for</span><span class="mtk1"> v </span><span class="mtk10">in</span><span class="mtk1"> label:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    origin_label.</span><span class="mtk3">append</span><span class="mtk1">(dict_num_to_label[v])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">return</span><span class="mtk1"> origin_label</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="22"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> torch.utils.data </span><span class="mtk10 mtki">import</span><span class="mtk1"> DataLoader, Dataset, Subset</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">test_dataset </span><span class="mtk8">=</span><span class="mtk1"> pd.</span><span class="mtk3">read_csv</span><span class="mtk1">(</span><span class="mtk7">PORORO_TEST_PATH</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">display</span><span class="mtk1">(test_dataset.</span><span class="mtk3">head</span><span class="mtk1">(</span><span class="mtk7">2</span><span class="mtk1">))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># test_dataset = test_dataset.drop(test_dataset.columns[0], axis=1)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">test_dataset[</span><span class="mtk6">&#39;label&#39;</span><span class="mtk1">] </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk7">100</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(test_dataset))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">test_set </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">CustomDataset</span><span class="mtk1">(test_dataset, tokenizer, </span><span class="mtk4 mtki">is_training</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk8">print</span><span class="mtk1">(</span><span class="mtk8">len</span><span class="mtk1">(test_set))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">test_data_loader </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">DataLoader</span><span class="mtk1">(test_set, </span><span class="mtk4 mtki">batch_size</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.batch_size, </span><span class="mtk4 mtki">num_workers</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">.num_workers, </span><span class="mtk4 mtki">shuffle</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">)</span></span></span></code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre class="grvsc-container one-dark-pro" data-language="" data-index="23"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">.dataframe tbody tr th {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    vertical-align: top;</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">.dataframe thead th {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    text-align: right;</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>sentence</th>
      <th>label</th>
      <th>subject_entity</th>
      <th>object_entity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>지난 15일 [SUB-ORGANIZATION]MBC[/SUB-ORGANIZATION...</td>
      <td>100</td>
      <td>'[SUB-ORGANIZATION]MBC[/SUB-ORGANIZATION]'</td>
      <td>'[OBJ-O]탐사기획 스트레이트[/OBJ-O]'</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>사랑스러운 ‘[SUB-ARTIFACT]프린세스 프링[/SUB-ARTIFACT]’의 ...</td>
      <td>100</td>
      <td>'[SUB-ARTIFACT]프린세스 프링[/SUB-ARTIFACT]'</td>
      <td>'[OBJ-LOCATION]공주[/OBJ-LOCATION]'</td>
    </tr>
  </tbody>
</table>
</div>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="24"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">7765</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="25"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk6">&quot;&quot;&quot; check whether test dataset is correctly mapped &quot;&quot;&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">from</span><span class="mtk1"> tqdm </span><span class="mtk10 mtki">import</span><span class="mtk1"> tqdm</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">for</span><span class="mtk1"> i, data </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk8">enumerate</span><span class="mtk1">(</span><span class="mtk3">tqdm</span><span class="mtk1">(test_data_loader)) :</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk8">print</span><span class="mtk1">(data)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">break</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="26"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">  0%|          | 0/195 [00:00&lt;?, ?it/s]</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">{&#39;input_ids&#39;: tensor([[    0,    11, 32067,  ...,     1,     1,     1],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [    0,    11, 32001,  ...,     1,     1,     1],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [    0,    11, 32067,  ...,  4271,  2145,     2],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ...,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [    0,    11, 32067,  ...,     1,     1,     1],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [    0,    11, 32056,  ...,     1,     1,     1],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [    0,    11, 32006,  ...,     1,     1,     1]]), &#39;attention_mask&#39;: tensor([[1, 1, 1,  ..., 0, 0, 0],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [1, 1, 1,  ..., 0, 0, 0],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [1, 1, 1,  ..., 1, 1, 1],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ...,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [1, 1, 1,  ..., 0, 0, 0],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [1, 1, 1,  ..., 0, 0, 0],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [1, 1, 1,  ..., 0, 0, 0]]), &#39;subject_mask&#39;: tensor([[0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ...,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.]]), &#39;object_mask&#39;: tensor([[0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        ...,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>
<span class="grvsc-line"><span class="grvsc-source">        [0., 1., 1.,  ..., 0., 0., 0.]]), &#39;label&#39;: tensor([100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100])}</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">  0%|          | 0/195 [00:00&lt;?, ?it/s]</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="27"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">oof_pred </span><span class="mtk8">=</span><span class="mtk1"> []  </span><span class="mtk5 mtki"># out of fold prediction list</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk10 mtki">for</span><span class="mtk1"> i </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk8">range</span><span class="mtk1">(</span><span class="mtk7">5</span><span class="mtk1">):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  model_path </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk6">&quot;/opt/ml/klue-level2-nlp-15/notebooks/results/</span><span class="mtk7">{}</span><span class="mtk6">-fold-5-best-eval-loss-model.pt&quot;</span><span class="mtk1">.</span><span class="mtk3">format</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    i </span><span class="mtk8">+</span><span class="mtk1"> </span><span class="mtk7">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  model </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">RBERT</span><span class="mtk1">(</span><span class="mtk7">CFG</span><span class="mtk1">[</span><span class="mtk6">&quot;pretrained_model_name&quot;</span><span class="mtk1">], </span><span class="mtk4 mtki">dropout_rate</span><span class="mtk8">=</span><span class="mtk7">CFG</span><span class="mtk1">[</span><span class="mtk6">&quot;dropout_rate&quot;</span><span class="mtk1">])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  model.</span><span class="mtk3">load_state_dict</span><span class="mtk1">(torch.</span><span class="mtk3">load</span><span class="mtk1">(model_path))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  model.</span><span class="mtk3">to</span><span class="mtk1">(device)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  model.</span><span class="mtk3">eval</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  output_pred </span><span class="mtk8">=</span><span class="mtk1"> []</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">  </span><span class="mtk10 mtki">for</span><span class="mtk1"> i, data </span><span class="mtk10">in</span><span class="mtk1"> </span><span class="mtk8">enumerate</span><span class="mtk1">(</span><span class="mtk3">tqdm</span><span class="mtk1">(test_data_loader)):</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk10 mtki">with</span><span class="mtk1"> torch.</span><span class="mtk3">no_grad</span><span class="mtk1">():</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      outputs </span><span class="mtk8">=</span><span class="mtk1"> </span><span class="mtk3">model</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk4 mtki">input_ids</span><span class="mtk8">=</span><span class="mtk1">data[</span><span class="mtk6">&quot;input_ids&quot;</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk4 mtki">attention_mask</span><span class="mtk8">=</span><span class="mtk1">data[</span><span class="mtk6">&quot;attention_mask&quot;</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk4 mtki">subject_mask</span><span class="mtk8">=</span><span class="mtk1">data[</span><span class="mtk6">&quot;subject_mask&quot;</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk4 mtki">object_mask</span><span class="mtk8">=</span><span class="mtk1">data[</span><span class="mtk6">&quot;object_mask&quot;</span><span class="mtk1">].</span><span class="mtk3">to</span><span class="mtk1">(device),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk5 mtki"># token_type_ids=data[&#39;token_type_ids&#39;].to(device) # RoBERTa does not use token_type_ids.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      )</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      output_pred.</span><span class="mtk3">extend</span><span class="mtk1">(outputs.</span><span class="mtk3">cpu</span><span class="mtk1">().</span><span class="mtk3">detach</span><span class="mtk1">().</span><span class="mtk3">numpy</span><span class="mtk1">())</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      output_pred </span><span class="mtk8">=</span><span class="mtk1"> F.</span><span class="mtk3">softmax</span><span class="mtk1">(torch.</span><span class="mtk3">Tensor</span><span class="mtk1">(output_pred), </span><span class="mtk4 mtki">dim</span><span class="mtk8">=</span><span class="mtk7">1</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      oof_pred.</span><span class="mtk3">append</span><span class="mtk1">(np.</span><span class="mtk3">array</span><span class="mtk1">(output_pred)[:, np.newaxis])</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      </span><span class="mtk5 mtki"># Prevent OOM error</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      model.</span><span class="mtk3">cpu</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      </span><span class="mtk10 mtki">del</span><span class="mtk1"> model</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">      torch.cuda.</span><span class="mtk3">empty_cache</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">models_prob </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">mean</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        np.</span><span class="mtk3">concatenate</span><span class="mtk1">(oof_pred, </span><span class="mtk4 mtki">axis</span><span class="mtk8">=</span><span class="mtk7">2</span><span class="mtk1">), </span><span class="mtk4 mtki">axis</span><span class="mtk8">=</span><span class="mtk7">2</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    )  </span><span class="mtk5 mtki"># probability of each class</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">result </span><span class="mtk8">=</span><span class="mtk1"> np.</span><span class="mtk3">argmax</span><span class="mtk1">(models_prob, </span><span class="mtk4 mtki">axis</span><span class="mtk8">=-</span><span class="mtk7">1</span><span class="mtk1">)  </span><span class="mtk5 mtki"># label</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># print(result, type(result))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># print(models_prob.shape, list_prob)</span></span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="" data-index="28"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">[ 3 12  0 ...  1  0  0] &lt;class &#39;numpy.ndarray&#39;&gt;</span></span></code></pre>
<pre class="grvsc-container one-dark-pro" data-language="python" data-index="29"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk5 mtki"># save for submission</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">list_prob </span><span class="mtk8">=</span><span class="mtk1"> models_prob.</span><span class="mtk3">tolist</span><span class="mtk1">()</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">test_id </span><span class="mtk8">=</span><span class="mtk1"> test_dataset[</span><span class="mtk6">&#39;id&#39;</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_submission </span><span class="mtk8">=</span><span class="mtk1"> pd.</span><span class="mtk3">DataFrame</span><span class="mtk1">({</span><span class="mtk6">&#39;id&#39;</span><span class="mtk1">:test_id,</span><span class="mtk6">&#39;pred_label&#39;</span><span class="mtk1">:</span><span class="mtk3">num_to_label</span><span class="mtk1">(result),</span><span class="mtk6">&#39;probs&#39;</span><span class="mtk1">:list_prob,})</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">df_submission.</span><span class="mtk3">to_csv</span><span class="mtk1">(</span><span class="mtk6">&#39;./prediction/submission_RBERT.csv&#39;</span><span class="mtk1">, </span><span class="mtk4 mtki">index</span><span class="mtk8">=</span><span class="mtk7">False</span><span class="mtk1">)</span></span></span></code></pre>
<pre><code class="language-python"></code></pre>
<style class="grvsc-styles">
  .grvsc-container {
    overflow: auto;
    position: relative;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius, 8px);
    font-feature-settings: normal;
    line-height: 1.4;
  }
  
  .grvsc-code {
    display: table;
  }
  
  .grvsc-line {
    display: table-row;
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }
  
  .grvsc-line > * {
    position: relative;
  }
  
  .grvsc-gutter-pad {
    display: table-cell;
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  .grvsc-gutter {
    display: table-cell;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter::before {
    content: attr(data-content);
  }
  
  .grvsc-source {
    display: table-cell;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));
  }
  
  .grvsc-source:empty::after {
    content: ' ';
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter + .grvsc-source {
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  /* Line transformer styles */
  
  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {
    content: ' ';
    position: absolute;
    width: 100%;
  }
  
  .grvsc-line-diff-add::before {
    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));
  }
  
  .grvsc-line-diff-del::before {
    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));
  }
  
  .grvsc-line-number {
    padding: 0 2px;
    text-align: right;
    opacity: 0.7;
  }
  
  .one-dark-pro {
    background-color: #282c34;
    color: #abb2bf;
  }
  .one-dark-pro .mtki { font-style: italic; }
  .one-dark-pro .mtk6 { color: #98C379; }
  .one-dark-pro .mtk10 { color: #C678DD; }
  .one-dark-pro .mtk1 { color: #ABB2BF; }
  .one-dark-pro .mtk8 { color: #56B6C2; }
  .one-dark-pro .mtk5 { color: #7F848E; }
  .one-dark-pro .mtk7 { color: #D19A66; }
  .one-dark-pro .mtk3 { color: #61AFEF; }
  .one-dark-pro .mtk4 { color: #E06C75; }
  .one-dark-pro .mtk11 { color: #E5C07B; }
  .one-dark-pro .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));
  }
</style></div></div></div></div><div class="css-1bdwg0l eyldt480"><div><style data-emotion-css="17t5ffy">.css-17t5ffy{margin-top:1rem;margin-bottom:1rem;}</style><div class="css-17t5ffy"><div class="css-1l4w6pd"><div class="css-yapsbb"></div></div></div><style data-emotion-css="i1cgbm">.css-i1cgbm{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;margin-top:1rem;padding-left:0.5rem;padding-right:0.5rem;}</style><div class="css-i1cgbm"><style data-emotion-css="9nr5sz">.css-9nr5sz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-left:0.75rem;padding-right:0.75rem;padding-top:0.25rem;padding-bottom:0.25rem;margin-top:0.5rem;margin-bottom:0.5rem;margin-left:0.5rem;border-radius:0.25rem;--text-opacity:1;color:rgba(255,255,255,var(--text-opacity));background-color:#1CA1F2;}</style><button class="css-9nr5sz"><style data-emotion-css="u7tj59">.css-u7tj59{fill:currentColor;margin-top:auto;margin-bottom:auto;margin-right:0.25rem;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="css-u7tj59" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>Share with <!-- -->Twitter</button><style data-emotion-css="rk0yc0">.css-rk0yc0{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-left:0.75rem;padding-right:0.75rem;padding-top:0.25rem;padding-bottom:0.25rem;margin-top:0.5rem;margin-bottom:0.5rem;margin-left:0.5rem;border-radius:0.25rem;--text-opacity:1;color:rgba(255,255,255,var(--text-opacity));background-color:#6E7783;}</style><button class="css-rk0yc0"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="css-u7tj59" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg>Share with <!-- -->URL</button></div></div></div></div></div><div class="css-1bdwg0l eyldt480"><style data-emotion-css="17t1oy1">.css-17t1oy1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap-reverse;-ms-flex-wrap:wrap-reverse;flex-wrap:wrap-reverse;margin-left:0.5rem;margin-right:0.5rem;margin-top:1rem;}@media (min-width:768px){.css-17t1oy1{-webkit-flex-wrap:nowrap;-ms-flex-wrap:nowrap;flex-wrap:nowrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}}</style><div class="css-17t1oy1 e816y8n0"><style data-emotion-css="1pwr1ry">.css-1pwr1ry{width:100%;margin:0.5rem;}@media (min-width:768px){.css-1pwr1ry{width:50%;margin:1rem;}}</style><div class="css-1pwr1ry e816y8n1"><style data-emotion-css="vl2eok">.css-vl2eok{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);text-align:left;width:100%;height:100%;padding:0.5rem;background-color:#eee;border-radius:0.25rem;border-left-width:4px;border-color:#86a8e7;}.css-vl2eok:hover{background-color:#ddd;}</style><a rel="prev" class="css-vl2eok" href="/DL&amp;ML/Relation-Extraction/"><style data-emotion-css="19o7xeo">.css-19o7xeo{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-content:center;-ms-flex-line-pack:center;align-content:center;margin-right:1rem;margin-left:0.5rem;height:100%;}</style><div class="css-19o7xeo"><style data-emotion-css="11za1ik">.css-11za1ik{width:2rem;height:2rem;margin-top:auto;margin-bottom:auto;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="css-11za1ik" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M872 474H286.9l350.2-304c5.6-4.9 2.2-14-5.2-14h-88.5c-3.9 0-7.6 1.4-10.5 3.9L155 487.8a31.96 31.96 0 0 0 0 48.3L535.1 866c1.5 1.3 3.3 2 5.2 2h91.5c7.4 0 10.8-9.2 5.2-14L286.9 550H872c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></div><style data-emotion-css="v38or">.css-v38or{display:inline-block;margin-top:0.5rem;margin-bottom:0.5rem;}</style><div class="css-v38or"><style data-emotion-css="2m7hin">.css-2m7hin{color:#3737B9;}</style><p class="css-2m7hin">Previous Post</p><p>KLUE Relation Extraction: Subject Entity and Object Entity</p></div></a></div><div class="css-1pwr1ry e816y8n1"><style data-emotion-css="xhvfnc">.css-xhvfnc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);text-align:right;width:100%;height:100%;padding:0.5rem;background-color:#eee;border-radius:0.25rem;border-right-width:4px;border-color:#86a8e7;}.css-xhvfnc:hover{background-color:#ddd;}</style><a rel="next" class="css-xhvfnc" href="/Configs/VSCode-ssh/"><div class="css-v38or"><p class="css-2m7hin">Next Post</p><p>Configuration for VSCode and ZSH in Remote Server</p></div><div class="css-19o7xeo"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="css-11za1ik" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M869 487.8L491.2 159.9c-2.9-2.5-6.6-3.9-10.5-3.9h-88.5c-7.4 0-10.8 9.2-5.2 14l350.2 304H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h585.1L386.9 854c-5.6 4.9-2.2 14 5.2 14h91.5c1.9 0 3.8-.7 5.2-2L869 536.2a32.07 32.07 0 0 0 0-48.4z"></path></svg></div></a></div></div><style data-emotion-css="14yohw7">.css-14yohw7{width:100%;max-width:768px;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto;padding-top:2rem;margin-top:0.5rem;margin-bottom:1rem;}@media (min-width:768px){.css-14yohw7{padding-left:0;padding-right:0;padding-top:3rem;}}</style><div class="css-14yohw7 e16bs3iv0"><style data-emotion-css="180ky7f">.css-180ky7f{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:0.5rem;padding-right:0.5rem;}@media (min-width:768px){.css-180ky7f{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="css-180ky7f e16bs3iv1"><style data-emotion-css="p5b1u1">.css-p5b1u1{border-radius:9999px;border-width:1px;--border-opacity:1;border-color:rgba(214,188,250,var(--border-opacity));margin-right:2rem;margin-bottom:0.5rem;}@media (min-width:768px){.css-p5b1u1{margin-bottom:1rem;}}</style><div class="css-p5b1u1 gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:128px;height:128px"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQBBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAABynZIqtSk4c5qdwD/AP/EABgQAAMBAQAAAAAAAAAAAAAAAAABAgMR/9oACAEBAAEFApTIkuNHXZgjWK2bZvTM6b1P/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPwFiK//EABURAQEAAAAAAAAAAAAAAAAAAAEg/9oACAECAQE/ASP/xAAdEAACAQQDAAAAAAAAAAAAAAAAASECEBFRIjGB/9oACAEBAAY/AvCZ2QoMsw5TOJ2Up7t//8QAHRAAAgICAwEAAAAAAAAAAAAAAAERIUFhMVFxkf/aAAgBAQABPyGQ1UIIVo1dtoaHoXgWF10MklGMEvhCEYta+DAJgvw//9oADAMBAAIAAwAAABBYODz/xAAYEQEBAQEBAAAAAAAAAAAAAAABABEhQf/aAAgBAwEBPxB279ksrt//xAAXEQEBAQEAAAAAAAAAAAAAAAABABAx/9oACAECAQE/EI9kM//EAB4QAQEAAgICAwAAAAAAAAAAAAERACFRYTFBoeHw/9oACAEBAAE/ENiSENW+VTiZpVWrCLvvKMeEnTGARaXZevjBBRTTtdPnjWuccCRSa1+JjqKA/TCoCwoW324ixDPbn//Z" alt="profileImg" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/584d7a912ca03da16698aea724815677/6dc0c/profile.jpg 1x,
/static/584d7a912ca03da16698aea724815677/cc017/profile.jpg 1.5x,
/static/584d7a912ca03da16698aea724815677/0c30b/profile.jpg 2x" /><img loading="lazy" width="128" height="128" srcset="/static/584d7a912ca03da16698aea724815677/6dc0c/profile.jpg 1x,
/static/584d7a912ca03da16698aea724815677/cc017/profile.jpg 1.5x,
/static/584d7a912ca03da16698aea724815677/0c30b/profile.jpg 2x" src="/static/584d7a912ca03da16698aea724815677/6dc0c/profile.jpg" alt="profileImg" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div><span>Written by </span><style data-emotion-css="1t4jyca">.css-1t4jyca{display:inline-block;font-size:1.25rem;font-weight:700;border-radius:9999px;margin-bottom:0.5rem;padding-left:0.75rem;padding-right:0.75rem;--bg-opacity:1;background-color:rgba(237,242,247,var(--bg-opacity));color:#3737B9;}</style><p class="css-1t4jyca">@<!-- -->Young Jin Ahn</p><style data-emotion-css="vg2p6i">.css-vg2p6i{font-size:0.875rem;font-weight:400;margin-bottom:0.5rem;}</style><div class="css-vg2p6i">break, compose, display</div></div></div><style data-emotion-css="1air669">.css-1air669{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-left:0.5rem;margin-right:0.5rem;}</style><div class="css-1air669"><div class="css-yapsbb"></div></div><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><a title="github Link" href="https://github.com/snoop2head" class="css-1baulvz"><style data-emotion-css="vnd1fq">.css-vnd1fq{width:2rem;height:2rem;margin-top:1rem;margin-left:1rem;-webkit-transition:all 300ms cubic-bezier(0,0,0.2,1);transition:all 300ms cubic-bezier(0,0,0.2,1);color:#888;}.css-vnd1fq:hover{color:#000;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="css-vnd1fq" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="facebook Link" href="https://www.facebook.com/profile.php?id=100009133042568" class="css-1baulvz"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="css-vnd1fq" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg></a></div><style data-emotion-css="18jj1tc">.css-18jj1tc{margin-top:1.25rem;margin-left:0.5rem;margin-right:0.5rem;}</style><div class="css-18jj1tc"><div class="utterances"></div></div></div></div><style data-emotion-css="xgi74q">.css-xgi74q{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;position:fixed;bottom:0;right:0;padding-right:1.5rem;padding-bottom:1.5rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style><div class="css-xgi74q e8huvi00"><style data-emotion-css="1a68u">.css-1a68u{box-shadow:0 2px 2px 0 rgba(0,0,0,0.15);-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);background-color:#FFFFFF;color:#636363;font-size:0.75rem;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:9999px;--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;-webkit-transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));-ms-transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-content:flex-end;-ms-flex-line-pack:end;align-content:flex-end;z-index:100;}.css-1a68u:hover{background-color:#404040;color:#FFFFFF;}.css-1a68u:hover{--transform-scale-x:1.05;--transform-scale-y:1.05;}</style><button title="change to darkmode" class="css-1a68u"><style data-emotion-css="1alqh2e">.css-1alqh2e{fill:currentColor;--text-opacity:1;color:rgba(246,224,94,var(--text-opacity));width:1rem;height:1rem;margin-top:auto;margin-bottom:auto;margin-left:0;margin-right:0;}@media (min-width:768px){.css-1alqh2e{display:inline-block;margin-left:0.25rem;margin-right:0.25rem;}}</style><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="css-1alqh2e" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg><style data-emotion-css="flxr9x">.css-flxr9x{display:none;margin-right:0;}@media (min-width:768px){.css-flxr9x{display:inline-block;margin-right:0.25rem;}}</style><span class="css-flxr9x">Use Dark Mode</span></button><style data-emotion-css="15afv4q">.css-15afv4q{box-shadow:0 2px 2px 0 rgba(0,0,0,0.15);-webkit-transition:all 300ms cubic-bezier(0.4,0,0.2,1);transition:all 300ms cubic-bezier(0.4,0,0.2,1);background-color:#FFFFFF;color:#636363;font-size:0.75rem;padding-left:0.5rem;padding-right:0.5rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:9999px;--transform-translate-x:0;--transform-translate-y:0;--transform-rotate:0;--transform-skew-x:0;--transform-skew-y:0;--transform-scale-x:1;--transform-scale-y:1;-webkit-transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));-ms-transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));transform:translateX(var(--transform-translate-x)) translateY(var(--transform-translate-y)) rotate(var(--transform-rotate)) skewX(var(--transform-skew-x)) skewY(var(--transform-skew-y)) scaleX(var(--transform-scale-x)) scaleY(var(--transform-scale-y));cursor:pointer;margin-left:0.5rem;margin-top:auto;margin-bottom:auto;z-index:100;}.css-15afv4q:hover{background-color:#404040;color:#FFFFFF;}.css-15afv4q:hover{--transform-scale-x:1.05;--transform-scale-y:1.05;}</style><button title="top page" class="css-15afv4q"><style data-emotion-css="13htjwu">.css-13htjwu{width:1rem;height:1rem;}</style><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="css-13htjwu" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M868 545.5L536.1 163a31.96 31.96 0 0 0-48.3 0L156 545.5a7.97 7.97 0 0 0 6 13.2h81c4.6 0 9-2 12.1-5.5L474 300.9V864c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V300.9l218.9 252.3c3 3.5 7.4 5.5 12.1 5.5h81c6.8 0 10.5-8 6-13.2z"></path></svg></button></div><style data-emotion-css="1k8xcyw">.css-1k8xcyw{text-align:center;padding-top:2rem;padding-bottom:2rem;bottom:0;}</style><footer class="css-1k8xcyw"><style data-emotion-css="1xju3od">.css-1xju3od{font-size:0.75rem;font-weight:700;}</style><a href="https://github.com/snoop2head" class="css-1xju3od">©snoop2head</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-186254784-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/DL&ML/Relation-Extraction-Code/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-2f72579fb641bf14a0fa.js"],"app":["/app-97235b1800926a9fde68.js"],"component---src-pages-404-js":["/component---src-pages-404-js-52653b52ec9c7b389244.js"],"component---src-pages-index-js":["/component---src-pages-index-js-fbb692f58f9fda19439c.js"],"component---src-pages-search-js":["/component---src-pages-search-js-b32d7426c8be7684ef3e.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2baa1e84574778159db5.js"],"component---src-templates-category-js":["/component---src-templates-category-js-0c15cae52c52c0f57585.js"]};/*]]>*/</script><script src="/polyfill-2f72579fb641bf14a0fa.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-2baa1e84574778159db5.js" async=""></script><script src="/7a297f752dcfe258c0b0106d89edb3a916af916e-39861a37ba6e027ab9fb.js" async=""></script><script src="/commons-605bc03228d7488be604.js" async=""></script><script src="/1bfc9850-b75b1f0cbf7150b5a94a.js" async=""></script><script src="/5e2a4920-da90abce4a08c86a094c.js" async=""></script><script src="/d7eeaac4-dcbe97e7a5aa158c9d08.js" async=""></script><script src="/app-97235b1800926a9fde68.js" async=""></script><script src="/dc6a8720040df98778fe970bf6c000a41750d3ae-17eb047fb821ccbad0b0.js" async=""></script><script src="/styles-84a9bc99193fe5828ffe.js" async=""></script><script src="/framework-eb684e3e828ad13b3940.js" async=""></script><script src="/webpack-runtime-b241e174f085821f3cec.js" async=""></script></body></html>