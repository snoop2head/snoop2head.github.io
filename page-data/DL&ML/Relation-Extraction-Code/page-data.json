{"componentChunkName":"component---src-templates-blog-post-js","path":"/DL&ML/Relation-Extraction-Code/","result":{"data":{"site":{"siteMetadata":{"author":"Young Jin Ahn","comment":{"utterances":"snoop2head/snoop2head.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"excerpt":"Model Performance and log on weights and biases(wandb) ðŸ“ˆ Train and evaluation logs are visualized in this wandb link   Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5â€¦","html":"<h2 id=\"model-performance-and-log-on-weights-and-biaseswandb\" style=\"position:relative;\"><a href=\"#model-performance-and-log-on-weights-and-biaseswandb\" aria-label=\"model performance and log on weights and biaseswandb permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model Performance and log on <code>weights and biases(wandb)</code></h2>\n<p><a href=\"https://wandb.ai/snoop2head/KLUE-RE/runs/htwirbkj?workspace=user-snoop2head\">ðŸ“ˆ Train and evaluation logs are visualized in this wandb link</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAACfklEQVQ4y3VUWbLbMAzLLRJttmVZXuK8l057/7OxILQ4bzr94GijQFIEdBvnJHPO4oZRbBhoxoc+b/Z53nyan2s+sJtOHtbR7sZKwMW8bWK97/vGeV544JxrAC3rKimvBLnTz3O/A94roA2jDHEGSJBHmOio5y4EZDmJW57i80vi+Vvi8ZawfXHt0pOBb6UElKPO4yxu3sQMGKcF8xX7UQwArZY3JrHc38XCTESG6WAQg+DGuQJoPEABZmPmIS+pM8AVUDMsgXGJwSN9eIfzTIyeoanRCbKcGDPBmMmgZdsCqG+pvl7Hoc5rA7VJCtg6pCVYgFm8hUUZdnkR3GhprlzSC/+z1rxbcxzmLOOywzYZ09rHeXuyGZqBBh+m+I+NaOLERramwHmcJomzHkSOZT5LBke1VH0WD9+JZ0liSpiXcU6LpCWTEbdG2ELUobxNewZ/kfynX7jer67V1Oc2KTpIqtzzo1Jn4oGOvhr597HX19UuPwCWxdi7pKPHgalrU8v9bIq+pfr4ocit7dsuvd4pjwdOsj+fjPhwoXewsUF5GPMmx+ubtmx7IX+jTVOKG6P4uIhPOxXjwUUPpei+KsA26SmlwFdSTEfQinwFj1VRl1Iq+3mBEsu8YKhnd5WpWk6bhBUaBvlDPrE+KIYOyAyp0U08HKkUZEpHZGua9DQwM8xXplQXtKwZfkpPATWiR0T9FDgnYOwZts+Dz1KlSV8Fx32tlNJjOQR7VTuvedr5hs3PTamcA6SUX0b9BwjYRD+vh+TzLcvzW7La+Yvz4/1H/FRk5fAppHWX5fiCvWBn9f+S7fWm5rv09AdxWjo1W63OG8eaMi6f4fKtT/cX5hAeTcDY8mgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screen Shot 2021-10-08 at 9.08.50 AM\"\n        title=\"Screen Shot 2021-10-08 at 9.08.50 AM\"\n        src=\"/static/389718d5896d837fed4ea0b06015c2ad/c1b63/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png\"\n        srcset=\"/static/389718d5896d837fed4ea0b06015c2ad/5a46d/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 300w,\n/static/389718d5896d837fed4ea0b06015c2ad/0a47e/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 600w,\n/static/389718d5896d837fed4ea0b06015c2ad/c1b63/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 1200w,\n/static/389718d5896d837fed4ea0b06015c2ad/d61c2/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 1800w,\n/static/389718d5896d837fed4ea0b06015c2ad/922e6/Screen%20Shot%202021-10-08%20at%209.08.50%20AM.png 2140w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWElEQVQoz31SSZLEMAjLM9r7njjp6v8/jxFy0jWHqTkQMAiZIG+pNjnOU9S7mMSG+DU9/2d/YTaPj5r1QYzzjEPK9Ho21sEHNr/0DHsxp9h4x+6b2wg0FollrQ8Zx5TaOghwSSisc5oQ2GxillB36ccpFrGNBfUMbJbNEZjuApIomjxgXVzZxfWLhIqLmFyJPXJ+fMQCx7if4tsEYVqEloRFXJ0kIJHGAGnTyxgShXtvi/Atvh4rBk57jI/PhLAy1k0KbOeKCT4IXIQqQll1Ek6SeQ4xuOvNcfmO49pUv/ugf9agZ+xPRXC5kSTsHxDuIHuvCREbaADCSIVVpUeY3/GjIAl1h3opV/MWi9+0+G2HiR12ri+CKmtTKlXaGFJ7p9KqssbHnBRDn4xia4e684LC1+1P+nldHGyJgkB/PZYiIWeSx1xoCTn3PHYf+D4jMHrJg+EZXus/TD8PRlN3dxMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20211008090942237\"\n        title=\"image-20211008090942237\"\n        src=\"/static/13edf247729d58d03b24b33312f5acb6/c1b63/image-20211008090942237.png\"\n        srcset=\"/static/13edf247729d58d03b24b33312f5acb6/5a46d/image-20211008090942237.png 300w,\n/static/13edf247729d58d03b24b33312f5acb6/0a47e/image-20211008090942237.png 600w,\n/static/13edf247729d58d03b24b33312f5acb6/c1b63/image-20211008090942237.png 1200w,\n/static/13edf247729d58d03b24b33312f5acb6/d61c2/image-20211008090942237.png 1800w,\n/static/13edf247729d58d03b24b33312f5acb6/de9fe/image-20211008090942237.png 2146w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Evaluation loss is constantly lowered as steps progresses, until 4000 steps(or 5 epochs). This was different from concat baseline model where its' evaluation loss sparks around 2000 steps(or 3 epochs). We concluded that providing more information of <code>[CLS]</code>, subject entity, object entity's hidden features enabled models to find deeper local minimum.</p>\n<h2 id=\"rbert-explanation\" style=\"position:relative;\"><a href=\"#rbert-explanation\" aria-label=\"rbert explanation permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RBERT explanation</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACQUlEQVQoz22S/U/acBDG+f//g+3X/bQtbskS52aWKEanm4IiBlARaIv0jb7T0pa2n51VYIle0t63T++eu+8910Csqip5Pfunp5TzqoRsVbFYrkiykjSviNMCJ0yJBVsVpcSV5MWKDYdYY31Y+yeLFzkz/Y6j8x16wwPiOKJzdM7eh120/ohQCuR5iea4/Lzp1DlFWdYcjaeP8oXMjHx2u232r1sMBn0+7f3m+lbBtgyOTi/Y+dXGDyJJroSwQnEcvl61+N8a6+48z6N/f8vO4QmtkUYlFR80SzpU8eVfGMUMVZPxRGURRfVYHucGnfEZaQaOHxIny+2VSyEo8hzX8VkmKUVRYNoOrgRKxdo7rs/cDV5GBJarM9KOpVv4uN+me6dtO1wTjx9t5v6CXFS57CvcK2aNq7pbdzjU7M317LnJaHAqolUct/qMNfO1KFPDRjcsPN+nOxgxnDyKSAsmms7DRGOszraEUvz8x1l9XoQhWZY+E1ZVuSGc2xau64qyMVHg0+te1dhCSJMkRtdnpGlax0aOx+XhXwrZuTzLt6I8tyhzFOfEqahqEwQhYZ5x8GdA/2EqOxnX2Ey3WK03TBLiMKrxSISqCYPIY2qqeGlCOlIJ7vqIJIShQ9a5pNnuMVAs1J6BGzhClqJNdIYDDS/x8KKQZRZvxtZQZg90ZLBm6pE1T1C/fcZYBmjKAOvde2bTG9m9gOaXG8bTIX5ic9aUQt8vMAIF0zFERGNLyBtmmaaoXLzCl7Jn87nzVspGg38DYY4iv+/zZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20211008224657844\"\n        title=\"image-20211008224657844\"\n        src=\"/static/55ce894326815cec56f7c0f1037120b6/c1b63/image-20211008224657844.png\"\n        srcset=\"/static/55ce894326815cec56f7c0f1037120b6/5a46d/image-20211008224657844.png 300w,\n/static/55ce894326815cec56f7c0f1037120b6/0a47e/image-20211008224657844.png 600w,\n/static/55ce894326815cec56f7c0f1037120b6/c1b63/image-20211008224657844.png 1200w,\n/static/55ce894326815cec56f7c0f1037120b6/5ba90/image-20211008224657844.png 1604w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>RBERT extracts hidden features wrapped around the entity markers commences average pooling. <strong>Key is to concatenate 1) [CLS], 2) Subject entity tokensâ€™ hidden features' average, 3) Object entity tokensâ€™ hidden features' average.</strong> Furthermore, in this competition, I customized to include entity wrappers around target entities and pooled those tokens also. This was to include more contextual information which divided target entities and other tokens. This is different from the original proposal at <a href=\"https://arxiv.org/pdf/1905.08284v1.pdf\">Enriching Pre-trained Language Model with Entity Information for Relation Classification, Wu et al. 2019</a>.</p>\n<h2 id=\"config\" style=\"position:relative;\"><a href=\"#config\" aria-label=\"config permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Config</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; define train data and test data path &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> os</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> glob </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> glob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">os.environ[</span><span class=\"mtk6\">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;false&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">os.environ[</span><span class=\"mtk6\">&quot;CUDA_LAUNCH_BLOCKING&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># root path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">abspath</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;.&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk5 mtki\"># this makes compatible absolute path both for local and server</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># directory paths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;dataset&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">TRAIN_DATA_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;train&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">TEST_DATA_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;test&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PRIDICTION_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;prediction&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">BASELINE_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;baseline-code&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># files paths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">TRAIN_FILE_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TRAIN_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;*&#39;</span><span class=\"mtk1\">))[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">TEST_FILE_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TEST_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;*&#39;</span><span class=\"mtk1\">))[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">SAMPLE_SUBMISSION_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PRIDICTION_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;sample_submission.csv&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PORORO_TRAIN_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;train_pororo_sub.csv&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PORORO_TEST_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;test_pororo_sub.csv&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PORORO_SPECIAL_TOKEN_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_DATA_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;pororo_special_token.txt&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TRAIN_FILE_PATH</span><span class=\"mtk1\">, </span><span class=\"mtk7\">TEST_FILE_PATH</span><span class=\"mtk1\">,</span><span class=\"mtk7\">SAMPLE_SUBMISSION_PATH</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/opt/ml/klue-level2-nlp-15/dataset/train/train.csv /opt/ml/klue-level2-nlp-15/dataset/test/test_data.csv /opt/ml/klue-level2-nlp-15/prediction/sample_submission.csv</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; Set configuration as dictionary format &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> wandb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> datetime </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> datetime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> easydict </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> EasyDict</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># login wandb and get today&#39;s date until hour and minute</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">wandb.</span><span class=\"mtk3\">login</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">today </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> datetime.</span><span class=\"mtk3\">now</span><span class=\"mtk1\">().</span><span class=\"mtk3\">strftime</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;%m</span><span class=\"mtk7\">%d</span><span class=\"mtk6\">_%H:%M&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Debug set to true in order to debug high-layer code.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># CFG Configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> wandb.config </span><span class=\"mtk5 mtki\"># wandb.config provides functionality of easydict.EasyDict</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.</span><span class=\"mtk7\">DEBUG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Dataset Config as constants</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_labels </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">30</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_workers </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.batch_size </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">40</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Train configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.user_name </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;snoop2head&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.file_base_name </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{CFG</span><span class=\"mtk1\">.user_name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">_</span><span class=\"mtk7\">{</span><span class=\"mtk1\">today</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.model_name </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;klue/roberta-large&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_folds </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># 5 Fold as default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_epochs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># loss is increasing after 5 epochs for xlm-roberta-large and 3 epochs for klue/roberta-large</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.max_token_length </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">128</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">4</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># refer to EDA where Q3 is 119, there are only 460 sentences out of 32k train set</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.stopwords </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.learning_rate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">5e-5</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.weight_decay </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1e-2</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># https://paperswithcode.com/method/weight-decay</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.input_size </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">768</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># 768 for klue/roberta-large, 1024 for klue/roberta-large</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.output_size </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">768</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># 768 for klue/roberta-large, 1024 for klue/roberta-large</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_rnn_layers </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.dropout_rate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># training steps configurations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.save_steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.early_stopping_patience </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">5</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.warmup_steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.logging_steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.evaluation_strategy </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;epoch&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.evaluation_steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">500</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Directory configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.result_dir </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&quot;results&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.saved_model_dir </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&quot;best_models&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.logging_dir </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&quot;logs&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.baseline_dir </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">dirname</span><span class=\"mtk1\">(</span><span class=\"mtk7\">ROOT_PATH</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;baseline-code&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># file configuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.result_file </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.result_dir, </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{CFG</span><span class=\"mtk1\">.file_base_name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.csv&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.saved_model_file </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.saved_model_dir, </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{CFG</span><span class=\"mtk1\">.file_base_name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.pth&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.logging_file </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.logging_dir, </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{CFG</span><span class=\"mtk1\">.file_base_name</span><span class=\"mtk7\">}</span><span class=\"mtk6\">.log&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.label_to_num_file </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.baseline_dir, </span><span class=\"mtk6\">&#39;dict_label_to_num.pkl&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_to_label_file </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.baseline_dir, </span><span class=\"mtk6\">&quot;dict_num_to_label.pkl&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.train_file_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TRAIN_FILE_PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.test_file_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">TEST_FILE_PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.sample_submission_file_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">SAMPLE_SUBMISSION_PATH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Other configurations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.load_best_model_at_end </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span></span></span></code></pre>\n<h2 id=\"dataset\" style=\"position:relative;\"><a href=\"#dataset\" aria-label=\"dataset permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dataset</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> pandas </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> pd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> numpy </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> np</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> Dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AutoTokenizer, AutoConfig, AutoModelForSequenceClassification, Trainer, TrainingArguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> sklearn.model_selection </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> StratifiedKFold</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># read pororo dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PORORO_TRAIN_PATH</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># remove the first index column</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_pororo_dataset.</span><span class=\"mtk3\">drop</span><span class=\"mtk1\">(df_pororo_dataset.columns[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> random</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">seed_everything</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">seed</span><span class=\"mtk1\">) :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    torch.</span><span class=\"mtk3\">manual_seed</span><span class=\"mtk1\">(seed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    torch.cuda.</span><span class=\"mtk3\">manual_seed</span><span class=\"mtk1\">(seed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    torch.cuda.</span><span class=\"mtk3\">manual_seed_all</span><span class=\"mtk1\">(seed) </span><span class=\"mtk5 mtki\"># if use multi-GPU</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    torch.backends.cudnn.deterministic </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    torch.backends.cudnn.benchmark </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    np.random.</span><span class=\"mtk3\">seed</span><span class=\"mtk1\">(seed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    random.</span><span class=\"mtk3\">seed</span><span class=\"mtk1\">(seed)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">seed_everything</span><span class=\"mtk1\">(</span><span class=\"mtk7\">42</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> pickle </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> pickle</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">label_to_num</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">label</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;&quot;&quot; change the string labels into numerics &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  num_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">BASELINE_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;dict_label_to_num.pkl&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;rb&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> f:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    dict_label_to_num </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pickle.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(f)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> v </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> label:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    num_label.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(dict_label_to_num[v])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> num_label</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CustomDataset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Dataset</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">dataset</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">tokenizer</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">is_training</span><span class=\"mtk1\">: </span><span class=\"mtk8\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># pandas.Dataframe dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sentence </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset[</span><span class=\"mtk6\">&quot;sentence&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.subject_entity </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset[</span><span class=\"mtk6\">&quot;subject_entity&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.object_entity </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset[</span><span class=\"mtk6\">&quot;object_entity&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> is_training:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.train_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">label_to_num</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset[</span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">].values)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk10\">not</span><span class=\"mtk1\"> is_training:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.train_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset[</span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">].values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">tensor</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.train_label)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># tokenizer and etc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__getitem__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">idx</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        sentence </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sentence[idx]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.subject_entity[idx]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_entity </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.object_entity[idx]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.label[idx]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># concat entity in the beginning</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        concat_entity </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> subject_entity </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;[SEP]&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># tokenize</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">tokenizer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            concat_entity,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sentence,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">return_tensors</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&quot;pt&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">padding</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&quot;max_length&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">truncation</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">max_length</span><span class=\"mtk8\">=</span><span class=\"mtk7\">RBERT_CFG</span><span class=\"mtk1\">.max_token_length,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">return_token_type_ids</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">,  </span><span class=\"mtk5 mtki\"># for RoBERTa</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># RoBERTa&#39;s provided masks (do not include token_type_ids for RoBERTa)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict[</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> encoded_dict[</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict[</span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> encoded_dict[</span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># add subject and object entity masks where masks notate where the entity is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity_mask, object_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">add_entity_mask</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            encoded_dict, subject_entity, object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict[</span><span class=\"mtk6\">&quot;subject_mask&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> subject_entity_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict[</span><span class=\"mtk6\">&quot;object_mask&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> object_entity_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># fill label</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict[</span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> label</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> encoded_dict</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__len__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dataset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">add_entity_mask</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">encoded_dict</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">subject_entity</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">object_entity</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;&quot;&quot;add entity token to input_ids&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># print(&quot;tokenized input ids: \\n&quot;,encoded_dict[&#39;input_ids&#39;])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># initialize entity masks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">zeros</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.max_token_length, </span><span class=\"mtk4 mtki\">dtype</span><span class=\"mtk8\">=int</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">zeros</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.max_token_length, </span><span class=\"mtk4 mtki\">dtype</span><span class=\"mtk8\">=int</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># get token_id from encoding subject_entity and object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity_token_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tokenizer.</span><span class=\"mtk3\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            subject_entity, </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_entity_token_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tokenizer.</span><span class=\"mtk3\">encode</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            object_entity, </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># print(&quot;entity token&#39;s input ids: &quot;,subject_entity_token_ids, object_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># get the length of subject_entity and object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity_length </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(subject_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_entity_length </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(object_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># find coordinates of subject_entity_token_ids inside the encoded_dict[&quot;input_ids&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_coordinates </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">where</span><span class=\"mtk1\">(encoded_dict[</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> subject_entity_token_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_coordinates </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">map</span><span class=\"mtk1\">(</span><span class=\"mtk8\">int</span><span class=\"mtk1\">, subject_coordinates[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># change the subject_coordinates into int type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> subject_index </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> subject_coordinates:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            subject_entity_mask[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                subject_index : subject_index </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> subject_entity_length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># find coordinates of object_entity_token_ids inside the encoded_dict[&quot;input_ids&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_coordinates </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">where</span><span class=\"mtk1\">(encoded_dict[</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> object_entity_token_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_coordinates </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">map</span><span class=\"mtk1\">(</span><span class=\"mtk8\">int</span><span class=\"mtk1\">, object_coordinates[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># change the object_coordinates into int type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> object_index </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> object_coordinates:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            object_entity_mask[object_index : object_index </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> object_entity_length] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># print(subject_entity_mask)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># print(object_entity_mask)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">Tensor</span><span class=\"mtk1\">(subject_entity_mask), torch.</span><span class=\"mtk3\">Tensor</span><span class=\"mtk1\">(object_entity_mask)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot;Debugging add_entity_mask_sample function with sample code&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">special_token_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PORORO_SPECIAL_TOKEN_PATH</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;r&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">encoding</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;UTF-8&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> f :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> token </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> f :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        special_token_list.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(token.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;</span><span class=\"mtk8\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">added_token_num </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">add_special_tokens</span><span class=\"mtk1\">({</span><span class=\"mtk6\">&quot;additional_special_tokens&quot;</span><span class=\"mtk1\">:</span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span><span class=\"mtk8\">set</span><span class=\"mtk1\">(special_token_list))})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sample_item </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">CustomDataset</span><span class=\"mtk1\">(df_pororo_dataset, tokenizer)[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">decoded_item </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">decode</span><span class=\"mtk1\">(sample_item[</span><span class=\"mtk6\">&#39;input_ids&#39;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">add_entity_mask_sample</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">item</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">subject_entity</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">object_entity</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># add entity token to input_ids</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;tokenized input ids: </span><span class=\"mtk8\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">,item[</span><span class=\"mtk6\">&#39;input_ids&#39;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># initialize entity masks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    subject_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">zeros</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.max_token_length, </span><span class=\"mtk4 mtki\">dtype</span><span class=\"mtk8\">=int</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    object_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">zeros</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.max_token_length, </span><span class=\"mtk4 mtki\">dtype</span><span class=\"mtk8\">=int</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># get token_id from encoding subject_entity and object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    subject_entity_token_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">encode</span><span class=\"mtk1\">(subject_entity, </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    object_entity_token_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">encode</span><span class=\"mtk1\">(object_entity, </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># print(&quot;entity token&#39;s input ids: &quot;,subject_entity_token_ids, object_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># get the length of subject_entity and object_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    subject_entity_length </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(subject_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    object_entity_length </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(object_entity_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># find coordinates of subject_entity_token_ids inside the item[&quot;input_ids&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    subject_coordinate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">where</span><span class=\"mtk1\">(item[</span><span class=\"mtk6\">&#39;input_ids&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> subject_entity_token_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    subject_coordinate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span><span class=\"mtk8\">map</span><span class=\"mtk1\">(</span><span class=\"mtk8\">int</span><span class=\"mtk1\">, subject_coordinate[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])) </span><span class=\"mtk5 mtki\"># change the subject_coordinate into int type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> subject_index </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> subject_coordinate:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        subject_entity_mask[subject_index:subject_index</span><span class=\"mtk8\">+</span><span class=\"mtk1\">subject_entity_length] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># find coordinates of object_entity_token_ids inside the item[&quot;input_ids&quot;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    object_coordinate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">where</span><span class=\"mtk1\">(item[</span><span class=\"mtk6\">&#39;input_ids&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> object_entity_token_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    object_coordinate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span><span class=\"mtk8\">map</span><span class=\"mtk1\">(</span><span class=\"mtk8\">int</span><span class=\"mtk1\">, object_coordinate[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])) </span><span class=\"mtk5 mtki\"># change the object_coordinate into int type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> object_index </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> object_coordinate:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        object_entity_mask[object_index:object_index</span><span class=\"mtk8\">+</span><span class=\"mtk1\">object_entity_length] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># print(subject_entity_mask)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># print(object_entity_mask)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> subject_entity_mask, object_entity_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># print(sample_item)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(decoded_item)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">subject_entity_mask, object_entity_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">add_entity_mask_sample</span><span class=\"mtk1\">(sample_item, </span><span class=\"mtk6\">&#39;[SUB-PERSON]ë¹„í‹€ì¦ˆ[/SUB-PERSON]&#39;</span><span class=\"mtk1\">\t, </span><span class=\"mtk6\">&#39;[OBJ-PERSON]ì¡°ì§€ í•´ë¦¬ìŠ¨[/OBJ-PERSON]&#39;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[CLS]&#39;[SUB-PERSON] ë¹„í‹€ì¦ˆ [/SUB-PERSON]&#39;[SEP]&#39;[OBJ-PERSON] ì¡°ì§€ í•´ë¦¬ìŠ¨ [/OBJ-PERSON]&#39;[SEP] ã€ˆ Something ã€‰ ëŠ” [OBJ-PERSON] ì¡°ì§€ í•´ë¦¬ìŠ¨ [/OBJ-PERSON] ì´ ì“°ê³  [SUB-PERSON] ë¹„í‹€ì¦ˆ [/SUB-PERSON] ê°€ 1969ë…„ ì•¨ë²” ã€Š Abbey Road ã€‹ ì— ë‹´ì€ ë…¸ëž˜ë‹¤. [SEP] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD] [PAD]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(array([0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> array([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]))</span></span></code></pre>\n<ul>\n<li><code>[SUB-PERSON] ë¹„í‹€ì¦ˆ [/SUB-PERSON]</code> is given example's subject entity.</li>\n<li><code>[OBJ-PERSON] ì¡°ì§€ í•´ë¦¬ìŠ¨ [/OBJ-PERSON]</code> is given example's object entity.</li>\n<li>As shown on the result above, we can see that entity masks annotates the location of the corresponding entities with 1 and rest of tokens as 0.</li>\n<li>Rather than using entitiesâ€™ token only, surrounding entity markers were also pooled. This was to include more contextual information which divided target entities and other tokens. This is different from the original proposal at <a href=\"https://arxiv.org/pdf/1905.08284v1.pdf\">Enriching Pre-trained Language Model with Entity Information for Relation Classification, Wu et al. 2019</a>.</li>\n</ul>\n<h2 id=\"evaluation-function\" style=\"position:relative;\"><a href=\"#evaluation-function\" aria-label=\"evaluation function permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Evaluation function</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Metrics</span><span class=\"mtk1\">(</span><span class=\"mtk8\">object</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reset</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.val </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.avg </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">update</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">val</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">n</span><span class=\"mtk1\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.val </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> val</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> val </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> n</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> n</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.avg </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">/</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count</span></span></span></code></pre>\n<h2 id=\"custom-model-rbert-and-loss\" style=\"position:relative;\"><a href=\"#custom-model-rbert-and-loss\" aria-label=\"custom model rbert and loss permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Custom Model RBERT and Loss</h2>\n<p><img src=\"https://user-images.githubusercontent.com/28896432/68673458-1b090d00-0597-11ea-96b1-7c1453e6edbb.png\" alt=\"img\"></p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AutoModel, AutoConfig, AutoTokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FCLayer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot;R-BERT: https://github.com/monologg/R-BERT/blob/master/model.py&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">input_dim</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">output_dim</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">dropout_rate</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">use_activation</span><span class=\"mtk1\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">(FCLayer, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">).</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.use_activation </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> use_activation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Dropout</span><span class=\"mtk1\">(dropout_rate)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.linear </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(input_dim, output_dim)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tanh </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Tanh</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        x </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">dropout</span><span class=\"mtk1\">(x)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.use_activation:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            x </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">tanh</span><span class=\"mtk1\">(x)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">linear</span><span class=\"mtk1\">(x)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RBERT</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot;R-BERT: https://github.com/monologg/R-BERT/blob/master/model.py&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">model_name</span><span class=\"mtk1\">: </span><span class=\"mtk8\">str</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;klue/roberta-large&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">num_labels</span><span class=\"mtk1\">: </span><span class=\"mtk8\">int</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">30</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">dropout_rate</span><span class=\"mtk1\">: </span><span class=\"mtk8\">float</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">special_tokens_dict</span><span class=\"mtk1\">: </span><span class=\"mtk8\">dict</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">None</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">is_train</span><span class=\"mtk1\">: </span><span class=\"mtk8\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">(</span><span class=\"mtk7\">RBERT</span><span class=\"mtk1\">, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">).</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model_name </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model_name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        config </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoConfig.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.backbone_model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoModel.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_name, </span><span class=\"mtk4 mtki\">config</span><span class=\"mtk8\">=</span><span class=\"mtk1\">config)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout_rate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> dropout_rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.num_labels </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> num_labels</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        config.num_labels </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> num_labels</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># add special tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.special_tokens_dict </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> special_tokens_dict</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.backbone_model.</span><span class=\"mtk3\">resize_token_embeddings</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.tokenizer))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.cls_fc_layer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">FCLayer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            config.hidden_size, config.hidden_size, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout_rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.entity_fc_layer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">FCLayer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            config.hidden_size, config.hidden_size, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout_rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.label_classifier </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">FCLayer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            config.hidden_size </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">3</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.num_labels,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout_rate,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">use_activation</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">entity_average</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">hidden_output</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">e_mask</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Average the entity hidden state vectors (H_i ~ H_j)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        :param hidden_output: [batch_size, j-i+1, dim]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        :param e_mask: [batch_size, max_seq_len]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">                e.g. e_mask[0] == [0, 0, 0, 1, 1, 1, 0, 0, ... 0]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        :return: [batch_size, dim]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        e_mask_unsqueeze </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> e_mask.</span><span class=\"mtk3\">unsqueeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># [b, 1, j-i+1]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        length_tensor </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (e_mask </span><span class=\"mtk8\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">).</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk3\">unsqueeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># [batch_size, 1]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># [b, 1, j-i+1] * [b, j-i+1, dim] = [b, 1, dim] -&gt; [b, dim]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        sum_vector </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">bmm</span><span class=\"mtk1\">(e_mask_unsqueeze.</span><span class=\"mtk3\">float</span><span class=\"mtk1\">(), hidden_output).</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        avg_vector </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> sum_vector.</span><span class=\"mtk3\">float</span><span class=\"mtk1\">() </span><span class=\"mtk8\">/</span><span class=\"mtk1\"> length_tensor.</span><span class=\"mtk3\">float</span><span class=\"mtk1\">()  </span><span class=\"mtk5 mtki\"># broadcasting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> avg_vector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">input_ids</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">attention_mask</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">subject_mask</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">object_mask</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7 mtki\">labels</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        outputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">backbone_model</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">input_ids</span><span class=\"mtk8\">=</span><span class=\"mtk1\">input_ids, </span><span class=\"mtk4 mtki\">attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">attention_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        sequence_output </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&quot;last_hidden_state&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pooled_output </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk6\">&quot;pooler_output&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ]  </span><span class=\"mtk5 mtki\"># [CLS] token&#39;s hidden featrues(hidden state)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># hidden state&#39;s average in between entities</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># print(sequence_output.shape, subject_mask.shape)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        e1_h </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">entity_average</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sequence_output, subject_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># token in between subject entities -&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        e2_h </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">entity_average</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sequence_output, object_mask</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># token in between object entities</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># Dropout -&gt; tanh -&gt; fc_layer (Share FC layer for e1 and e2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pooled_output </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">cls_fc_layer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            pooled_output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># [CLS] token -&gt; hidden state | green on diagram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        e1_h </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">entity_fc_layer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            e1_h</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># subject entity&#39;s fully connected layer | yellow on diagram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        e2_h </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">entity_fc_layer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            e2_h</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )  </span><span class=\"mtk5 mtki\"># object entity&#39;s fully connected layer | red on diagram</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># Concat -&gt; fc_layer / [CLS], subject_average, object_average</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        concat_h </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">cat</span><span class=\"mtk1\">([pooled_output, e1_h, e2_h], </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">label_classifier</span><span class=\"mtk1\">(concat_h)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> logits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># WILL USE FOCAL LOSS INSTEAD OF MSELoss and CrossEntropyLoss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># outputs = (logits,) + outputs[2:]  # add hidden states and attention if they are here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># # Softmax</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># if labels is not None:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#     if self.num_labels == 1:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#         loss_fct = nn.MSELoss()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#         loss = loss_fct(logits.view(-1), labels.view(-1))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#     else:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#         loss_fct = nn.CrossEntropyLoss()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#         loss = loss_fct(logits.view(-1, self.num_labels), labels.view(-1))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#     outputs = (loss,) + outputs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#  return outputs  # (loss), logits, (hidden_states), (attentions)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn.functional </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> F</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.autograd </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> Variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FocalLoss</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">weight</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">gamma</span><span class=\"mtk1\">=</span><span class=\"mtk7\">2.0</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">reduction</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&quot;mean&quot;</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        nn.Module.</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> weight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> gamma</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> reduction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">input_tensor</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">target_tensor</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        log_prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">log_softmax</span><span class=\"mtk1\">(input_tensor, </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">exp</span><span class=\"mtk1\">(log_prob)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">nll_loss</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ((</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> prob) </span><span class=\"mtk8\">**</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma) </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> log_prob,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            target_tensor,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">weight</span><span class=\"mtk8\">=</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">reduction</span><span class=\"mtk8\">=</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span></code></pre>\n<h2 id=\"train\" style=\"position:relative;\"><a href=\"#train\" aria-label=\"train permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Train</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">device </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">device</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;cuda:0&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> torch.cuda.</span><span class=\"mtk3\">is_available</span><span class=\"mtk1\">() </span><span class=\"mtk10 mtki\">and</span><span class=\"mtk1\"> </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.</span><span class=\"mtk7\">DEBUG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;cpu&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(device)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">cuda:0</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># fetch tokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># fetch special tokens annotated with ner task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">special_token_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PORORO_SPECIAL_TOKEN_PATH</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;r&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">encoding</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;UTF-8&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> f :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> token </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> f :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        special_token_list.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(token.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;</span><span class=\"mtk8\">\\n</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># add special pororo ner tokens to the tokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">added_token_num </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">add_special_tokens</span><span class=\"mtk1\">({</span><span class=\"mtk6\">&quot;additional_special_tokens&quot;</span><span class=\"mtk1\">:</span><span class=\"mtk8\">list</span><span class=\"mtk1\">(</span><span class=\"mtk8\">set</span><span class=\"mtk1\">(special_token_list))})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">added_token_num</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">74</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">criterion </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">FocalLoss</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">gamma</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1.0</span><span class=\"mtk1\">) </span><span class=\"mtk5 mtki\"># 0.0 equals to CrossEntropy</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># read pororo ner labeled dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PORORO_TRAIN_PATH</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># remove the first index column</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_pororo_dataset.</span><span class=\"mtk3\">drop</span><span class=\"mtk1\">(df_pororo_dataset.columns[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset.</span><span class=\"mtk3\">head</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.dataframe tbody tr th {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vertical-align: top;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.dataframe thead th {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    text-align: right;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>id</th>\n      <th>sentence</th>\n      <th>label</th>\n      <th>subject_entity</th>\n      <th>object_entity</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>ã€ˆSomethingã€‰ëŠ” [OBJ-PERSON]ì¡°ì§€ í•´ë¦¬ìŠ¨[/OBJ-PERSON]ì´ ...</td>\n      <td>no_relation</td>\n      <td>'[SUB-PERSON]ë¹„í‹€ì¦ˆ[/SUB-PERSON]'</td>\n      <td>'[OBJ-PERSON]ì¡°ì§€ í•´ë¦¬ìŠ¨[/OBJ-PERSON]'</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>í˜¸ë‚¨ì´ ê¸°ë°˜ì¸ ë°”ë¥¸ë¯¸ëž˜ë‹¹Â·[OBJ-ORGANIZATION]ëŒ€ì•ˆì‹ ë‹¹[/OBJ-ORGA...</td>\n      <td>no_relation</td>\n      <td>'[SUB-ORGANIZATION]ë¯¼ì£¼í‰í™”ë‹¹[/SUB-ORGANIZATION]'</td>\n      <td>'[OBJ-ORGANIZATION]ëŒ€ì•ˆì‹ ë‹¹[/OBJ-ORGANIZATION]'</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> sklearn.metrics </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> f1_score, confusion_matrix</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data.dataset </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> Subset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> DataLoader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> get_cosine_schedule_with_warmup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> adamp </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AdamP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AdamW</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> tqdm </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> tqdm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> easydict </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> EasyDict</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># read pororo dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(</span><span class=\"mtk7\">DATA_CFG</span><span class=\"mtk1\">.pororo_train_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># remove the first index column</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_pororo_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_pororo_dataset.</span><span class=\"mtk3\">drop</span><span class=\"mtk1\">(df_pororo_dataset.columns[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># fetch tokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># fetch special tokens annotated with ner task</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">special_token_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(</span><span class=\"mtk7\">DATA_CFG</span><span class=\"mtk1\">.pororo_special_token_path, </span><span class=\"mtk6\">&quot;r&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">encoding</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&quot;UTF-8&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> f:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> token </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> f:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    special_token_list.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(token.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;</span><span class=\"mtk8\">\\n</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">)[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> torch.cuda.</span><span class=\"mtk3\">is_available</span><span class=\"mtk1\">() </span><span class=\"mtk10\">and</span><span class=\"mtk1\"> </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.debug </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      device </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">device</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;cuda&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;There are </span><span class=\"mtk7\">{</span><span class=\"mtk1\">torch.cuda.</span><span class=\"mtk3\">device_count</span><span class=\"mtk1\">()</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> GPU(s) available.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;GPU Name:&quot;</span><span class=\"mtk1\">, torch.cuda.</span><span class=\"mtk3\">get_device_name</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;No GPU, using CPU.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        device </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">device</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;cpu&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        criterion </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">FocalLoss</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">gamma</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.gamma)  </span><span class=\"mtk5 mtki\"># 0.0 equals to CrossEntropy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        train_data </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">RBERT_Dataset</span><span class=\"mtk1\">(df_pororo_dataset, tokenizer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        dev_data </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">RBERT_Dataset</span><span class=\"mtk1\">(df_pororo_dataset, tokenizer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        stf </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">StratifiedKFold</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk4 mtki\">n_splits</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_folds, </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">random_state</span><span class=\"mtk8\">=</span><span class=\"mtk3\">seed_everything</span><span class=\"mtk1\">(</span><span class=\"mtk7\">42</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> fold_num, (train_idx, dev_idx) </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          stf.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(df_pororo_dataset, </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(df_pororo_dataset[</span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;#################### Fold: </span><span class=\"mtk7\">{</span><span class=\"mtk1\">fold_num </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1}</span><span class=\"mtk6\"> ######################&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          train_set </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Subset</span><span class=\"mtk1\">(train_data, train_idx)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          dev_set </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Subset</span><span class=\"mtk1\">(dev_data, dev_idx)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          train_loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            train_set,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.batch_size,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">num_workers</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_workers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          dev_loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_set,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.batch_size,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">num_workers</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_workers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># fetch model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">RBERT</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.model_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          model.</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># fetch loss function, optimizer, scheduler outside of torch library</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># https://github.com/clovaai/AdamP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          optimizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">AdamP</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            model.</span><span class=\"mtk3\">parameters</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">lr</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.learning_rate,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">betas</span><span class=\"mtk8\">=</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.9</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.999</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">weight_decay</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.weight_decay,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># optimizer = AdamW(model.parameters(), lr=CFG.learning_rate, betas=(0.9, 0.999), weight_decay=CFG.weight_decay) # AdamP is better</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># https://huggingface.co/transformers/main_classes/optimizer_schedules.html</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          scheduler </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">get_cosine_schedule_with_warmup</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            optimizer,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">num_warmup_steps</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.warmup_steps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">num_training_steps</span><span class=\"mtk8\">=len</span><span class=\"mtk1\">(train_loader) </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_epochs,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          best_eval_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk5 mtki\"># fetch training loop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> epoch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(</span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_epochs)):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            train_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> _, batch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(train_loader):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              optimizer.</span><span class=\"mtk3\">zero_grad</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># print(item)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># assign forward() arguments to the device</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">4</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              inputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">: batch[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">: batch[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk6\">&quot;subject_mask&quot;</span><span class=\"mtk1\">: batch[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># &#39;token_type_ids&#39; # NOT FOR ROBERTA!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk6\">&quot;object_mask&quot;</span><span class=\"mtk1\">: batch[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">: label,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># model to training mode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              model.</span><span class=\"mtk3\">train</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              pred_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(**inputs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(pred_logits, label)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># backward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              loss.</span><span class=\"mtk3\">backward</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              optimizer.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              scheduler.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># update metrics</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              train_loss.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">(loss.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(label))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              steps </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk5 mtki\"># for every 100 steps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> steps </span><span class=\"mtk8\">%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk6\">&quot;Epoch: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(epoch </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_epochs),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk6\">&quot;Step: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(steps),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk6\">&quot;Train Loss: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(train_loss.avg),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> dev_batch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> dev_loader:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  dev_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> dev_batch[</span><span class=\"mtk7\">4</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  dev_inputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">: dev_batch[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">: dev_batch[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;subject_mask&quot;</span><span class=\"mtk1\">: dev_batch[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk5 mtki\"># &#39;token_type_ids&#39; # NOT FOR ROBERTA!</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;object_mask&quot;</span><span class=\"mtk1\">: dev_batch[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;label&quot;</span><span class=\"mtk1\">: dev_label,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk5 mtki\"># switch model to eval mode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  model.</span><span class=\"mtk3\">eval</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  dev_pred_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(**dev_inputs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(dev_pred_logits, dev_label)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk5 mtki\"># update metrics</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  dev_loss.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">(loss.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(dev_label))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk5 mtki\"># print metrics</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;Epoch: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(epoch </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_epochs),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;Step: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(steps),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk6\">&quot;Dev Loss: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(dev_loss.avg),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> best_eval_loss </span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\"> dev_loss.avg:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    best_eval_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> dev_loss.avg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    torch.</span><span class=\"mtk3\">save</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      model.</span><span class=\"mtk3\">state_dict</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk6\">&quot;./results/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">-fold-</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">-best-eval-loss-model.pt&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        fold_num </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_folds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk6\">&quot;Saved model with lowest validation loss: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        best_eval_loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    early_stop </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      early_stop </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                      </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> early_stop </span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk10 mtki\">break</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk5 mtki\"># Prevent OOM error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        model.</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk10 mtki\">del</span><span class=\"mtk1\"> model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        torch.cuda.</span><span class=\"mtk3\">empty_cache</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;#################### TRAIN IS OVER! ######################&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### Fold: 1 ######################</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 100 Train Loss: 2.6070 Train Acc: 0.2928</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 100 Dev Loss: 1.6841 Dev Acc: 0.4740</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 200 Train Loss: 1.1751 Train Acc: 0.6205</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 200 Dev Loss: 0.7841 Dev Acc: 0.7094</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Saved model with lowest validation loss: 0.7841</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 300 Train Loss: 0.7315 Train Acc: 0.7128</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 300 Dev Loss: 0.6191 Dev Acc: 0.7390</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Saved model with lowest validation loss: 0.6191</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 400 Train Loss: 0.6154 Train Acc: 0.7340</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 400 Dev Loss: 0.5609 Dev Acc: 0.7464</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Saved model with lowest validation loss: 0.5609</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 500 Train Loss: 0.5744 Train Acc: 0.7425</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 500 Dev Loss: 0.5403 Dev Acc: 0.7556</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Saved model with lowest validation loss: 0.5403</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 600 Train Loss: 0.5574 Train Acc: 0.7448</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/5 Step: 600 Dev Loss: 0.4909 Dev Acc: 0.7582</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Saved model with lowest validation loss: 0.4909</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [1:45:35&lt;00:00, 1267.16s/it]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### Fold: 2 ######################</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [1:44:46&lt;00:00, 1257.26s/it]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### Fold: 3 ######################</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [1:44:38&lt;00:00, 1255.74s/it]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### Fold: 4 ######################</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [1:46:05&lt;00:00, 1273.11s/it]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### Fold: 5 ######################</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [1:47:18&lt;00:00, 1287.77s/it]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">#################### TRAIN IS OVER! ######################</span></span></code></pre>\n<p><a href=\"https://wandb.ai/snoop2head/KLUE-RE/runs/htwirbkj?workspace=user-snoop2head\">ðŸ“ˆ Train and evaluation logs are visualized in wandb</a></p>\n<h2 id=\"inference-for-the-test-dataset\" style=\"position:relative;\"><a href=\"#inference-for-the-test-dataset\" aria-label=\"inference for the test dataset permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Inference for the Test Dataset</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">num_to_label</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">label</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk6\">&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">    ìˆ«ìžë¡œ ë˜ì–´ ìžˆë˜ classë¥¼ ì›ë³¸ ë¬¸ìžì—´ ë¼ë²¨ë¡œ ë³€í™˜ í•©ë‹ˆë‹¤.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  origin_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">BASELINE_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;dict_num_to_label.pkl&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk6\">&#39;rb&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> f:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    dict_num_to_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pickle.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(f)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> v </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> label:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    origin_label.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(dict_num_to_label[v])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> origin_label</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> DataLoader, Dataset, Subset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">test_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PORORO_TEST_PATH</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">display</span><span class=\"mtk1\">(test_dataset.</span><span class=\"mtk3\">head</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># test_dataset = test_dataset.drop(test_dataset.columns[0], axis=1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">test_dataset[</span><span class=\"mtk6\">&#39;label&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(test_dataset))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">test_set </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">CustomDataset</span><span class=\"mtk1\">(test_dataset, tokenizer, </span><span class=\"mtk4 mtki\">is_training</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(test_set))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">test_data_loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(test_set, </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.batch_size, </span><span class=\"mtk4 mtki\">num_workers</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">.num_workers, </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">.dataframe tbody tr th {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vertical-align: top;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.dataframe thead th {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    text-align: right;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>id</th>\n      <th>sentence</th>\n      <th>label</th>\n      <th>subject_entity</th>\n      <th>object_entity</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0</td>\n      <td>ì§€ë‚œ 15ì¼ [SUB-ORGANIZATION]MBC[/SUB-ORGANIZATION...</td>\n      <td>100</td>\n      <td>'[SUB-ORGANIZATION]MBC[/SUB-ORGANIZATION]'</td>\n      <td>'[OBJ-O]íƒì‚¬ê¸°íš ìŠ¤íŠ¸ë ˆì´íŠ¸[/OBJ-O]'</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1</td>\n      <td>ì‚¬ëž‘ìŠ¤ëŸ¬ìš´ â€˜[SUB-ARTIFACT]í”„ë¦°ì„¸ìŠ¤ í”„ë§[/SUB-ARTIFACT]â€™ì˜ ...</td>\n      <td>100</td>\n      <td>'[SUB-ARTIFACT]í”„ë¦°ì„¸ìŠ¤ í”„ë§[/SUB-ARTIFACT]'</td>\n      <td>'[OBJ-LOCATION]ê³µì£¼[/OBJ-LOCATION]'</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">7765</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; check whether test dataset is correctly mapped &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> tqdm </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> tqdm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i, data </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(</span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(test_data_loader)) :</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(data)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">break</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  0%|          | 0/195 [00:00&lt;?, ?it/s]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;input_ids&#39;: tensor([[    0,    11, 32067,  ...,     1,     1,     1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [    0,    11, 32001,  ...,     1,     1,     1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [    0,    11, 32067,  ...,  4271,  2145,     2],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [    0,    11, 32067,  ...,     1,     1,     1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [    0,    11, 32056,  ...,     1,     1,     1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [    0,    11, 32006,  ...,     1,     1,     1]]), &#39;attention_mask&#39;: tensor([[1, 1, 1,  ..., 0, 0, 0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [1, 1, 1,  ..., 0, 0, 0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [1, 1, 1,  ..., 1, 1, 1],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [1, 1, 1,  ..., 0, 0, 0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [1, 1, 1,  ..., 0, 0, 0],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [1, 1, 1,  ..., 0, 0, 0]]), &#39;subject_mask&#39;: tensor([[0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.]]), &#39;object_mask&#39;: tensor([[0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ...,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        [0., 1., 1.,  ..., 0., 0., 0.]]), &#39;label&#39;: tensor([100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100])}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0%|          | 0/195 [00:00&lt;?, ?it/s]</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">oof_pred </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []  </span><span class=\"mtk5 mtki\"># out of fold prediction list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">5</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  model_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/opt/ml/klue-level2-nlp-15/notebooks/results/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">-fold-5-best-eval-loss-model.pt&quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    i </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">RBERT</span><span class=\"mtk1\">(</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">[</span><span class=\"mtk6\">&quot;pretrained_model_name&quot;</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">dropout_rate</span><span class=\"mtk8\">=</span><span class=\"mtk7\">CFG</span><span class=\"mtk1\">[</span><span class=\"mtk6\">&quot;dropout_rate&quot;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  model.</span><span class=\"mtk3\">load_state_dict</span><span class=\"mtk1\">(torch.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(model_path))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  model.</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  model.</span><span class=\"mtk3\">eval</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  output_pred </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i, data </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(</span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(test_data_loader)):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">no_grad</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      outputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">input_ids</span><span class=\"mtk8\">=</span><span class=\"mtk1\">data[</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">data[</span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">subject_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">data[</span><span class=\"mtk6\">&quot;subject_mask&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">object_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">data[</span><span class=\"mtk6\">&quot;object_mask&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># token_type_ids=data[&#39;token_type_ids&#39;].to(device) # RoBERTa does not use token_type_ids.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output_pred.</span><span class=\"mtk3\">extend</span><span class=\"mtk1\">(outputs.</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">().</span><span class=\"mtk3\">detach</span><span class=\"mtk1\">().</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      output_pred </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">softmax</span><span class=\"mtk1\">(torch.</span><span class=\"mtk3\">Tensor</span><span class=\"mtk1\">(output_pred), </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      oof_pred.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(np.</span><span class=\"mtk3\">array</span><span class=\"mtk1\">(output_pred)[:, np.newaxis])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># Prevent OOM error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      model.</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">del</span><span class=\"mtk1\"> model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      torch.cuda.</span><span class=\"mtk3\">empty_cache</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">models_prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        np.</span><span class=\"mtk3\">concatenate</span><span class=\"mtk1\">(oof_pred, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">2</span><span class=\"mtk1\">), </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )  </span><span class=\"mtk5 mtki\"># probability of each class</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">result </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">argmax</span><span class=\"mtk1\">(models_prob, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># label</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># print(result, type(result))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># print(models_prob.shape, list_prob)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[ 3 12  0 ...  1  0  0] &lt;class &#39;numpy.ndarray&#39;&gt;</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># save for submission</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">list_prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> models_prob.</span><span class=\"mtk3\">tolist</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">test_id </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> test_dataset[</span><span class=\"mtk6\">&#39;id&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_submission </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">DataFrame</span><span class=\"mtk1\">({</span><span class=\"mtk6\">&#39;id&#39;</span><span class=\"mtk1\">:test_id,</span><span class=\"mtk6\">&#39;pred_label&#39;</span><span class=\"mtk1\">:</span><span class=\"mtk3\">num_to_label</span><span class=\"mtk1\">(result),</span><span class=\"mtk6\">&#39;probs&#39;</span><span class=\"mtk1\">:list_prob,})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_submission.</span><span class=\"mtk3\">to_csv</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./prediction/submission_RBERT.csv&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">index</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre><code class=\"language-python\"></code></pre>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .one-dark-pro {\n    background-color: #282c34;\n    color: #abb2bf;\n  }\n  .one-dark-pro .mtki { font-style: italic; }\n  .one-dark-pro .mtk6 { color: #98C379; }\n  .one-dark-pro .mtk10 { color: #C678DD; }\n  .one-dark-pro .mtk1 { color: #ABB2BF; }\n  .one-dark-pro .mtk8 { color: #56B6C2; }\n  .one-dark-pro .mtk5 { color: #7F848E; }\n  .one-dark-pro .mtk7 { color: #D19A66; }\n  .one-dark-pro .mtk3 { color: #61AFEF; }\n  .one-dark-pro .mtk4 { color: #E06C75; }\n  .one-dark-pro .mtk11 { color: #E5C07B; }\n  .one-dark-pro .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","tableOfContents":"<ul>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#model-performance-and-log-on-weights-and-biaseswandb\">Model Performance and log on <code>weights and biases(wandb)</code></a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#rbert-explanation\">RBERT explanation</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#config\">Config</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#dataset\">Dataset</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#evaluation-function\">Evaluation function</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#custom-model-rbert-and-loss\">Custom Model RBERT and Loss</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#train\">Train</a></li>\n<li><a href=\"/DL&#x26;ML/Relation-Extraction-Code/#inference-for-the-test-dataset\">Inference for the Test Dataset</a></li>\n</ul>","frontmatter":{"date":"2021-10-09","title":"RBERT for Relation Extraction: full code & Wandb log","tags":["DL&ML","NLP","Competition"]}}},"pageContext":{"slug":"/DL&ML/Relation-Extraction-Code/","previous":{"fields":{"slug":"/DL&ML/Relation-Extraction/"},"frontmatter":{"title":"KLUE Relation Extraction: Subject Entity and Object Entity"}},"next":{"fields":{"slug":"/Configs/VSCode-ssh/"},"frontmatter":{"title":"Configuration for VSCode and ZSH in Remote Server"}}}},"staticQueryHashes":["1081905842","3911196313"]}