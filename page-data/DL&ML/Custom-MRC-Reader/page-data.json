{"componentChunkName":"component---src-templates-blog-post-js","path":"/DL&ML/Custom-MRC-Reader/","result":{"data":{"site":{"siteMetadata":{"author":"Young Jin Ahn","comment":{"utterances":"snoop2head/snoop2head.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"excerpt":"ğŸ‘ F1 score of 79.650 ranked the 5th place / 19 teams ğŸ’ª Exact Match score of 66.670 ranked 10th place / 19 teams  For Performance and Hyperparameters Comparison, Please refer to ğŸ”— wandb Extractive Macâ€¦","html":"<p>ğŸ‘ <strong>F1 score of 79.650 ranked the 5th place / 19 teams</strong></p>\n<p>ğŸ’ª <strong>Exact Match score of 66.670 ranked 10th place / 19 teams</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZUlEQVQoz3VS7ZKDIAzkLa4qBBHkQ6W1Xq/3/k+2F9C215u5HzuRhITdjaLpJE5NC+scQgwgrXFqOzRS1dhKidF7OEanONcdNe5RfDemiMFaNJwvNSGJsOYFX/mKz7ximy9ILvEFhWEwuK8bvi9Xrq+4pgxnPDdKxOhxP6+4cd+2XHCOC0gZCDM4TGGBlBpSaSjqa/xgdjFMcNbzmaBKTfVoO2KmhCktML1DJ2nv41ohIepB92/QxqBleZLe89TvKAMl6Sr5VTMoakXLfhR0fJB8oVyuuSMWv0qu4wFF6qP2yD3j8S3KUog/4ugxxwRrBqZPKPmCgV9ec8a6ZHjrqvT2GFIf/QOh2XgbHPTQ77AGZHY2zo+4bxvOU0aOM2Oqvu2KDnZPtnsUxljc1hsWZpBS4u1FjC7UpUxp5qWE4zeSVf5TMr2Y/oYo5g+86RTmuu0lZoRx4tf003w6TK/mM6q8fwb+AHmu+BEz9Q/vAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20211104231519392\"\n        title=\"image-20211104231519392\"\n        src=\"/static/e54184b4b0b3c9b087f62821018a57fd/c1b63/image-20211104231519392.png\"\n        srcset=\"/static/e54184b4b0b3c9b087f62821018a57fd/5a46d/image-20211104231519392.png 300w,\n/static/e54184b4b0b3c9b087f62821018a57fd/0a47e/image-20211104231519392.png 600w,\n/static/e54184b4b0b3c9b087f62821018a57fd/c1b63/image-20211104231519392.png 1200w,\n/static/e54184b4b0b3c9b087f62821018a57fd/d61c2/image-20211104231519392.png 1800w,\n/static/e54184b4b0b3c9b087f62821018a57fd/97a96/image-20211104231519392.png 2400w,\n/static/e54184b4b0b3c9b087f62821018a57fd/65184/image-20211104231519392.png 4144w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><strong>For Performance and Hyperparameters Comparison, Please refer to <a href=\"https://wandb.ai/happyface-boostcamp/KLUE-QA?workspace=user-snoop2head\">ğŸ”— wandb</a></strong></p>\n<hr>\n<p>Extractive Machine Reading Comprehension can be divided into two sub-tasks which are 1) Retrieval and 2) Reader. Retrieval task fetches documents that are related to the tasks. Reader task aims to extract the answer phrase for the given question.</p>\n<h2 id=\"retrieval\" style=\"position:relative;\"><a href=\"#retrieval\" aria-label=\"retrieval permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Retrieval</h2>\n<p>For this competition, we tested all the available options given to us.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYElEQVQY0x2QUW/SUACF+0pGCwKjg3ERaktHL4V0yDrCkptYtJhKMyTqNl10TkNYlsWHLVP3Mk30ZfHZn/uJez5fTr5zNGE2CVoj3IZgKjfZLObJrGWxHYcwDKlUKtSqgmGg2PH7qF4L36pRyBmsZXVM08S2bQxdJ2cYaEMvIhm850XP4zZyUE7lvuQ4iXieTPH9DqV8mYvTr/y6/sGfywWHsaKYy1IqFPE9SRA8Rkqfak2gRb2U2e6SxajP34nFvFOlaVl8TMck0xTPa69sSlx8uub395/cXZ3xcjxClDdI1VsmOzHfXj/j5sOMYxWghZ5isvuGdNtnGXVRXgPd0NnrDUiezGmKRxTyRY5mp7zbP+D8IGWqQmrrG8yfnhCHMZ+jbb68ijmJBmgPG3Xa0mVLSjpBn3qjiRACp+XS7XZxXff+J1GvY63M5Yr7n2cyGcrmOu3VglZbYrtb5B4U+AcCoaBYBWT3OQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20211104223835084\"\n        title=\"image-20211104223835084\"\n        src=\"/static/c08c2e250354ad732ec90d216396d6b5/c1b63/image-20211104223835084.png\"\n        srcset=\"/static/c08c2e250354ad732ec90d216396d6b5/5a46d/image-20211104223835084.png 300w,\n/static/c08c2e250354ad732ec90d216396d6b5/0a47e/image-20211104223835084.png 600w,\n/static/c08c2e250354ad732ec90d216396d6b5/c1b63/image-20211104223835084.png 1200w,\n/static/c08c2e250354ad732ec90d216396d6b5/d61c2/image-20211104223835084.png 1800w,\n/static/c08c2e250354ad732ec90d216396d6b5/55681/image-20211104223835084.png 2062w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"1-sparse-retrieval\" style=\"position:relative;\"><a href=\"#1-sparse-retrieval\" aria-label=\"1 sparse retrieval permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1) Sparse Retrieval</h3>\n<ul>\n<li>BM25</li>\n<li>BM25+</li>\n<li>Elastic Search</li>\n</ul>\n<h3 id=\"2-dense-retrieval\" style=\"position:relative;\"><a href=\"#2-dense-retrieval\" aria-label=\"2 dense retrieval permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2) Dense Retrieval</h3>\n<ul>\n<li>Dense Passage Biencoder - (a)</li>\n<li>Cross Encoder - (c)</li>\n<li>ColBERT - (d)</li>\n</ul>\n<h2 id=\"reader\" style=\"position:relative;\"><a href=\"#reader\" aria-label=\"reader permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reader</h2>\n<p>I was interested in building reader model. I thought that Dense Retrieval methods may overperform sparse retrieval methods, but using transformers model is disadvantage in both computation time and resource.</p>\n<p><strong>For the reader, I thought it was essential to run small but representative tests for the optimization.</strong></p>\n<p>Variables that I tried to control are</p>\n<ul>\n<li>K-Fold</li>\n<li>Learning Rate</li>\n<li>Optimizer</li>\n<li>Loss</li>\n<li>Batch Size and Batching Strategy</li>\n<li>Attaching different types of heads to the transformer backbone network(ex: bidirectional LSTM)</li>\n<li>Ensemble Strategy</li>\n</ul>\n<p><strong>Reader's task is multi-class classification task where the model should identify 1) which token is the starting point and 2) which token is end point.</strong> <strong>Answer phrase are multiple tokens in between those predicted token indices.</strong> Thus, both the start<em>logit and end</em>logit is given to each sequence tokens in the sentence.</p>\n<p><img src=\"http://www.mccormickml.com/assets/BERT/SQuAD/start_word_scores_barplot.png\" alt=\"Start word scores\"></p>\n<p><img src=\"http://www.mccormickml.com/assets/BERT/SQuAD/end_word_scores_barplot.png\" alt=\"End word scores\"></p>\n<p><a href=\"https://mccormickml.com/2020/03/10/question-answering-with-a-fine-tuned-BERT/\">Image Source - Question Answering with a Fine-Tuned BERT</a></p>\n<p><strong>I customized experimentation code which satiesfied the following criteria.</strong> I aimed to control different types of variables that might affect the Reader's performance.</p>\n<p>Validation result should show key primary indices for optimization.</p>\n<ol>\n<li>Start indexing accuracy(start_accuracy)</li>\n<li>End indexing accuracy(end_accuracy)</li>\n<li>Answer phrase Exact Match(EM) score</li>\n</ol>\n<p>These following variables should be customizable where different sets of parameters can be set.</p>\n<ul>\n<li>Learning Rate</li>\n<li>Optimizer: AdamW, AdamP</li>\n<li>Loss: FocalLoss, CrossEntropyLoss, LabelSmoothingLoss</li>\n<li>Attaching different types of heads to the transformer backbone network(ex: bidirectional LSTM)</li>\n</ul>\n<h2 id=\"load-dataset\" style=\"position:relative;\"><a href=\"#load-dataset\" aria-label=\"load dataset permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Load Dataset</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> os</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">os.environ[</span><span class=\"mtk6\">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;false&quot;</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">dotdict</span><span class=\"mtk1\">(</span><span class=\"mtk8\">dict</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot;dot.notation access to dictionary attributes, as dict.key_name, not as dict[&quot;key_name&quot;] &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">__getattr__</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">dict</span><span class=\"mtk1\">.get</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">__setattr__</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">dict</span><span class=\"mtk1\">.</span><span class=\"mtk8\">__setitem__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">__delattr__</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">dict</span><span class=\"mtk1\">.</span><span class=\"mtk8\">__delitem__</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> yaml</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Read config.yaml file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> </span><span class=\"mtk8\">open</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;config.yaml&quot;</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> infile:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">SAVED_CFG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> yaml.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(infile, </span><span class=\"mtk4 mtki\">Loader</span><span class=\"mtk8\">=</span><span class=\"mtk1\">yaml.FullLoader)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">SAVED_CFG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">dotdict</span><span class=\"mtk1\">(</span><span class=\"mtk7\">SAVED_CFG</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># arguments setting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">data_args </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">dotdict</span><span class=\"mtk1\">(</span><span class=\"mtk7\">SAVED_CFG</span><span class=\"mtk1\">.data)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">dotdict</span><span class=\"mtk1\">(</span><span class=\"mtk7\">SAVED_CFG</span><span class=\"mtk1\">.custom_model)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># adding additional arguments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.batch_size </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.num_rnn_layers </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.learning_rate </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2e-5</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.num_folds </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.gamma </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.smoothing </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;model_name_or_path&#39;: &#39;klue/roberta-large&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;save_steps&#39;: 100,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;num_train_epochs&#39;: 3,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;learning_rate&#39;: 2e-05,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;batch_size&#39;: 10,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;warmup_steps&#39;: 300,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;weight_decay&#39;: 0.01,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;validation&#39;: False,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;max_length&#39;: 512,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;DEBUG&#39;: True,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;num_rnn_layers&#39;: 2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;num_folds&#39;: 4,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;gamma&#39;: 1.0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;smoothing&#39;: 0.2}</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">name_of_experiment </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&#39;lstm-trainer-AdamW-CE-num_rnn_layers-</span><span class=\"mtk7\">{</span><span class=\"mtk1\">model_args.num_rnn_layers</span><span class=\"mtk7\">}</span><span class=\"mtk6\">-no-clip&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(name_of_experiment)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">lstm-trainer-AdamW-CE-num_rnn_layers-2-no-clip</span></span></code></pre>\n<h2 id=\"make-custom-dataset\" style=\"position:relative;\"><a href=\"#make-custom-dataset\" aria-label=\"make custom dataset permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Make Custom Dataset</h2>\n<p><strong>Remove Passages where Answers located > 512 token length</strong></p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> datasets </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> load_from_disk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> (DataLoader, RandomSampler, TensorDataset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># load dataset from the huggingface format dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">datasets </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">load_from_disk</span><span class=\"mtk1\">(data_args.dataset_name)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_dataset_from_huggingface </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> datasets[</span><span class=\"mtk6\">&#39;train&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_dataset_from_huggingface </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> datasets[</span><span class=\"mtk6\">&#39;validation&#39;</span><span class=\"mtk1\">]</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_dataset_from_huggingface[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;title&#39;: &#39;ë¯¸êµ­ ìƒì›&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;context&#39;: &#39;ë¯¸êµ­ ìƒì˜ì› ë˜ëŠ” ë¯¸êµ­ ìƒì›(United States Senate)ì€ ì–‘ì›ì œì¸ ë¯¸êµ­ ì˜íšŒì˜ ìƒì›ì´ë‹¤.\\\\n\\\\në¯¸êµ­ ë¶€í†µë ¹ì´ ìƒì›ì˜ì¥ì´ ëœë‹¤. ê° ì£¼ë‹¹ 2ëª…ì˜ ìƒì›ì˜ì›ì´ ì„ ì¶œë˜ì–´ 100ëª…ì˜ ìƒì›ì˜ì›ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ì„ê¸°ëŠ” 6ë…„ì´ë©°, 2ë…„ë§ˆë‹¤ 50ê°œì£¼ ì¤‘ 1/3ì”© ìƒì›ì˜ì›ì„ ìƒˆë¡œ ì„ ì¶œí•˜ì—¬ ì—°ë°©ì— ë³´ë‚¸ë‹¤.\\\\n\\\\në¯¸êµ­ ìƒì›ì€ ë¯¸êµ­ í•˜ì›ê³¼ëŠ” ë‹¤ë¥´ê²Œ ë¯¸êµ­ ëŒ€í†µë ¹ì„ ìˆ˜ë°˜ìœ¼ë¡œ í•˜ëŠ” ë¯¸êµ­ ì—°ë°© í–‰ì •ë¶€ì— ê°ì¢… ë™ì˜ë¥¼ í•˜ëŠ” ê¸°ê´€ì´ë‹¤. í•˜ì›ì´ ì„¸ê¸ˆê³¼ ê²½ì œì— ëŒ€í•œ ê¶Œí•œ, ëŒ€í†µë ¹ì„ í¬í•¨í•œ ëŒ€ë‹¤ìˆ˜ì˜ ê³µë¬´ì›ì„ íŒŒë©´í•  ê¶Œí•œì„ ê°–ê³  ìˆëŠ” êµ­ë¯¼ì„ ëŒ€í‘œí•˜ëŠ” ê¸°ê´€ì¸ ë°˜ë©´ ìƒì›ì€ ë¯¸êµ­ì˜ ì£¼ë¥¼ ëŒ€í‘œí•œë‹¤. ì¦‰ ìº˜ë¦¬í¬ë‹ˆì•„ì£¼, ì¼ë¦¬ë…¸ì´ì£¼ ê°™ì´ ì£¼ ì •ë¶€ì™€ ì£¼ ì˜íšŒë¥¼ ëŒ€í‘œí•˜ëŠ” ê¸°ê´€ì´ë‹¤. ê·¸ë¡œ ì¸í•˜ì—¬ êµ°ëŒ€ì˜ íŒŒë³‘, ê´€ë£Œì˜ ì„ëª…ì— ëŒ€í•œ ë™ì˜, ì™¸êµ­ ì¡°ì•½ì— ëŒ€í•œ ìŠ¹ì¸ ë“± ì‹ ì†ì„ ìš”í•˜ëŠ” ê¶Œí•œì€ ëª¨ë‘ ìƒì›ì—ê²Œë§Œ ìˆë‹¤. ê·¸ë¦¬ê³  í•˜ì›ì— ëŒ€í•œ ê²¬ì œ ì—­í• (í•˜ì›ì˜ ë²•ì•ˆì„ ê±°ë¶€í•  ê¶Œí•œ ë“±)ì„ ë‹´ë‹¹í•œë‹¤. 2ë…„ì˜ ì„ê¸°ë¡œ ì¸í•˜ì—¬ ê¸‰ì§„ì ì¼ ìˆ˜ë°–ì— ì—†ëŠ” í•˜ì›ì€ ì§€ë‚˜ì¹˜ê²Œ ê¸‰ì§„ì ì¸ ë²•ì•ˆì„ ë§Œë“¤ê¸° ì‰½ë‹¤. ëŒ€í‘œì ì¸ ì˜ˆë¡œ ê±´ê°•ë³´í—˜ ê°œí˜ ë‹¹ì‹œ í•˜ì›ì´ ë¯¸êµ­ ì—°ë°© í–‰ì •ë¶€ì—ê²Œ í¼ë¸”ë¦­ ì˜µì…˜(ê³µê³µê±´ê°•ë³´í—˜ê¸°ê´€)ì˜ ì¡°í•­ì´ ìˆëŠ” ë°˜ë©´ ìƒì›ì˜ ê²½ìš° í•˜ì›ì•ˆì´ ì§€ë‚˜ì¹˜ê²Œ ì„¸ê¸ˆì´ ë§ì´ ë“ ë‹¤ëŠ” ì´ìœ ë¡œ í¼ë¸”ë¦­ ì˜µì…˜ ì¡°í•­ì„ ì œì™¸í•˜ê³  ë¹„ì˜ë¦¬ê±´ê°•ë³´í—˜ê¸°ê´€ì´ë‚˜ ë³´í—˜íšŒì‚¬ê°€ ë‹´ë‹¹í•˜ë„ë¡ í•œ ê²ƒì´ë‹¤. ì´ ê²½ìš°ì²˜ëŸ¼ ìƒì›ì€ í•˜ì›ì´ë‚˜ ë‚´ê°ì±…ì„ì œê°€ ë¹ ì§€ê¸° ì‰¬ìš´ êµ­ê°€ë“¤ì˜ êµ­íšŒì²˜ëŸ¼ ê±¸í•í•˜ë©´ ë°œìƒí•˜ëŠ” ì˜íšŒì˜ ë¹„ì •ìƒì ì¸ ì‚¬íƒœë¥¼ ë°©ì§€í•˜ëŠ” ê¸°ê´€ì´ë‹¤. ìƒì›ì€ ê¸‰ë°•í•œ ì²˜ë¦¬ì‚¬í•­ì˜ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ë²•ì•ˆì„ ë¨¼ì € ë‚´ëŠ” ê²½ìš°ê°€ ë“œë¬¼ê³  í•˜ì›ì´ ë§Œë“  ë²•ì•ˆì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ í•˜ì›ì— ë˜ëŒë ¤ë³´ë‚¸ë‹¤. ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ë‹¨ì›ì œê°€ ë¹ ì§€ê¸° ì‰¬ìš´ í•¨ì •ì„ ë¯¸ë¦¬ ë°©ì§€í•˜ëŠ” ê²ƒì´ë‹¤.ë‚ ì§œ=2017-02-05&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;question&#39;: &#39;ëŒ€í†µë ¹ì„ í¬í•¨í•œ ë¯¸êµ­ì˜ í–‰ì •ë¶€ ê²¬ì œê¶Œì„ ê°–ëŠ” êµ­ê°€ ê¸°ê´€ì€?&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;id&#39;: &#39;mrc-1-000067&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;answers&#39;: {&#39;answer_start&#39;: [235], &#39;text&#39;: [&#39;í•˜ì›&#39;]},</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;document_id&#39;: 18293,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> &#39;__index_level_0__&#39;: 42}</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> pandas </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> pd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> numpy </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> np</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_dictionary</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">df_input</span><span class=\"mtk1\">: pd.DataFrame):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot;pull out str `{}` values from the pandas dataframe and shape it as a new column&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_input.</span><span class=\"mtk3\">copy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># assign subject_entity and object_entity column values type as dictionary</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># df[&quot;answers&quot;] = df[&quot;answers&quot;].apply(lambda x: eval(x))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df.</span><span class=\"mtk3\">assign</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># subject_entity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">answer_start</span><span class=\"mtk8\">=</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: x[</span><span class=\"mtk6\">&quot;answers&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">apply</span><span class=\"mtk1\">(</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: x[</span><span class=\"mtk6\">&quot;answer_start&quot;</span><span class=\"mtk1\">]),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">text</span><span class=\"mtk8\">=</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: x[</span><span class=\"mtk6\">&quot;answers&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">apply</span><span class=\"mtk1\">(</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: x[</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">]),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># drop subject_entity and object_entity column</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df.</span><span class=\"mtk3\">drop</span><span class=\"mtk1\">([</span><span class=\"mtk6\">&quot;answers&quot;</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> df</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_list</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">df_input</span><span class=\"mtk1\">: pd.DataFrame):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot; pull out single item out of the list &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_input.</span><span class=\"mtk3\">copy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df[</span><span class=\"mtk6\">&quot;answer_start&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df[</span><span class=\"mtk6\">&quot;answer_start&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">apply</span><span class=\"mtk1\">(</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(x[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df[</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df[</span><span class=\"mtk6\">&quot;text&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">apply</span><span class=\"mtk1\">(</span><span class=\"mtk10\">lambda</span><span class=\"mtk1\"> </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">: x[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> df</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; Converting train and validation dataset to Pandas dataframe for convenience &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_dictionary</span><span class=\"mtk1\">(pd.DataFrame.</span><span class=\"mtk3\">from_records</span><span class=\"mtk1\">(datasets[</span><span class=\"mtk6\">&#39;train&#39;</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val_df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_dictionary</span><span class=\"mtk1\">(pd.DataFrame.</span><span class=\"mtk3\">from_records</span><span class=\"mtk1\">(datasets[</span><span class=\"mtk6\">&#39;validation&#39;</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_list</span><span class=\"mtk1\">(train_df)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val_df </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">pull_out_list</span><span class=\"mtk1\">(val_df)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(train_df.shape)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(val_df.shape)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(3952, 8)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(240, 8)</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(train_df.columns)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Index([&#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;id&#39;, &#39;document_id&#39;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       &#39;__index_level_0__&#39;, &#39;answer_start&#39;, &#39;text&#39;],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      dtype=&#39;object&#39;)</span></span></code></pre>\n<h2 id=\"load-tokenizer\" style=\"position:relative;\"><a href=\"#load-tokenizer\" aria-label=\"load tokenizer permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Load Tokenizer</h2>\n<p>Fixed: roberta not receiving sequence ids</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AutoModel, AutoTokenizer, AutoConfig</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># load tokenizer and configuration according to the model (ex: klue/roberta-large)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;roberta&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> model_args.model_name_or_path:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        model_args.model_name_or_path,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">model_input_names</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;input_ids&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;attention_mask&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">use_fast</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># use rust based tokenizer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;sequence id not used:&quot;</span><span class=\"mtk1\">, model_args.model_name_or_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    tokenizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoTokenizer.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_args.model_name_or_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(model_args.model_name_or_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">config </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoConfig.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_args.model_name_or_path)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">sequence id not used: klue/roberta-large</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># sample tokenization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tokens </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">tokenize</span><span class=\"mtk1\">(train_dataset_from_huggingface[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&#39;question&#39;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot; &quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(tokens)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;í˜„ëŒ€ ##ì  ì¸ì‚¬ ##ì¡° ##ì§ ##ê´€ë¦¬ ##ì˜ ì‹œë°œì  ##ì´ ëœ ì±… ##ì€ ?&#39;</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># test batch tokenization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://github.com/huggingface/transformers/issues/10297#issuecomment-783464293</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">sample_answer_token </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&#39;í¬ë¦¬ìŠ¤í† &#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;##í¬&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;ì•Œ&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;##í•˜ìš°ìŠ¤&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(sample_answer_token)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Wrong Example:&quot;</span><span class=\"mtk1\">, tokenizer.</span><span class=\"mtk3\">encode</span><span class=\"mtk1\">(sample_answer_token, </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">return_tensors</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;pt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">is_split_into_words</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Correctly Encoded:&quot;</span><span class=\"mtk1\"> ,torch.</span><span class=\"mtk3\">IntTensor</span><span class=\"mtk1\">([tokenizer.</span><span class=\"mtk3\">convert_tokens_to_ids</span><span class=\"mtk1\">(sample_answer_token)])) </span><span class=\"mtk5 mtki\"># apply int for torch Tensor</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[&#39;í¬ë¦¬ìŠ¤í† &#39;, &#39;##í¬&#39;, &#39;ì•Œ&#39;, &#39;##í•˜ìš°ìŠ¤&#39;]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Wrong Example: tensor([[21533,     7,     7,  1862,  1381,     7,     7,  6634]])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Correctly Encoded: tensor([[21533,  2208,  1381, 17975]], dtype=torch.int32)</span></span></code></pre>\n<h2 id=\"custom-dataset-creation-and-truncation\" style=\"position:relative;\"><a href=\"#custom-dataset-creation-and-truncation\" aria-label=\"custom dataset creation and truncation permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Custom Dataset Creation and Truncation</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_df.shape</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(3952, 8)</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># change dataframe to dictionary</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_df_dict </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> train_df.</span><span class=\"mtk3\">to_dict</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;records&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_df_dict </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> val_df.</span><span class=\"mtk3\">to_dict</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;records&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(train_df_dict[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(train_df_dict[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk3\">keys</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_df_dict))</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;title&#39;: &#39;ë¯¸êµ­ ìƒì›&#39;, &#39;context&#39;: &#39;ë¯¸êµ­ ìƒì˜ì› ë˜ëŠ” ë¯¸êµ­ ìƒì›(United States Senate)ì€ ì–‘ì›ì œì¸ ë¯¸êµ­ ì˜íšŒì˜ ìƒì›ì´ë‹¤.\\\\n\\\\në¯¸êµ­ ë¶€í†µë ¹ì´ ìƒì›ì˜ì¥ì´ ëœë‹¤. ê° ì£¼ë‹¹ 2ëª…ì˜ ìƒì›ì˜ì›ì´ ì„ ì¶œë˜ì–´ 100ëª…ì˜ ìƒì›ì˜ì›ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ì„ê¸°ëŠ” 6ë…„ì´ë©°, 2ë…„ë§ˆë‹¤ 50ê°œì£¼ ì¤‘ 1/3ì”© ìƒì›ì˜ì›ì„ ìƒˆë¡œ ì„ ì¶œí•˜ì—¬ ì—°ë°©ì— ë³´ë‚¸ë‹¤.\\\\n\\\\në¯¸êµ­ ìƒì›ì€ ë¯¸êµ­ í•˜ì›ê³¼ëŠ” ë‹¤ë¥´ê²Œ ë¯¸êµ­ ëŒ€í†µë ¹ì„ ìˆ˜ë°˜ìœ¼ë¡œ í•˜ëŠ” ë¯¸êµ­ ì—°ë°© í–‰ì •ë¶€ì— ê°ì¢… ë™ì˜ë¥¼ í•˜ëŠ” ê¸°ê´€ì´ë‹¤. í•˜ì›ì´ ì„¸ê¸ˆê³¼ ê²½ì œì— ëŒ€í•œ ê¶Œí•œ, ëŒ€í†µë ¹ì„ í¬í•¨í•œ ëŒ€ë‹¤ìˆ˜ì˜ ê³µë¬´ì›ì„ íŒŒë©´í•  ê¶Œí•œì„ ê°–ê³  ìˆëŠ” êµ­ë¯¼ì„ ëŒ€í‘œí•˜ëŠ” ê¸°ê´€ì¸ ë°˜ë©´ ìƒì›ì€ ë¯¸êµ­ì˜ ì£¼ë¥¼ ëŒ€í‘œí•œë‹¤. ì¦‰ ìº˜ë¦¬í¬ë‹ˆì•„ì£¼, ì¼ë¦¬ë…¸ì´ì£¼ ê°™ì´ ì£¼ ì •ë¶€ì™€ ì£¼ ì˜íšŒë¥¼ ëŒ€í‘œí•˜ëŠ” ê¸°ê´€ì´ë‹¤. ê·¸ë¡œ ì¸í•˜ì—¬ êµ°ëŒ€ì˜ íŒŒë³‘, ê´€ë£Œì˜ ì„ëª…ì— ëŒ€í•œ ë™ì˜, ì™¸êµ­ ì¡°ì•½ì— ëŒ€í•œ ìŠ¹ì¸ ë“± ì‹ ì†ì„ ìš”í•˜ëŠ” ê¶Œí•œì€ ëª¨ë‘ ìƒì›ì—ê²Œë§Œ ìˆë‹¤. ê·¸ë¦¬ê³  í•˜ì›ì— ëŒ€í•œ ê²¬ì œ ì—­í• (í•˜ì›ì˜ ë²•ì•ˆì„ ê±°ë¶€í•  ê¶Œí•œ ë“±)ì„ ë‹´ë‹¹í•œë‹¤. 2ë…„ì˜ ì„ê¸°ë¡œ ì¸í•˜ì—¬ ê¸‰ì§„ì ì¼ ìˆ˜ë°–ì— ì—†ëŠ” í•˜ì›ì€ ì§€ë‚˜ì¹˜ê²Œ ê¸‰ì§„ì ì¸ ë²•ì•ˆì„ ë§Œë“¤ê¸° ì‰½ë‹¤. ëŒ€í‘œì ì¸ ì˜ˆë¡œ ê±´ê°•ë³´í—˜ ê°œí˜ ë‹¹ì‹œ í•˜ì›ì´ ë¯¸êµ­ ì—°ë°© í–‰ì •ë¶€ì—ê²Œ í¼ë¸”ë¦­ ì˜µì…˜(ê³µê³µê±´ê°•ë³´í—˜ê¸°ê´€)ì˜ ì¡°í•­ì´ ìˆëŠ” ë°˜ë©´ ìƒì›ì˜ ê²½ìš° í•˜ì›ì•ˆì´ ì§€ë‚˜ì¹˜ê²Œ ì„¸ê¸ˆì´ ë§ì´ ë“ ë‹¤ëŠ” ì´ìœ ë¡œ í¼ë¸”ë¦­ ì˜µì…˜ ì¡°í•­ì„ ì œì™¸í•˜ê³  ë¹„ì˜ë¦¬ê±´ê°•ë³´í—˜ê¸°ê´€ì´ë‚˜ ë³´í—˜íšŒì‚¬ê°€ ë‹´ë‹¹í•˜ë„ë¡ í•œ ê²ƒì´ë‹¤. ì´ ê²½ìš°ì²˜ëŸ¼ ìƒì›ì€ í•˜ì›ì´ë‚˜ ë‚´ê°ì±…ì„ì œê°€ ë¹ ì§€ê¸° ì‰¬ìš´ êµ­ê°€ë“¤ì˜ êµ­íšŒì²˜ëŸ¼ ê±¸í•í•˜ë©´ ë°œìƒí•˜ëŠ” ì˜íšŒì˜ ë¹„ì •ìƒì ì¸ ì‚¬íƒœë¥¼ ë°©ì§€í•˜ëŠ” ê¸°ê´€ì´ë‹¤. ìƒì›ì€ ê¸‰ë°•í•œ ì²˜ë¦¬ì‚¬í•­ì˜ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ë²•ì•ˆì„ ë¨¼ì € ë‚´ëŠ” ê²½ìš°ê°€ ë“œë¬¼ê³  í•˜ì›ì´ ë§Œë“  ë²•ì•ˆì„ ìˆ˜ì •í•˜ì—¬ ë‹¤ì‹œ í•˜ì›ì— ë˜ëŒë ¤ë³´ë‚¸ë‹¤. ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ë‹¨ì›ì œê°€ ë¹ ì§€ê¸° ì‰¬ìš´ í•¨ì •ì„ ë¯¸ë¦¬ ë°©ì§€í•˜ëŠ” ê²ƒì´ë‹¤.ë‚ ì§œ=2017-02-05&#39;, &#39;question&#39;: &#39;ëŒ€í†µë ¹ì„ í¬í•¨í•œ ë¯¸êµ­ì˜ í–‰ì •ë¶€ ê²¬ì œê¶Œì„ ê°–ëŠ” êµ­ê°€ ê¸°ê´€ì€?&#39;, &#39;id&#39;: &#39;mrc-1-000067&#39;, &#39;document_id&#39;: 18293, &#39;__index_level_0__&#39;: 42, &#39;answer_start&#39;: 235, &#39;text&#39;: &#39;í•˜ì›&#39;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">dict_keys([&#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;id&#39;, &#39;document_id&#39;, &#39;__index_level_0__&#39;, &#39;answer_start&#39;, &#39;text&#39;])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3952</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">tokenizer.mask_token_id</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">4</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">DEBUG_MODE</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">drop_truncated_data</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">dict_df</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot; dataset creation reference: https://mccormickml.com/2021/05/27/question-answering-system-tf-idf/ &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># Lists to store the encoded samples.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    all_input_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    attention_masks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    start_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    end_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    num_dropped </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> num, item </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(dict_df):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        answer_tokens </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">tokenize</span><span class=\"mtk1\">(item[</span><span class=\"mtk6\">&#39;text&#39;</span><span class=\"mtk1\">], </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        sentinel_str </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot; &quot;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">([tokenizer.mask_token]</span><span class=\"mtk8\">*len</span><span class=\"mtk1\">(answer_tokens))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_char_i </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> item[</span><span class=\"mtk6\">&#39;answer_start&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_char_i </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_char_i </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(item[</span><span class=\"mtk6\">&#39;text&#39;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        context_w_sentinel </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            item[</span><span class=\"mtk6\">&#39;context&#39;</span><span class=\"mtk1\">][:start_char_i] \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> sentinel_str \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> item[</span><span class=\"mtk6\">&#39;context&#39;</span><span class=\"mtk1\">][end_char_i:]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        encoded_dict </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">encode_plus</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            item[</span><span class=\"mtk6\">&#39;question&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            context_w_sentinel,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">add_special_tokens</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">max_length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model_args.max_seq_length,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">padding</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;max_length&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">return_attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">return_tensors</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;pt&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">truncation</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        input_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> encoded_dict[</span><span class=\"mtk6\">&#39;input_ids&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        is_mask_token </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (input_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> tokenizer.mask_token_id)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mask_token_indeces </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> is_mask_token.</span><span class=\"mtk3\">nonzero</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">as_tuple</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)[:, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk10\">not</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(mask_token_indeces) </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(answer_tokens):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            num_dropped </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">continue</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_index </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> mask_token_indeces[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_index </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> mask_token_indeces[</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># change start_index tensor and end_index tensor into integer type</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_index </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_index.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_index </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_index.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        answer_token_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> tokenizer.</span><span class=\"mtk3\">convert_tokens_to_ids</span><span class=\"mtk1\">(answer_tokens)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        input_ids[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, start_index : end_index </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">tensor</span><span class=\"mtk1\">(answer_token_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        all_input_ids.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(input_ids)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        attention_masks.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(encoded_dict[</span><span class=\"mtk6\">&#39;attention_mask&#39;</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_positions.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(start_index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_positions.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(end_index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># Convert the lists of tensors into 2D tensors.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    all_input_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">cat</span><span class=\"mtk1\">(all_input_ids, </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    attention_masks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">cat</span><span class=\"mtk1\">(attention_masks, </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># Convert the &quot;labels&quot; (the start and end indeces) into tensors.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    start_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">tensor</span><span class=\"mtk1\">(start_positions)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    end_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">tensor</span><span class=\"mtk1\">(end_positions)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> all_input_ids, attention_masks, start_positions, end_positions</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> DataLoader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_truncated </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">drop_truncated_data</span><span class=\"mtk1\">(train_df_dict)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">TensorDataset</span><span class=\"mtk1\">(train_truncated[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], train_truncated[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], train_truncated[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], train_truncated[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_dataloader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(train_dataset, </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk1\">model_args.batch_size, </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_truncated </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">drop_truncated_data</span><span class=\"mtk1\">(valid_df_dict)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">TensorDataset</span><span class=\"mtk1\">(valid_truncated[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">], valid_truncated[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">], valid_truncated[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">], valid_truncated[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_dataloader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(valid_dataset, </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk1\">model_args.batch_size, </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(train_df.shape)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_dataset)) </span><span class=\"mtk5 mtki\"># number of clipped samples where answers are located out of the maximum sequence length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(val_df.shape)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">len</span><span class=\"mtk1\">(valid_dataset) </span><span class=\"mtk5 mtki\"># number of clipped samples where answers are located out of the maximum sequence length</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(3952, 8)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">3706</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">(240, 8)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">220</span></span></code></pre>\n<h2 id=\"define-losses-to-use\" style=\"position:relative;\"><a href=\"#define-losses-to-use\" aria-label=\"define losses to use permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Define Losses to use</h2>\n<ul>\n<li>CrossEntropyLoss provided by torch.nn was the best</li>\n<li>For Performance Comparison, Please refer to <a href=\"https://wandb.ai/happyface-boostcamp/KLUE-QA?workspace=user-snoop2head\">ğŸ”— wandb</a></li>\n</ul>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn.functional </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> F</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.autograd </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> Variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FocalLoss</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># https://github.com/clcarwin/focal_loss_pytorch/blob/master/focalloss.py</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">gamma</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0.5</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">alpha</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">size_average</span><span class=\"mtk1\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">(FocalLoss, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">).</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> gamma</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> alpha</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">isinstance</span><span class=\"mtk1\">(alpha, (</span><span class=\"mtk8\">float</span><span class=\"mtk1\">, </span><span class=\"mtk8\">int</span><span class=\"mtk1\">)):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">Tensor</span><span class=\"mtk1\">([alpha, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> alpha])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">isinstance</span><span class=\"mtk1\">(alpha, </span><span class=\"mtk8\">list</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">Tensor</span><span class=\"mtk1\">(alpha)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.size_average </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> size_average</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">input</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">target</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">dim</span><span class=\"mtk1\">() </span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">input</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">view</span><span class=\"mtk1\">(</span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># N,C,H,W =&gt; N,C,H*W</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">input</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">transpose</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># N,C,H*W =&gt; N,H*W,C</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">input</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">contiguous</span><span class=\"mtk1\">().</span><span class=\"mtk3\">view</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">))  </span><span class=\"mtk5 mtki\"># N,H*W,C =&gt; N*H*W,C</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        target </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> target.</span><span class=\"mtk3\">view</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        logpt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">log_softmax</span><span class=\"mtk1\">(</span><span class=\"mtk8\">input</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        logpt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> logpt.</span><span class=\"mtk3\">gather</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, target)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        logpt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> logpt.</span><span class=\"mtk3\">view</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Variable</span><span class=\"mtk1\">(logpt.data.</span><span class=\"mtk3\">exp</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha </span><span class=\"mtk10\">is</span><span class=\"mtk1\"> </span><span class=\"mtk10\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">None</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha.</span><span class=\"mtk3\">type</span><span class=\"mtk1\">() </span><span class=\"mtk8\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">input</span><span class=\"mtk1\">.data.</span><span class=\"mtk3\">type</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha.</span><span class=\"mtk3\">type_as</span><span class=\"mtk1\">(</span><span class=\"mtk8\">input</span><span class=\"mtk1\">.data)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            at </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.alpha.</span><span class=\"mtk3\">gather</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, target.data.</span><span class=\"mtk3\">view</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            logpt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> logpt </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Variable</span><span class=\"mtk1\">(at)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> pt) </span><span class=\"mtk8\">**</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> logpt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.size_average:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> loss.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> loss.</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn.functional </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> F</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.nn.modules.loss </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> _WeightedLoss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LabelSmoothCrossEntropyLoss</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_WeightedLoss</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># https://github.com/NingAnMe/Label-Smoothing-for-CrossEntropyLoss-PyTorch/blob/main/label_smothing_cross_entropy_loss.py</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">weight</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">reduction</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&#39;mean&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">smoothing</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">().</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">weight</span><span class=\"mtk8\">=</span><span class=\"mtk1\">weight, </span><span class=\"mtk4 mtki\">reduction</span><span class=\"mtk8\">=</span><span class=\"mtk1\">reduction)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.smoothing </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> smoothing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> weight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> reduction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    @</span><span class=\"mtk8\">staticmethod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">_smooth_one_hot</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">targets</span><span class=\"mtk1\">: torch.Tensor, </span><span class=\"mtk7 mtki\">n_classes</span><span class=\"mtk1\">: </span><span class=\"mtk8\">int</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">smoothing</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">assert</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&lt;=</span><span class=\"mtk1\"> smoothing </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">no_grad</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            targets </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">empty</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">size</span><span class=\"mtk8\">=</span><span class=\"mtk1\">(targets.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), n_classes),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                                  </span><span class=\"mtk4 mtki\">device</span><span class=\"mtk8\">=</span><span class=\"mtk1\">targets.device) \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                .</span><span class=\"mtk3\">fill_</span><span class=\"mtk1\">(smoothing </span><span class=\"mtk8\">/</span><span class=\"mtk1\"> (n_classes </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)) \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                .</span><span class=\"mtk3\">scatter_</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, targets.data.</span><span class=\"mtk3\">unsqueeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">. </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> smoothing)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> targets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">inputs</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">targets</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        targets </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> LabelSmoothCrossEntropyLoss.</span><span class=\"mtk3\">_smooth_one_hot</span><span class=\"mtk1\">(targets, inputs.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                                                              </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.smoothing)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        lsm </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">log_softmax</span><span class=\"mtk1\">(inputs, </span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight </span><span class=\"mtk10\">is</span><span class=\"mtk1\"> </span><span class=\"mtk10\">not</span><span class=\"mtk1\"> </span><span class=\"mtk7\">None</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            lsm </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> lsm </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight.</span><span class=\"mtk3\">unsqueeze</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk1\">(targets </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> lsm).</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;sum&#39;</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> loss.</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">elif</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;mean&#39;</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> loss.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> loss</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://github.com/cvqluu/Angular-Penalty-Softmax-Losses-Pytorch -&gt; doesn&#39;t work, full of bugs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://github.com/ronghuaiyang/arcface-pytorch/blob/master/models/metrics.py -&gt; fail</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://github.com/CoinCheung/pytorch-loss/blob/master/dice_loss.py -&gt; Not working</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://github.com/ShannonAI/dice_loss_for_NLP/blob/master/loss/dice_loss.py -&gt; Loss too big: 300 or more</span></span></span></code></pre>\n<h2 id=\"load-model\" style=\"position:relative;\"><a href=\"#load-model\" aria-label=\"load model permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Load Model</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_args.</span><span class=\"mtk7\">DEBUG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">device </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">device</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;cuda:0&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> torch.cuda.</span><span class=\"mtk3\">is_available</span><span class=\"mtk1\">() </span><span class=\"mtk10 mtki\">and</span><span class=\"mtk1\"> model_args.</span><span class=\"mtk7\">DEBUG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">False</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;cpu&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">!</span><span class=\"mtk1\">nvidia</span><span class=\"mtk8\">-</span><span class=\"mtk1\">smi</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">cuda:0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Tue Nov  2 07:16:46 2021</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| NVIDIA-SMI 450.80.02    Driver Version: 450.80.02    CUDA Version: 11.0     |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |               MIG M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|===============================+======================+======================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|   0  Tesla V100-PCIE...  Off  | 00000000:00:05.0 Off |                  Off |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| N/A   34C    P0    36W / 250W |      4MiB / 32510MiB |      0%      Default |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |                  N/A |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Processes:                                                                  |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|        ID   ID                                                   Usage      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|=============================================================================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|  No running processes found                                                 |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AutoModelForQuestionAnswering, AutoConfig</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; default model, but not using this one &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> model_args.</span><span class=\"mtk7\">DEBUG</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    model_config </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoConfig.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(model_args.model_name_or_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoModelForQuestionAnswering.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        model_args.model_name_or_path,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4 mtki\">config</span><span class=\"mtk8\">=</span><span class=\"mtk1\">model_config,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span></code></pre>\n<p><img src=\"https://discuss.pytorch.org/uploads/default/original/2X/e/e7496a33d835f085d800ee17c0ade05895a89551.png\" alt=\"img\"></p>\n<ul>\n<li>t: length of passage (or input text)</li>\n<li>depth: number of rnn layers</li>\n</ul>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn.functional </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> F</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AutoModel, AutoConfig, AutoModelForQuestionAnswering</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.cuda.amp </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> autocast</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">&quot;&quot;&quot; Reference: https://github.com/snexus/nlp-question-answering-system/blob/main/model.py &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">QAModel</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">&quot;&quot;&quot; Custom Question Answering Model with Bidirectionaal LSTM head attached &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">MODEL_NAME</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">dropout_proba</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0.1</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">().</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model_config</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoConfig.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span><span class=\"mtk7\">MODEL_NAME</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.transformer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> AutoModel.</span><span class=\"mtk3\">from_pretrained</span><span class=\"mtk1\">(</span><span class=\"mtk7\">MODEL_NAME</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">config</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model_config)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.embed_dim </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model_config.hidden_size </span><span class=\"mtk5 mtki\"># roberta hidden dim = 1024</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\">#self.device=&quot;cuda&quot; if torch.cuda.is_available else &quot;cpu&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># We replace the head with lstm layer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.lstm</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">LSTM</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">input_size</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.embed_dim,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">hidden_size</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.embed_dim,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">num_layers</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model_args.num_rnn_layers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">dropout</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">batch_first</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">bidirectional</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">True</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.qa_head </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">in_features</span><span class=\"mtk8\">=</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.embed_dim</span><span class=\"mtk8\">*</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">out_features</span><span class=\"mtk8\">=</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">bias</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.dropout </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Dropout</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">p</span><span class=\"mtk8\">=</span><span class=\"mtk1\">dropout_proba)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">input_ids</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">attention_mask</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">start_positions</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">end_positions</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Forward step for the question-answering model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        ----------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        input_enc - encoding dictionary from the tokenizer.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        Returns</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        -------</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        start_logits - logit corresponding to the start position of the answer (batch_size, sentence_size, 1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        start_positions - true start position (batch_size, 1) or None</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        end_logits - logit corresponding to the end position of the answer (batch_size, sentence_size, 1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        end_positions - ture end position (batch_size, 1) or None</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        trans_out </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">transformer</span><span class=\"mtk1\">(input_ids, </span><span class=\"mtk4 mtki\">attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">attention_mask)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hidden_state </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> trans_out.last_hidden_state  </span><span class=\"mtk5 mtki\"># (batch_size, len_sentence, embed_dim)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        hidden_out, (last_hidden, last_cell) </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">lstm</span><span class=\"mtk1\">(hidden_state)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># Pass through the linear layer, we need to learn it&#39;s parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        final_output </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">qa_head</span><span class=\"mtk1\">(hidden_out)  </span><span class=\"mtk5 mtki\"># (batch_size, len_sentence, 2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_logits, end_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> final_output.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_logits.</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)  </span><span class=\"mtk5 mtki\"># (bs, max_query_len)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_logits.</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk6\">&quot;start_logits&quot;</span><span class=\"mtk1\">: start_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk6\">&quot;start_positions&quot;</span><span class=\"mtk1\">: start_positions,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk6\">&quot;end_logits&quot;</span><span class=\"mtk1\">: end_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk6\">&quot;end_positions&quot;</span><span class=\"mtk1\">: end_positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">compute_loss</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">start_logits</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">start_positions</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">end_logits</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">end_positions</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">return_outputs</span><span class=\"mtk1\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(start_positions.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">()) </span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            start_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_positions.</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(end_positions.</span><span class=\"mtk3\">size</span><span class=\"mtk1\">()) </span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            end_positions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_positions.</span><span class=\"mtk3\">squeeze</span><span class=\"mtk1\">(</span><span class=\"mtk8\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_loss_fct, end_loss_fct </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">CrossEntropyLoss</span><span class=\"mtk1\">(), nn.</span><span class=\"mtk3\">CrossEntropyLoss</span><span class=\"mtk1\">() </span><span class=\"mtk5 mtki\"># -&gt; so far the best performance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># start_loss_fct, end_loss_fct = FocalLoss(gamma=model_args.gamma), FocalLoss(gamma=model_args.gamma)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># start_loss_fct, end_loss_fct = LabelSmoothCrossEntropyLoss(smoothing=model_args.smoothing), LabelSmoothCrossEntropyLoss(smoothing=model_args.smoothing)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">start_loss_fct</span><span class=\"mtk1\">(start_logits, start_positions)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">end_loss_fct</span><span class=\"mtk1\">(end_logits, end_positions)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (start_loss </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> end_loss) </span><span class=\"mtk8\">/</span><span class=\"mtk1\"> </span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> (total_loss, outputs) </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> return_outputs </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\"> total_loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">QAModel</span><span class=\"mtk1\">(model_args.model_name_or_path)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Some weights of the model checkpoint at klue/roberta-large were not used when initializing RobertaModel: [&#39;lm_head.layer_norm.weight&#39;, &#39;lm_head.layer_norm.bias&#39;, &#39;lm_head.decoder.weight&#39;, &#39;lm_head.dense.weight&#39;, &#39;lm_head.bias&#39;, &#39;lm_head.decoder.bias&#39;, &#39;lm_head.dense.bias&#39;]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">- This IS expected if you are initializing RobertaModel from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">- This IS NOT expected if you are initializing RobertaModel from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Some weights of RobertaModel were not initialized from the model checkpoint at klue/roberta-large and are newly initialized: [&#39;roberta.pooler.dense.weight&#39;, &#39;roberta.pooler.dense.bias&#39;]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model.</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">!</span><span class=\"mtk1\">nvidia</span><span class=\"mtk8\">-</span><span class=\"mtk1\">smi</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Tue Nov  2 07:16:58 2021</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| NVIDIA-SMI 450.80.02    Driver Version: 450.80.02    CUDA Version: 11.0     |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |               MIG M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|===============================+======================+======================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|   0  Tesla V100-PCIE...  Off  | 00000000:00:05.0 Off |                  Off |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| N/A   34C    P0    36W / 250W |   2931MiB / 32510MiB |      2%      Default |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |                  N/A |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Processes:                                                                  |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|        ID   ID                                                   Usage      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|=============================================================================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span></code></pre>\n<h2 id=\"define-optimizer-and-scheduler\" style=\"position:relative;\"><a href=\"#define-optimizer-and-scheduler\" aria-label=\"define optimizer and scheduler permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Define Optimizer and Scheduler</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> AdamW</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># from adamp import AdamP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">optimizer </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">AdamW</span><span class=\"mtk1\">(model.</span><span class=\"mtk3\">parameters</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4 mtki\">lr</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model_args.learning_rate, </span><span class=\"mtk5 mtki\"># args.learning_rate - default is 5e-5</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                  </span><span class=\"mtk4 mtki\">eps</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1e-8</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># args.adam_epsilon  - default is 1e-8.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> get_linear_schedule_with_warmup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> transformers </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> get_cosine_schedule_with_warmup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">epochs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model_args.num_train_epochs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">total_steps </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_dataloader) </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> epochs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">scheduler </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">get_linear_schedule_with_warmup</span><span class=\"mtk1\">(optimizer,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                                            </span><span class=\"mtk4 mtki\">num_warmup_steps</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                                            </span><span class=\"mtk4 mtki\">num_training_steps</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> total_steps)</span></span></span></code></pre>\n<h2 id=\"training\" style=\"position:relative;\"><a href=\"#training\" aria-label=\"training permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Training</h2>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Metrics</span><span class=\"mtk1\">(</span><span class=\"mtk8\">object</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reset</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.val </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.avg </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">update</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">val</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">n</span><span class=\"mtk1\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.val </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> val</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> val </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> n</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> n</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.avg </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.sum </span><span class=\"mtk8\">/</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.count</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">name_of_experiment</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&#39;lstm-trainer-AdamW-CE-num_rnn_layers-2-no-clip&#39;</span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> wandb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> random</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> numpy </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> np</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> tqdm.auto </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> tqdm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> wandb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">seed_val </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">42</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">random.</span><span class=\"mtk3\">seed</span><span class=\"mtk1\">(seed_val)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">np.random.</span><span class=\"mtk3\">seed</span><span class=\"mtk1\">(seed_val)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">torch.</span><span class=\"mtk3\">manual_seed</span><span class=\"mtk1\">(seed_val)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">torch.cuda.</span><span class=\"mtk3\">manual_seed_all</span><span class=\"mtk1\">(seed_val)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">training_stats </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># https://wandb.ai/happyface-boostcamp/KLUE-QA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(name_of_experiment)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">wandb.</span><span class=\"mtk3\">init</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\">project</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;KLUE-QA&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\">entity</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;happyface-boostcamp&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\">name</span><span class=\"mtk8\">=</span><span class=\"mtk1\">name_of_experiment,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\">config</span><span class=\"mtk8\">=</span><span class=\"mtk1\">model_args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">fold_num </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">best_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># Initialize using Metrics</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">train_acc, train_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">(), </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dev_acc, dev_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">(), </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dev_start_acc, dev_end_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">(), </span><span class=\"mtk3\">Metrics</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> epoch_i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, epochs):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;======== Epoch </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> / </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> ========&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(epoch_i </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, epochs))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Training </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:,</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> batches...&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_dataloader)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># change the model to train mode</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    model.</span><span class=\"mtk3\">train</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    num_batches </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_dataloader)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># For each batch of training data...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> step, batch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(</span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(train_dataloader)):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># get info from batch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        b_input_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        b_input_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        b_start_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        b_end_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># get outputs from the model</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        model.</span><span class=\"mtk3\">zero_grad</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        outputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            b_input_ids,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_input_mask,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">start_positions</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_start_pos,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">end_positions</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_end_pos,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># get logits(probability) and loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        start_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;start_logits&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        end_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;end_logits&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model.</span><span class=\"mtk3\">compute_loss</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">start_logits</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">start_positions</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;start_positions&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">end_logits</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">end_positions</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;end_positions&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># record train loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        train_loss.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">(loss.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(b_input_ids))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># backward propagation &amp; optimizer stepping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        loss.</span><span class=\"mtk3\">backward</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        optimizer.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        scheduler.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># EVALUATE every 100 steps</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> step </span><span class=\"mtk8\">!=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk10\">and</span><span class=\"mtk1\"> step </span><span class=\"mtk8\">%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Epoch: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(epoch_i</span><span class=\"mtk8\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, model_args.num_train_epochs), </span><span class=\"mtk6\">&#39;Step: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(step), </span><span class=\"mtk6\">&#39;Train Loss: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(train_loss.avg))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Running Validation...&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># initialize prediction and labels for future accuracy calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            pred_start, pred_end, true_start, true_end </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [], [], [], []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># Evaluate data for one epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> batch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(valid_dataloader):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># get info from batch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_input_ids </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_input_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_start_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_end_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> batch[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">].</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># Evaluate and get outputs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># model.eval() # lstm does not accept model.eval()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">no_grad</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    outputs </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        b_input_ids,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk5 mtki\"># token_type_ids=b_seg_ids,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk4 mtki\">attention_mask</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_input_mask,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk4 mtki\">start_positions</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_start_pos,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk4 mtki\">end_positions</span><span class=\"mtk8\">=</span><span class=\"mtk1\">b_end_pos,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># get logits(probability) and loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                start_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;start_logits&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                end_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;end_logits&#39;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> model.</span><span class=\"mtk3\">compute_loss</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">start_logits</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">start_positions</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;start_positions&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">end_logits</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_logits,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">end_positions</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> outputs[</span><span class=\"mtk6\">&#39;end_positions&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># record evaluation loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                dev_loss.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">(loss.</span><span class=\"mtk3\">item</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(b_input_ids))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># get logits and predictions for evaluation accuracy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                start_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> start_logits.</span><span class=\"mtk3\">detach</span><span class=\"mtk1\">().</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">().</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                end_logits </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> end_logits.</span><span class=\"mtk3\">detach</span><span class=\"mtk1\">().</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">().</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_start_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> b_start_pos.</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;cpu&#39;</span><span class=\"mtk1\">).</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                b_end_pos </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> b_end_pos.</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;cpu&#39;</span><span class=\"mtk1\">).</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                answer_start </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">argmax</span><span class=\"mtk1\">(start_logits, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                answer_end </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">argmax</span><span class=\"mtk1\">(end_logits, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk5 mtki\"># append the prediction and ground truth to the list for comparison</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                pred_start.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(answer_start)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                pred_end.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(answer_end)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                true_start.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(b_start_pos)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                true_end.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(b_end_pos)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># compare start for accuracy calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            pred_start </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">concatenate</span><span class=\"mtk1\">(pred_start, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            true_start </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">concatenate</span><span class=\"mtk1\">(true_start, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            num_start_correct </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">(pred_start </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_start)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_start_acc.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">((pred_start </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_start).</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(true_start))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># compare end for accuracy calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            pred_end </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">concatenate</span><span class=\"mtk1\">(pred_end, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            true_end </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">concatenate</span><span class=\"mtk1\">(true_end, </span><span class=\"mtk4 mtki\">axis</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            num_end_correct </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">sum</span><span class=\"mtk1\">(pred_end </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_end)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_end_acc.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">((pred_end </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_end).</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(true_end))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># compare both start and end for EM accuracy calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            total_correct </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> num_start_correct </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> num_end_correct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            total_indeces </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(true_start) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(true_end)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># get both cases where pred_start == true_start and pred_end == true_end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            both_correct </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">(np.</span><span class=\"mtk3\">logical_and</span><span class=\"mtk1\">(pred_start </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_start, pred_end </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> true_end))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_acc.</span><span class=\"mtk3\">update</span><span class=\"mtk1\">(both_correct, </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(b_input_ids))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># Report the final accuracy for this validation run.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Epoch: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(epoch_i</span><span class=\"mtk8\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, epochs), </span><span class=\"mtk6\">&#39;Step: </span><span class=\"mtk7\">{}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(step), </span><span class=\"mtk6\">&#39;Dev Loss: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(dev_loss.avg), </span><span class=\"mtk6\">&#39;Dev Acc: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(dev_acc.avg))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># log on wandb</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            wandb.</span><span class=\"mtk3\">log</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;train/loss&#39;</span><span class=\"mtk1\">: train_loss.avg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;train/learning_rate&#39;</span><span class=\"mtk1\">:optimizer.param_groups[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&#39;lr&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;eval/loss&#39;</span><span class=\"mtk1\">: dev_loss.avg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;eval/accuracy&#39;</span><span class=\"mtk1\">:dev_acc.avg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;eval/start_accuracy&#39;</span><span class=\"mtk1\">:dev_start_acc.avg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk6\">&#39;eval/end_accuracy&#39;</span><span class=\"mtk1\">:dev_end_acc.avg,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># save the best model based on EM accuracy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> best_acc </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\"> dev_acc.avg:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                best_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> dev_acc.avg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                torch.</span><span class=\"mtk3\">save</span><span class=\"mtk1\">(model.</span><span class=\"mtk3\">state_dict</span><span class=\"mtk1\">(), </span><span class=\"mtk6\">&#39;./results/</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">-fold-</span><span class=\"mtk7\">{}</span><span class=\"mtk6\">-best-acc-model.pt&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(fold_num</span><span class=\"mtk8\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, model_args.num_folds))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;Saved model with highest EM accuracy: </span><span class=\"mtk7\">{</span><span class=\"mtk10\">:.4f</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">.</span><span class=\"mtk3\">format</span><span class=\"mtk1\">(best_acc))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                wandb.</span><span class=\"mtk3\">log</span><span class=\"mtk1\">({</span><span class=\"mtk6\">&#39;best_acc&#39;</span><span class=\"mtk1\">:best_acc})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk5 mtki\"># reset metrics</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            train_loss.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_loss.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_acc.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_start_acc.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            dev_end_acc.</span><span class=\"mtk3\">reset</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Training complete!&quot;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Failed to detect the name of this notebook, you can set it manually with the WANDB_NOTEBOOK_NAME environment variable to enable code saving.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">lstm-trainer-AdamW-CE-num_rnn_layers-2-no-clip</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\u001b[34m\u001b[1mwandb\u001b[0m: Currently logged in as: \u001b[33msnoop2head\u001b[0m (use `wandb login --relogin` to force relogin)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\u001b[34m\u001b[1mwandb\u001b[0m: wandb version 0.12.6 is available!  To upgrade, please run:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\u001b[34m\u001b[1mwandb\u001b[0m:  $ pip install wandb --upgrade</span></span></code></pre>\n<p>Syncing run <strong><a href=\"https://wandb.ai/happyface-boostcamp/KLUE-QA/runs/v9a69h0d\" target=\"_blank\">lstm-trainer-AdamW-CE-num<em>rnn</em>layers-2-no-clip</a></strong> to <a href=\"https://wandb.ai/happyface-boostcamp/KLUE-QA\" target=\"_blank\">Weights &#x26; Biases</a> (<a href=\"https://docs.wandb.com/integrations/jupyter.html\" target=\"_blank\">docs</a>).<br/></p>\n<p> ======== Epoch 1 / 3 ========\nâ€‹ Training 371 batches...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=371.0), HTML(value=&#39;&#39;)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 1/3 Step: 100 Train Loss: 3.1070</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Validation...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 1/3 Step: 100 Dev Loss: 1.6518 Dev Acc: 0.4455\nâ€‹ Saved model with highest EM accuracy: 0.4455\nâ€‹ Epoch: 1/3 Step: 200 Train Loss: 0.8847\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 1/3 Step: 200 Dev Loss: 0.8757 Dev Acc: 0.7364\nâ€‹ Saved model with highest EM accuracy: 0.7364\nâ€‹ Epoch: 1/3 Step: 300 Train Loss: 0.6086\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 1/3 Step: 300 Dev Loss: 0.6843 Dev Acc: 0.7591\nâ€‹ Saved model with highest EM accuracy: 0.7591</p>\n<p> ======== Epoch 2 / 3 ========\nâ€‹ Training 371 batches...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=371.0), HTML(value=&#39;&#39;)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 2/3 Step: 100 Train Loss: 0.3378</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Validation...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 2/3 Step: 100 Dev Loss: 0.5934 Dev Acc: 0.7864\nâ€‹ Saved model with highest EM accuracy: 0.7864\nâ€‹ Epoch: 2/3 Step: 200 Train Loss: 0.2142\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 2/3 Step: 200 Dev Loss: 0.6438 Dev Acc: 0.7773\nâ€‹ Epoch: 2/3 Step: 300 Train Loss: 0.2250\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 2/3 Step: 300 Dev Loss: 0.5673 Dev Acc: 0.7909\nâ€‹ Saved model with highest EM accuracy: 0.7909</p>\n<p> ======== Epoch 3 / 3 ========\nâ€‹ Training 371 batches...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=371.0), HTML(value=&#39;&#39;)))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Epoch: 3/3 Step: 100 Train Loss: 0.1450</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running Validation...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 3/3 Step: 100 Dev Loss: 0.4982 Dev Acc: 0.8409\nâ€‹ Saved model with highest EM accuracy: 0.8409\nâ€‹ Epoch: 3/3 Step: 200 Train Loss: 0.0798\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 3/3 Step: 200 Dev Loss: 0.5151 Dev Acc: 0.8227\nâ€‹ Epoch: 3/3 Step: 300 Train Loss: 0.0685\nâ€‹ Running Validation...</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">HBox(children=(FloatProgress(value=0.0, max=22.0), HTML(value=&#39;&#39;)))</span></span></code></pre>\n<p> Epoch: 3/3 Step: 300 Dev Loss: 0.5888 Dev Acc: 0.7955</p>\n<p> Training complete!</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk9\">!</span><span class=\"mtk1\">nvidia</span><span class=\"mtk8\">-</span><span class=\"mtk1\">smi</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Tue Nov  2 07:44:26 2021</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| NVIDIA-SMI 450.80.02    Driver Version: 450.80.02    CUDA Version: 11.0     |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |               MIG M. |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|===============================+======================+======================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|   0  Tesla V100-PCIE...  Off  | 00000000:00:05.0 Off |                  Off |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| N/A   57C    P0    50W / 250W |  29163MiB / 32510MiB |      0%      Default |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|                               |                      |                  N/A |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-------------------------------+----------------------+----------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">| Processes:                                                                  |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|        ID   ID                                                   Usage      |</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">|=============================================================================|</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+-----------------------------------------------------------------------------+</span></span></code></pre>\n<pre><code class=\"language-python\"></code></pre>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .one-dark-pro {\n    background-color: #282c34;\n    color: #abb2bf;\n  }\n  .one-dark-pro .mtki { font-style: italic; }\n  .one-dark-pro .mtk10 { color: #C678DD; }\n  .one-dark-pro .mtk1 { color: #ABB2BF; }\n  .one-dark-pro .mtk6 { color: #98C379; }\n  .one-dark-pro .mtk8 { color: #56B6C2; }\n  .one-dark-pro .mtk11 { color: #E5C07B; }\n  .one-dark-pro .mtk5 { color: #7F848E; }\n  .one-dark-pro .mtk7 { color: #D19A66; }\n  .one-dark-pro .mtk3 { color: #61AFEF; }\n  .one-dark-pro .mtk4 { color: #E06C75; }\n  .one-dark-pro .mtk9 { color: #FFFFFF; }\n  .one-dark-pro .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","tableOfContents":"<ul>\n<li>\n<p><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#retrieval\">Retrieval</a></p>\n<ul>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#1-sparse-retrieval\">1) Sparse Retrieval</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#2-dense-retrieval\">2) Dense Retrieval</a></li>\n</ul>\n</li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#reader\">Reader</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#load-dataset\">Load Dataset</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#make-custom-dataset\">Make Custom Dataset</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#load-tokenizer\">Load Tokenizer</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#custom-dataset-creation-and-truncation\">Custom Dataset Creation and Truncation</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#define-losses-to-use\">Define Losses to use</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#load-model\">Load Model</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#define-optimizer-and-scheduler\">Define Optimizer and Scheduler</a></li>\n<li><a href=\"/DL&#x26;ML/Custom-MRC-Reader/#training\">Training</a></li>\n</ul>","frontmatter":{"date":"2021-11-04","title":"Customizing Question Answering Reader Model","tags":["NLP","MRC","Competition"]}}},"pageContext":{"slug":"/DL&ML/Custom-MRC-Reader/","previous":{"fields":{"slug":"/DL&ML/Dacon-Result/"},"frontmatter":{"title":"Assessment on the Daconâ€™s Stock Price Prediction Competition"}},"next":{"fields":{"slug":"/CS/Python-language-structure/"},"frontmatter":{"title":"Python Language Structure"}}}},"staticQueryHashes":["1081905842","3911196313"]}