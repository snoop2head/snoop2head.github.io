{"componentChunkName":"component---src-templates-blog-post-js","path":"/DL&ML/Mask-Age-Gender-Classification-Competition/","result":{"data":{"site":{"siteMetadata":{"author":"Young Jin Ahn","comment":{"utterances":"snoop2head/snoop2head.github.io"},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"excerpt":"Result âœ¨ Individual Rank: 32nd / 250 participants ðŸ¥‰ Team Rank: 11th / 38 teams Task Description Competition participants should identify 18 classes correctly and competition grading criteria is basedâ€¦","html":"<h2 id=\"result\" style=\"position:relative;\"><a href=\"#result\" aria-label=\"result permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Result</h2>\n<ul>\n<li>âœ¨ Individual Rank: 32nd / 250 participants</li>\n<li>ðŸ¥‰ Team Rank: 11th / 38 teams</li>\n</ul>\n<h2 id=\"task-description\" style=\"position:relative;\"><a href=\"#task-description\" aria-label=\"task description permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Task Description</h2>\n<p><strong>Competition participants should identify 18 classes correctly and competition grading criteria is based on F1 Score.</strong></p>\n<p>Goal is to classify Age Range, Biological Sex, Face Mask</p>\n<ul>\n<li>There are 3 classes for the Age Range: Lower than 30, Between 30 and 59, Above 60.</li>\n<li>Biological Sex class is consisted of 2 classes which are Male and Female.</li>\n<li>Thera are 3 classes for Face Mask which are: Wear, Incorrectly Wear, Not wear.</li>\n</ul>\n<h2 id=\"development-environment-settings\" style=\"position:relative;\"><a href=\"#development-environment-settings\" aria-label=\"development environment settings permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Development Environment Settings</h2>\n<ul>\n<li>\n<p><strong>Had consistent CUDA error on Upstage server which remained unsolved until the end.</strong></p>\n<ul>\n<li>This was <a href=\"https://nbviewer.jupyter.org/github/snoop2head/debugging-practice/blob/main/baseline_mask_cpu.ipynb\">CNN Model that works on CPU Device on provided Upstage server</a>.</li>\n<li>But 4 types of error arose when the same model &#x26; code was run on GPU Device. Sometimes the error occurred on fully connected layer(fc1), but other times the error occurred on convolutional layer(conv2).</li>\n<li>ðŸ”— <a href=\"https://github.com/snoop2head/debugging-practice/blob/main/baseline_mask_gpu_ILLEGAL.ipynb\">CUDA error: an illegal instruction</a></li>\n<li>ðŸ”— <a href=\"https://github.com/snoop2head/debugging-practice/blob/main/baseline_mask_gpu_CUBLAS_STATUS_ALLOC_FAILED.ipynb\">CUBLAS<em>STATUS</em>ALLOC_FAILED</a></li>\n<li>ðŸ”— <a href=\"https://github.com/snoop2head/debugging-practice/blob/main/baseline_mask_gpu_CUDNN_STATUS_MAPPING_ERROR.ipynb\">CUDNN<em>STATUS</em>MAPPING_ERROR</a></li>\n<li>ðŸ”— <a href=\"https://github.com/snoop2head/debugging-practice/blob/main/baseline_mask_gpu_CUBLAS_STATUS_EXECUTION_FAILED.ipynb\">CUBLAS<em>STATUS</em>EXECUTION_FAILED</a></li>\n<li>After debugging for two days, I decided to proceed the competition on Colab Pro + account.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"choosing-and-comparing-model\" style=\"position:relative;\"><a href=\"#choosing-and-comparing-model\" aria-label=\"choosing and comparing model permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choosing and Comparing Model</h2>\n<ul>\n<li>I focused on my role to provide backbone code that could be experimented by other teammates.</li>\n<li>Thus minimum amount of albumentation/transformation was applied, whereas different types of models were alternated one by one.</li>\n<li>From torchvision library and timm library, model performance SOTA models were compared for the competition's dataset.</li>\n<li>It is proved that tf<em>efficientnet</em>b4 from the timm library was the most adaquate model for the competition.</li>\n<li>For the comparison purpose, the hyperparameters, optimizers, train vs valid split ratio were not differentiated according to the models.</li>\n<li><strong>The table was provided in form of Google Spreadsheet to my teammates so that they can compare models according to Eval F1 score or Validation F1 score.</strong></li>\n<li>Furthermore it showed that setting more than 10 epochs did improve train accuracy and validation accuracy, but didn't improve the model's performance in terms of Eval F1 score.</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Eval F1</th>\n<th>Valid F1</th>\n<th>Pretrained Model</th>\n<th>Train Albumentation</th>\n<th>Valid Albumentation</th>\n<th>Test Albumentation</th>\n<th>Class Division</th>\n<th>Train: Valid Split Ratio</th>\n<th>Train Batch Size</th>\n<th>Epoch</th>\n<th>Learning Rate</th>\n<th>Weight Decay</th>\n<th>Criterion (Loss)</th>\n<th>Optimizer</th>\n<th>Scheduler</th>\n<th>Date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.7111</td>\n<td>0.9279</td>\n<td>tf<em>efficientnet</em>b4</td>\n<td>Resize(height = 260, width = 200, p=1.0), HorizontalFlip(p=0.5), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(height = 260, width = 200, p=1.0), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize((260,200), Image.BILINEAR), ToTensor(), transforms.Normalize(mean=(0.53087462, 0.45734182, 0.42477556), std=(0.23390616, 0.2311533, 0.23603857)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>32</td>\n<td>9</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/31</td>\n</tr>\n<tr>\n<td>0.6975</td>\n<td>0.8737</td>\n<td>tf<em>efficientnet</em>b3</td>\n<td>Resize(height = 260, width = 200, p=1.0), HorizontalFlip(p=0.5), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(height = 260, width = 200, p=1.0), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize((260,200), Image.BILINEAR), ToTensor(), transforms.Normalize(mean=(0.53087462, 0.45734182, 0.42477556), std=(0.23390616, 0.2311533, 0.23603857)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>32</td>\n<td>9</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/31</td>\n</tr>\n<tr>\n<td>0.7119</td>\n<td>0.9162</td>\n<td>tf<em>efficientnet</em>b4</td>\n<td>Resize(height = 350, width = 350, p=1.0), HorizontalFlip(p=0.5), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(height = 350, width = 350, p=1.0), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize((350,350), Image.BILINEAR), ToTensor(), transforms.Normalize(mean=(0.51573701, 0.46091698, 0.43106825), std=(0.23412625, 0.23709222, 0.24571251))</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>8</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/30</td>\n</tr>\n<tr>\n<td>0.6028</td>\n<td>0.8756</td>\n<td>tf<em>efficientnet</em>b4</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>10</td>\n<td>1e-1</td>\n<td>1e-5</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>SGDP</td>\n<td>MultiStepLR</td>\n<td>2021/08/29</td>\n</tr>\n<tr>\n<td>0.7197</td>\n<td>0.8949</td>\n<td>tf<em>efficientnet</em>b4</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>4</td>\n<td>1e-1</td>\n<td>1e-5</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>SGDP</td>\n<td>MultiStepLR</td>\n<td>2021/08/29</td>\n</tr>\n<tr>\n<td><strong>0.7260</strong></td>\n<td><strong>0.8903</strong></td>\n<td><strong>tf<em>efficientnet</em>b4</strong></td>\n<td><strong>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</strong></td>\n<td><strong>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</strong></td>\n<td><strong>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</strong></td>\n<td><strong>18</strong></td>\n<td><strong>0.9 : 0.1</strong></td>\n<td><strong>16</strong></td>\n<td><strong>10</strong></td>\n<td><strong>3e-4</strong></td>\n<td><strong>1e-2</strong></td>\n<td><strong>FocalLoss(gamma = 5)</strong></td>\n<td><strong>AdamP</strong></td>\n<td><strong>MultiStepLR</strong></td>\n<td><strong>2021/08/27</strong></td>\n</tr>\n<tr>\n<td>0.7259</td>\n<td>0.903</td>\n<td>tf<em>efficientnet</em>b4</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>17</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/28</td>\n</tr>\n<tr>\n<td>0.7170</td>\n<td>0.886</td>\n<td>resnext50_32x4d</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>32</td>\n<td>10</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/26</td>\n</tr>\n<tr>\n<td>0.6870</td>\n<td>0.8922</td>\n<td>vit<em>base</em>patch16_384</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 384, width = 384), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 384, width = 384), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>transforms.Compose([ Resize((512, 384), Image.BILINEAR), transforms.CenterCrop((384,384)), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)), ])</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>10</td>\n<td>1e-4</td>\n<td>1e-6</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/26</td>\n</tr>\n<tr>\n<td>0.6820</td>\n<td>0.896</td>\n<td>vit<em>large</em>patch32<em>224</em>in21k</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height =224, width = 224), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height =224, width = 224), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>transforms.Compose([ Resize((512, 384), Image.BILINEAR), transforms.CenterCrop((224,224)), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)), ])</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>3</td>\n<td>1e-4</td>\n<td>1e-6</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/27</td>\n</tr>\n<tr>\n<td>0.6730</td>\n<td>0.856</td>\n<td>resnet50</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0)</td>\n<td>Resize((512, 384), Image.BILINEAR), transforms.CenterCrop(height = 350, width = 350), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)),</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>32</td>\n<td>10</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/26</td>\n</tr>\n<tr>\n<td>0.4423</td>\n<td>0.8583</td>\n<td>vit<em>base</em>patch16_384</td>\n<td>Resize(img<em>size[0], img</em>size[1], p=1.0), CenterCrop(height = 350, width = 350), Resize(384, 384, p=1.0), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>Resize(img<em>size[0], img</em>size[1]), CenterCrop(height = 350, width = 350), # add centercrop Resize(384, 384, p=1.0), Normalize(mean=mean, std=std, max<em>pixel</em>value=255.0, p=1.0), ToTensorV2(p=1.0),</td>\n<td>transforms.Compose([ Resize((512, 384), Image.BILINEAR), transforms.CenterCrop((350,350)), Resize((384, 384), Image.BILINEAR), ToTensor(), transforms.Normalize((0.56019358, 0.52410121, 0.501457), (0.23318603, 0.24300033, 0.24567522)), ])</td>\n<td>18</td>\n<td>0.9 : 0.1</td>\n<td>16</td>\n<td>10</td>\n<td>3e-4</td>\n<td>1e-2</td>\n<td>FocalLoss(gamma = 5)</td>\n<td>AdamP</td>\n<td>MultiStepLR</td>\n<td>2021/08/27</td>\n</tr>\n<tr>\n<td>0.0550</td>\n<td>0.99 0.92 0.95</td>\n<td>resnet50</td>\n<td>transforms.RandomResizedCrop(224), transforms.RandomHorizontalFlip(), transforms.ToTensor(), transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</td>\n<td>transforms.RandomResizedCrop(224), transforms.RandomHorizontalFlip(), transforms.ToTensor(), transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</td>\n<td>transforms.Resize(256), transforms.CenterCrop(224), transforms.ToTensor(), transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</td>\n<td>3 x 3 x 2</td>\n<td>0.6 : 0.2 : 0.2</td>\n<td>256</td>\n<td>10</td>\n<td>1e-4</td>\n<td>-</td>\n<td>CrossEntropyLoss</td>\n<td>Adam</td>\n<td>StepLR</td>\n<td>2021/08/25</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"how-to-resolve-the-class-imbalance-of-train-dataset\" style=\"position:relative;\"><a href=\"#how-to-resolve-the-class-imbalance-of-train-dataset\" aria-label=\"how to resolve the class imbalance of train dataset permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to resolve the Class Imbalance of train dataset</h2>\n<ul>\n<li>Females outnumbered males (1700 females vs 1000 males)</li>\n<li>There were 200 individuals that were Age of 60 out of total 2700 individuals. They were the only individuals that consisted of the Class 60 and Above.</li>\n</ul>\n<img height=\"250\" width=\"500\" alt=\"image\" src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/Untitled.png\">\n<img height=\"250\f\" width=\"600\" alt=\"image\" src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/Untitled 1.png\">\n<img height=\"250\f\" width=\"600\" alt=\"image\" src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/Untitled 2.png\">\n<ul>\n<li>Class of 60 and Above are consisted of only 17% of the total dataset.</li>\n<li>Mask Class is distributed as Wear 7 : Incorrect 1 : Not Wear 1</li>\n<li>RGB Mean was [0.56019358 0.52410121 0.501457]</li>\n<li>RGB Standard Deviation was [0.23318603 0.24300033 0.24567522]</li>\n<li>Out of 18 classes, there were two classes that consisted of only 0.44%(83 pics). There were also two classes that consisted of 20%(2000 pics).</li>\n</ul>\n<h3 id=\"choosing-loss-for-the-class-imbalance\" style=\"position:relative;\"><a href=\"#choosing-loss-for-the-class-imbalance\" aria-label=\"choosing loss for the class imbalance permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choosing Loss for the Class Imbalance</h3>\n<p>I decided to use FocalLoss in order to resolve such class imbalance. Compared to cross entropy loss, Focal Loss was purported to reduce the proportion of background on the training image which definitely outnumbered the size of the objects in the dataset. <strong>Focal Loss with gamma value of 5 outperformed Cross Entropy Loss.</strong></p>\n<img height=\"300\f\" width=\"500\" alt=\"image\" src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/Untitled 4.png\">\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FocalLoss</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">weight</span><span class=\"mtk1\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">gamma</span><span class=\"mtk1\">=</span><span class=\"mtk7\">2</span><span class=\"mtk1\">., </span><span class=\"mtk7 mtki\">reduction</span><span class=\"mtk1\">=</span><span class=\"mtk6\">&#39;mean&#39;</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        nn.Module.</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> weight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> gamma</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> reduction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">input_tensor</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">target_tensor</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        log_prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">log_softmax</span><span class=\"mtk1\">(input_tensor, </span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        prob </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">exp</span><span class=\"mtk1\">(log_prob)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> F.</span><span class=\"mtk3\">nll_loss</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ((</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> prob) </span><span class=\"mtk8\">**</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.gamma) </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> log_prob,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            target_tensor,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">weight</span><span class=\"mtk8\">=</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.weight,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4 mtki\">reduction</span><span class=\"mtk8\">=</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.reduction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span></code></pre>\n<h3 id=\"adding-dataset-to-resolve-class-imbalance\" style=\"position:relative;\"><a href=\"#adding-dataset-to-resolve-class-imbalance\" aria-label=\"adding dataset to resolve class imbalance permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding Dataset to resolve class imbalance</h3>\n<ul>\n<li>Also, in order to resolve the class imbalance I decided to add external dataset for the Age of 60 from <a href=\"https://github.com/JingchunCheng/All-Age-Faces-Dataset\">All-Age-Faces-Dataset</a>.</li>\n<li><a href=\"https://github.com/aqeelanwar/MaskTheFace\">Using the MaskTheFace opensource project</a>, User can arbitrarily choose the color, color weight, patterns and the types of mask.</li>\n<li><strong>From two open-source projects, I constructed external dataset like the following:</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th align=\"center\">normal</th>\n<th align=\"center\">mask1</th>\n<th align=\"center\">mask2</th>\n<th align=\"center\">mask3</th>\n<th align=\"center\">mask4</th>\n<th align=\"center\">mask5</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><img src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/12792A62.jpg\" alt=\"12792A62\"></td>\n<td align=\"center\"><img src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/12792A62_KN95_5.jpg\" alt=\"12792A62_KN95_5\"></td>\n<td align=\"center\"><img src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/12792A62_N95_64.jpg\" alt=\"12792A62_N95_64\"></td>\n<td align=\"center\"><img src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/12792A62_cloth_16.jpg\" alt=\"12792A62_cloth_16\"></td>\n<td align=\"center\"><img src=\"../assets/images/2021-09-04-Mask-Age-Gender-Classification-Competition/12792A62_surgical_63.jpg\" alt=\"12792A62_surgical_63\"></td>\n<td align=\"center\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 309px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 128.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAAFA//EABcBAAMBAAAAAAAAAAAAAAAAAAECAwD/2gAMAwEAAhADEAAAAQoFoStykQcisBTy3rrYf//EAB0QAAICAgMBAAAAAAAAAAAAAAECAAMSExARISL/2gAIAQEAAQUCpIWv5aakig5N6kSwdhhMRxQx2T//xAAaEQACAgMAAAAAAAAAAAAAAAAAAQIREiEx/9oACAEDAQE/AVwpCnoyZ//EABYRAQEBAAAAAAAAAAAAAAAAAAARAf/aAAgBAgEBPwHVRH//xAAdEAABAwUBAAAAAAAAAAAAAAAAARAhETEyQWGR/9oACAEBAAY/Ap2SnpiU4WfjpKt//8QAHRABAAICAgMAAAAAAAAAAAAAAQAREDEhkUFRcf/aAAgBAQABPyG57Lgnh6UXdIYUvhA0em8Wauyrmwx9sFA7psJ//9oADAMBAAIAAwAAABB/LML/xAAYEQADAQEAAAAAAAAAAAAAAAAAAWERIf/aAAgBAwEBPxB2sEhvBQ//xAAYEQEBAAMAAAAAAAAAAAAAAAAAEQExUf/aAAgBAgEBPxDZXWWX/8QAHBABAAMBAQADAAAAAAAAAAAAAQARITFhEEFx/9oACAEBAAE/EC7a0C1rIPBrwPZaKvxSW+IUA+kuMbCreEYmwwDCh5XIgsXhrbnkPF+AsAbAUNDqmrP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"12792A62_surgical_31\"\n        title=\"12792A62_surgical_31\"\n        src=\"/static/87d4018541ffd5cc69056ea9dac7bd04/6d442/12792A62_surgical_31.jpg\"\n        srcset=\"/static/87d4018541ffd5cc69056ea9dac7bd04/f93b5/12792A62_surgical_31.jpg 300w,\n/static/87d4018541ffd5cc69056ea9dac7bd04/6d442/12792A62_surgical_31.jpg 309w\"\n        sizes=\"(max-width: 309px) 100vw, 309px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>By adding 646 males and 620 females who were age 60 and above, I thought this would have helped the model's performance on age classification.</li>\n<li>The format of the added image folder, the format of the added image information on <code>train.csv</code> adhered to according to the competition's provided format.</li>\n<li>For example, previous train dataset started with id number of <code>0xxxxx</code> Individual ids. Additional external train dataset were concat where male id starts with <code>1xxxxx</code> and female ids starts with <code>2xxxxx</code> , in order to separate itself from the original dataset.</li>\n<li>The following is the code for randomizing mask pattern and color weight for individuals. The project did provide batch processing, but it did not provide function for randomizing both pattern and color.</li>\n<li>Unfortunately the following code didn't help the model performance to improve. It was both experimented by me and my teammates, but the f1_score oscilated in between the significance probability level 0.05.</li>\n</ul>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> os</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> random</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> glob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> itertools</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> IPython.display </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> clear_output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">BASE_COMMAND</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;python mask_the_face.py&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PATTERN_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/Users/noopy/Documents/dataset-kitchen/_clones/MaskTheFace/masks/textures&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">OLD_MALE_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/Users/noopy/Documents/dataset-kitchen/_clones/_DATASET/Old-Male/AGEFACE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">OLD_FEMALE_PATH</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/Users/noopy/Documents/dataset-kitchen/_clones/_DATASET/Old-Female/AGEFACE&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mask_types </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;surgical_green&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;surgical_blue&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;N95&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;KN95&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;cloth&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># find all items in the folder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">images_paths </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">OLD_MALE_PATH</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;*&quot;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(images_paths))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># repeat the list images_path by 5 times</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">images_paths </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">list</span><span class=\"mtk1\">(itertools.chain.</span><span class=\"mtk3\">from_iterable</span><span class=\"mtk1\">(itertools.</span><span class=\"mtk3\">repeat</span><span class=\"mtk1\">(x, </span><span class=\"mtk7\">5</span><span class=\"mtk1\">) </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> x </span><span class=\"mtk10 mtki\">in</span><span class=\"mtk1\"> images_paths))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(images_paths))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># get random hex values color</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">get_random_color</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;#</span><span class=\"mtk7\">%02x%02x%02x</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk8\">%</span><span class=\"mtk1\"> (random.</span><span class=\"mtk3\">randint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">255</span><span class=\"mtk1\">), random.</span><span class=\"mtk3\">randint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">255</span><span class=\"mtk1\">), random.</span><span class=\"mtk3\">randint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">255</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">mask_types </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [</span><span class=\"mtk6\">&quot;surgical_green&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;surgical_blue&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;N95&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;KN95&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&quot;cloth&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># get folders in side of pattern_path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">folders </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PATTERN_PATH</span><span class=\"mtk1\">, folder) </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> folder </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> os.</span><span class=\"mtk3\">listdir</span><span class=\"mtk1\">(</span><span class=\"mtk7\">PATTERN_PATH</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">patterns </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> folder </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> folders:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\"># collect all jpg and png items inside of the folder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  patterns </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(folder, </span><span class=\"mtk6\">&quot;*.jpg&quot;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  patterns </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(folder, </span><span class=\"mtk6\">&quot;*.png&quot;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> path </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> images_paths:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># chose random item from the list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    mask_type </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> mask_types[random.</span><span class=\"mtk3\">randint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(mask_types) </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># range color weight between 0.2 to 0.7</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    color_weight </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> random.</span><span class=\"mtk3\">uniform</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.7</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># define random hex color</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    color_hex </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">get_random_color</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># get random path out of patterns</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    patterns_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> random.</span><span class=\"mtk3\">choice</span><span class=\"mtk1\">(patterns)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># get random pattern weight out of [0, 0.5, 1], choose more weight on 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    pattern_weight </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> random.</span><span class=\"mtk3\">choice</span><span class=\"mtk1\">([</span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.5</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1.0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># generate the command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    command </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{BASE_COMMAND}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --path &#39;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">path</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39; </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --mask_type random </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --pattern &#39;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">patterns_path</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39; </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --pattern_weight </span><span class=\"mtk7\">{</span><span class=\"mtk1\">pattern_weight</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --color &#39;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">color_hex</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39; </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --color_weight </span><span class=\"mtk7\">{</span><span class=\"mtk1\">color_weight</span><span class=\"mtk7\">}</span><span class=\"mtk6\"> </span><span class=\"mtk7\">\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">        --verbose&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># execute the command</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    os.</span><span class=\"mtk3\">system</span><span class=\"mtk1\">(command)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># clear the output</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">clear_output</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<h3 id=\"oversampling-to-alleviate-class-imbalance\" style=\"position:relative;\"><a href=\"#oversampling-to-alleviate-class-imbalance\" aria-label=\"oversampling to alleviate class imbalance permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Oversampling to Alleviate Class Imbalance.</h3>\n<ul>\n<li>Since the class age 60 and above only included the age of 60, my teammates suggested to use age 58 &#x26; age 59 to relabeled as the class of age 60 and above.</li>\n<li><strong>This oversampling attempt significantly improved the validation f1 score from 0.75 to 0.76.</strong></li>\n</ul>\n<h2 id=\"cropping-face-to-reduce-noise\" style=\"position:relative;\"><a href=\"#cropping-face-to-reduce-noise\" aria-label=\"cropping face to reduce noise permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cropping face to reduce noise</h2>\n<p><a href=\"https://github.com/snoop2head/debugging-practice/blob/main/5_Locate_face_bounding_box_facenet_pytorch.ipynb\">ðŸ”— Locate<em>face</em>bounding<em>box</em>MTCNN_Retinaface.ipynb</a></p>\n<ul>\n<li>I thought it was important to reduce the background noise intervention for the train dataset. Therefore, it was essential to either Centercrop or extract the face data only from the image.</li>\n<li><strong>I combined MTCNN that utilized GPU but with lower accuracy, Retinace that utilized CPU only but with higher accuracy.</strong></li>\n<li>I shared the code with other Naver BoostCamp participants and it seems like many groups have implemented it.</li>\n</ul>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> torch.nn </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> nn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> pandas </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> pd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> numpy </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> np</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> os</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> cv2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> facenet_pytorch </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> </span><span class=\"mtk7\">MTCNN</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> tqdm.notebook </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> tqdm</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> retinaface </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> RetinaFace</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> glob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># make empty dataframe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_image </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">DataFrame</span><span class=\"mtk1\">({})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cnt </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># intialize iteration count</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># padding value before cropping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">X_PADDING</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">Y_PADDING</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtki\"># gave more padding in order to include mask on the chin &amp; hair style</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># iterrate rows for the given training dataset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> index, row </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(df_label.</span><span class=\"mtk3\">iterrows</span><span class=\"mtk1\">()):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\"># get default values</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  train_image_paths </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk8\">id</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> row[</span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  gender </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> row[</span><span class=\"mtk6\">&quot;gender&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  race </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> row[</span><span class=\"mtk6\">&quot;race&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  age </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> row[</span><span class=\"mtk6\">&quot;age&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  profile </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> row[</span><span class=\"mtk6\">&quot;path&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  profile_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TRAIN_IMGS_DATASET_PATH</span><span class=\"mtk1\">, profile)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\"># print(profile_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\"># get list of images from the given profile path</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  jpg_file_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">profile_path</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/*.jpg&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  jpeg_file_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">profile_path</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/*.jpeg&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  png_file_list </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> glob.</span><span class=\"mtk3\">glob</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{</span><span class=\"mtk1\">profile_path</span><span class=\"mtk7\">}</span><span class=\"mtk6\">/*.png&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  list_images </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> jpg_file_list </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> jpeg_file_list </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> png_file_list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\"># print(list_images)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> image_file_path </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> list_images:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    cnt </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># read image and extract information using mtcnn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    img </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> cv2.</span><span class=\"mtk3\">imread</span><span class=\"mtk1\">(image_file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    img </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> cv2.</span><span class=\"mtk3\">cvtColor</span><span class=\"mtk1\">(img, cv2.</span><span class=\"mtk7\">COLOR_BGR2RGB</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    boxes, probs, landmarks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> mtcnn.</span><span class=\"mtk3\">detect</span><span class=\"mtk1\">(img, </span><span class=\"mtk4 mtki\">landmarks</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># default detection with mtcnn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> probs[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># print(&quot;solved with mtcnn&quot;)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># save face bounding box information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      xmin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(boxes[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">X_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ymin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(boxes[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">Y_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      xmax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(boxes[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">X_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ymax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(boxes[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">Y_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># save landmark information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      left_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> landmarks[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      right_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> landmarks[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      mouth_left </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> landmarks[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      mouth_right </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> landmarks[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      nose </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> landmarks[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># if mtcnn fails, use retinaface</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">else</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      result_detected </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> RetinaFace.</span><span class=\"mtk3\">detect_faces</span><span class=\"mtk1\">(image_file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># print(result_detected)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># try retinaface to resolve,:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk8\">type</span><span class=\"mtk1\">(result_detected) </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk8\">dict</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;resolving with retinaface: &quot;</span><span class=\"mtk1\">, image_file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># save face bounding box information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        xmin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(result_detected[</span><span class=\"mtk6\">&quot;face_1&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;facial_area&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">X_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ymin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(result_detected[</span><span class=\"mtk6\">&quot;face_1&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;facial_area&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk7\">1</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">Y_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        xmax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(result_detected[</span><span class=\"mtk6\">&quot;face_1&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;facial_area&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk7\">2</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">X_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ymax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(result_detected[</span><span class=\"mtk6\">&quot;face_1&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;facial_area&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk7\">3</span><span class=\"mtk1\">]) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">Y_PADDING</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># save landmark information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        face_landmarks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> result_detected[</span><span class=\"mtk6\">&quot;face_1&quot;</span><span class=\"mtk1\">][</span><span class=\"mtk6\">&quot;landmarks&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        left_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> face_landmarks[</span><span class=\"mtk6\">&quot;left_eye&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        right_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> face_landmarks[</span><span class=\"mtk6\">&quot;right_eye&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mouth_left </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> face_landmarks[</span><span class=\"mtk6\">&quot;mouth_left&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mouth_right </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> face_landmarks[</span><span class=\"mtk6\">&quot;mouth_right&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        nose </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> face_landmarks[</span><span class=\"mtk6\">&quot;nose&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk5 mtki\"># if both of the detection fails, center crop</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10 mtki\">elif</span><span class=\"mtk1\"> </span><span class=\"mtk8\">type</span><span class=\"mtk1\">(result_detected) </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk8\">tuple</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;this one is causing trouble: &quot;</span><span class=\"mtk1\">, image_file_path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># manually set coordinates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># xmin = 50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># ymin = 100</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># xmax = 350</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># ymax = 400</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        xmin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">80</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ymin </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        xmax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">80</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">220</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ymax </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">320</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk5 mtki\"># leave landmark information empty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        face_landmarks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> left_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> right_eye </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.nan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mouth_left </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> mouth_right </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nose </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> np.nan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># add row to the df_images with the extracted information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    df_image </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_image.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;id&quot;</span><span class=\"mtk1\">:</span><span class=\"mtk8\">id</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;gender&quot;</span><span class=\"mtk1\">:gender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;race&quot;</span><span class=\"mtk1\">:race,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;age&quot;</span><span class=\"mtk1\">:age,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;path&quot;</span><span class=\"mtk1\">: profile,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">: image_file_path,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;xmin&quot;</span><span class=\"mtk1\">: xmin,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ymin&quot;</span><span class=\"mtk1\">: ymin,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;xmax&quot;</span><span class=\"mtk1\">: xmax,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;ymax&quot;</span><span class=\"mtk1\">: ymax,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;left_eye&quot;</span><span class=\"mtk1\">: left_eye,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;right_eye&quot;</span><span class=\"mtk1\">: right_eye,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;mouth_left&quot;</span><span class=\"mtk1\">: mouth_left,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;mouth_right&quot;</span><span class=\"mtk1\">: mouth_right,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">&quot;nose&quot;</span><span class=\"mtk1\">: nose</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }, </span><span class=\"mtk4 mtki\">ignore_index</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\"># print data information every 100 iterations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> cnt </span><span class=\"mtk8\">%</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk8\">==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(df_image.shape)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(df_image.</span><span class=\"mtk3\">info</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(df_image.</span><span class=\"mtk3\">tail</span><span class=\"mtk1\">())</span></span></span></code></pre>\n<ul>\n<li>Landmark information and face coordinates were integrated with <code>train.csv</code> file for later image cropping: it purported to be processed in cv2 or PIL.</li>\n<li>It did improve ViT models' performance. <strong>However, it turned out that extracting facial characteristics didn't improve the Efficientnet model's performance.</strong> Result turned out that center cropping (horizontal = 400, width = 200) pixel were more effective for efficientnet models. Center cropping with longer height included essential characteristics to include neck wrinkles &#x26; facial wrinkles to discern age class.</li>\n<li>\n<p>Pictures were often exceptionally cropped in small size. This was because MTCNN of Pytorch FaceNet often detected patterns of the mask or patterns of the clothes as eyes/nose/lips. These anomalies were later filtered by cropped pictures' width and height.</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> pandas </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> pd</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> numpy </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> np</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> matplotlib.pyplot </span><span class=\"mtk10 mtki\">as</span><span class=\"mtk1\"> plt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># read train_images.csv which contains predefined facial coordinate information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./train_images.csv&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train.</span><span class=\"mtk3\">head</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">x_range </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;xmax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;xmin&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">y_range </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;ymax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;ymin&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># plot distribution of x_range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plt.</span><span class=\"mtk3\">hist</span><span class=\"mtk1\">(x_range, </span><span class=\"mtk4 mtki\">bins</span><span class=\"mtk8\">=</span><span class=\"mtk7\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># check distribution statistics of x_range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">x_range.</span><span class=\"mtk3\">describe</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># set minimum for the width by mean - 1.96 sigma (approximately bottom 3%)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">x_restriction </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(x_range.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1.96</span><span class=\"mtk1\"> </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> x_range.</span><span class=\"mtk3\">std</span><span class=\"mtk1\">()) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># plot distribution of y_range</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">plt.</span><span class=\"mtk3\">hist</span><span class=\"mtk1\">(y_range, </span><span class=\"mtk4 mtki\">bins</span><span class=\"mtk8\">=</span><span class=\"mtk7\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># set minimum for the height by mean - 1.96 sigma (approximately bottom 3%)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">y_restriction </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">int</span><span class=\"mtk1\">(y_range.</span><span class=\"mtk3\">mean</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1.96</span><span class=\"mtk1\"> </span><span class=\"mtk8\">*</span><span class=\"mtk1\"> y_range.</span><span class=\"mtk3\">std</span><span class=\"mtk1\">()) </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># get undersized cropped images that are under miniumum width and minum height</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_too_small </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> df_train_new[(df_train_new[</span><span class=\"mtk6\">&quot;xmax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;xmin&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\"> x_border) </span><span class=\"mtk8\">&amp;</span><span class=\"mtk1\"> (df_train_new[</span><span class=\"mtk6\">&quot;ymax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> df_train_new[</span><span class=\"mtk6\">&quot;ymin&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\"> y_border)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_too_small.</span><span class=\"mtk3\">info</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># set xmin = 80, ymin = 50, xmax = 80 + 220, ymax = 50 + 320 for df_train_new that matches df_train_too_small</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_new.loc[df_train_new[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">isin</span><span class=\"mtk1\">(df_train_too_small[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">]), </span><span class=\"mtk6\">&quot;xmin&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">80.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_new.loc[df_train_new[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">isin</span><span class=\"mtk1\">(df_train_too_small[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">]), </span><span class=\"mtk6\">&quot;ymin&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">50.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_new.loc[df_train_new[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">isin</span><span class=\"mtk1\">(df_train_too_small[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">]), </span><span class=\"mtk6\">&quot;xmax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">80.0</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">220.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_new.loc[df_train_new[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">].</span><span class=\"mtk3\">isin</span><span class=\"mtk1\">(df_train_too_small[</span><span class=\"mtk6\">&quot;image_file_path&quot;</span><span class=\"mtk1\">]), </span><span class=\"mtk6\">&quot;ymax&quot;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">50.0</span><span class=\"mtk1\"> </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> </span><span class=\"mtk7\">320.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\"># save fixed information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">df_train_new.</span><span class=\"mtk3\">to_csv</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;./train_images.csv&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">index</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span></code></pre>\n</li>\n<li>Same process of detecting &#x26; cropping facial information was applied on the evaluation image dataset.</li>\n</ul>\n<h2 id=\"other-teammates-ideas--contributions\" style=\"position:relative;\"><a href=\"#other-teammates-ideas--contributions\" aria-label=\"other teammates ideas  contributions permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other teammate's ideas &#x26; contributions</h2>\n<h3 id=\"1-applying-stratified-k-fold\" style=\"position:relative;\"><a href=\"#1-applying-stratified-k-fold\" aria-label=\"1 applying stratified k fold permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Applying Stratified K-fold</h3>\n<p>One thing to note is that stratified K-fold should have stopped more or less at 2nd or 3rd fold. After then, the model has already seen both the train and test set, therefore the further training should be halted.</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> sklearn.model_selection </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> KFold , StratifiedKFold</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> epoch </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_val_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_class_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_class_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_mask_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_mask_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_gender_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_gender_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_age_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    epoch_age_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [[] </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    stratified_kfold </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">StratifiedKFold</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">n_splits</span><span class=\"mtk8\">=</span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">random_state</span><span class=\"mtk8\">=</span><span class=\"mtk7\">None</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    k_idx </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> train_index, validate_index </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> stratified_kfold.</span><span class=\"mtk3\">split</span><span class=\"mtk1\">(np.</span><span class=\"mtk3\">zeros</span><span class=\"mtk1\">(</span><span class=\"mtk8\">len</span><span class=\"mtk1\">(train_ages)), train_ages):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&#39;## Stratified_K-Fold :: </span><span class=\"mtk7\">{</span><span class=\"mtk1\">k_idx</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        k_idx </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        train_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.utils.data.dataset.</span><span class=\"mtk3\">Subset</span><span class=\"mtk1\">(dataset, train_index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        valid_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.utils.data.dataset.</span><span class=\"mtk3\">Subset</span><span class=\"mtk1\">(dataset, validate_index)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        valid_dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> copy.</span><span class=\"mtk3\">deepcopy</span><span class=\"mtk1\">(valid_dataset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        valid_dataset.dataset.transform </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> transform_val</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        train_loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(train_dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk8\">=</span><span class=\"mtk7\">32</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">num_workers</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">drop_last</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                   )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        val_loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(valid_dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">batch_size</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">32</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk4 mtki\">num_workers</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                   )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i, data </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(</span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(train_loader), </span><span class=\"mtk4 mtki\">desc</span><span class=\"mtk8\">=</span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;epoch-</span><span class=\"mtk7\">{</span><span class=\"mtk1\">epoch</span><span class=\"mtk7\">}</span><span class=\"mtk6\">&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">total</span><span class=\"mtk8\">=len</span><span class=\"mtk1\">(train_loader)):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            inputs, (labels, masks, genders, ages) </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            optimizer.</span><span class=\"mtk3\">zero_grad</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            outputs_mask, outputs_gender, outputs_age </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(inputs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            outputs_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_labels</span><span class=\"mtk1\">(outputs_mask, outputs_gender, outputs_age, device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss_masks </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(outputs_mask, masks)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss_genders </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(outputs_gender, genders)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss_ages </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(outputs_age, ages)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> loss_masks </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> loss_genders </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> loss_ages</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_loss </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_acc</span><span class=\"mtk1\">(outputs_label, labels)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_acc </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> acc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_class_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc</span><span class=\"mtk1\">(outputs_label, labels, epoch_class_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_mask_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_mask</span><span class=\"mtk1\">(outputs_mask, masks, epoch_mask_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_gender_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_gender</span><span class=\"mtk1\">(outputs_gender, genders, epoch_gender_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            epoch_age_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_age</span><span class=\"mtk1\">(outputs_age, ages, epoch_age_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            loss.</span><span class=\"mtk3\">backward</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            optimizer.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            scheduler.</span><span class=\"mtk3\">step</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">no_grad</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> i, data </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">enumerate</span><span class=\"mtk1\">(val_loader):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_inputs, (val_labels, val_masks, val_genders, val_ages) </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_outputs_mask, val_outputs_gender, val_outputs_age </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model</span><span class=\"mtk1\">(val_inputs)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_outputs_label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_labels</span><span class=\"mtk1\">(val_outputs_mask, val_outputs_gender, val_outputs_age, device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_loss_mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(val_outputs_mask, val_masks)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_loss_gender </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(val_outputs_gender, val_genders)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_loss_age </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">criterion</span><span class=\"mtk1\">(val_outputs_age, val_ages)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_loss </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> val_loss_mask </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> val_loss_gender </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> val_loss_age</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_val_loss </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> val_loss</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_acc</span><span class=\"mtk1\">(val_outputs_label, val_labels)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_val_acc </span><span class=\"mtk8\">+=</span><span class=\"mtk1\"> val_acc</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_class_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc</span><span class=\"mtk1\">(val_outputs_label, val_labels, epoch_class_val_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_mask_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_mask</span><span class=\"mtk1\">(val_outputs_mask, val_masks, epoch_mask_val_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_gender_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_gender</span><span class=\"mtk1\">(val_outputs_gender, val_genders, epoch_gender_val_acc)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                epoch_age_val_acc </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">func_class_acc_age</span><span class=\"mtk1\">(val_outputs_age, val_ages, epoch_age_val_acc)</span></span></span></code></pre>\n<h3 id=\"2-applying-out-of-fold-ensemble\" style=\"position:relative;\"><a href=\"#2-applying-out-of-fold-ensemble\" aria-label=\"2 applying out of fold ensemble permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Applying Out-of-fold Ensemble</h3>\n<p>I believed that ensemble won't improve the model's performance, but it did! Teammates has tried both the hard voting ensemble(counting discrete integer of labels) and soft voting ensemble(summing predicted probabilities). We adapted soft voting as the favorable approach.</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/content/v4_stkfold5_epoch3_transformer_2th_000_loss_0.12.ckpt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model1 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">MyModel</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model1.</span><span class=\"mtk3\">load_state_dict</span><span class=\"mtk1\">(torch.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(model_path))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model1.</span><span class=\"mtk3\">cuda</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/content/v4_stkfold5_epoch3_transformer_3th_000_loss_0.033.ckpt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model2 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">MyModel</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model2.</span><span class=\"mtk3\">load_state_dict</span><span class=\"mtk1\">(torch.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(model_path))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model2.</span><span class=\"mtk3\">cuda</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model_path </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/content/v4_stkfold5_epoch3_transformer_3th_001_loss_0.033.ckpt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model3 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">MyModel</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model3.</span><span class=\"mtk3\">load_state_dict</span><span class=\"mtk1\">(torch.</span><span class=\"mtk3\">load</span><span class=\"mtk1\">(model_path))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model3.</span><span class=\"mtk3\">cuda</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torch.utils.data </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> Dataset, DataLoader</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TestDataset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Dataset</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">img_paths</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">transform</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.img_paths </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> img_paths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.transform </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> transform</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__getitem__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">index</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        image </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> Image.</span><span class=\"mtk3\">open</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.img_paths[index])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.transform:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            image </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">transform</span><span class=\"mtk1\">(image)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> image, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.img_paths[index]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__len__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> </span><span class=\"mtk8\">len</span><span class=\"mtk1\">(</span><span class=\"mtk11\">self</span><span class=\"mtk1\">.img_paths)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">from</span><span class=\"mtk1\"> torchvision </span><span class=\"mtk10 mtki\">import</span><span class=\"mtk1\"> transforms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">TEST_DIR</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;/content/input/data/eval&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">submission </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pd.</span><span class=\"mtk3\">read_csv</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TEST_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;info.csv&#39;</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">image_dir </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TEST_DIR</span><span class=\"mtk1\">, </span><span class=\"mtk6\">&#39;images&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">image_paths </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(image_dir, img_id) </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> img_id </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> submission.ImageID]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">valid_transform </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> transforms.</span><span class=\"mtk3\">Compose</span><span class=\"mtk1\">([</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    transforms.</span><span class=\"mtk3\">CenterCrop</span><span class=\"mtk1\">((</span><span class=\"mtk7\">400</span><span class=\"mtk1\">,</span><span class=\"mtk7\">200</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    transforms.</span><span class=\"mtk3\">ToTensor</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    transforms.</span><span class=\"mtk3\">Normalize</span><span class=\"mtk1\">((</span><span class=\"mtk7\">0.56019358</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.52410121</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.501457</span><span class=\"mtk1\">), (</span><span class=\"mtk7\">0.23318603</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.24300033</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.24567522</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dataset </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">TestDataset</span><span class=\"mtk1\">(image_paths, valid_transform)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">loader </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">DataLoader</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\">shuffle</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">device </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">device</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;cuda&#39;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model1.</span><span class=\"mtk3\">eval</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model2.</span><span class=\"mtk3\">eval</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">model3.</span><span class=\"mtk3\">eval</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pred_result </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">all_predictions </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> images, path </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk3\">tqdm</span><span class=\"mtk1\">(loader):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    temp </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    temp.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(path)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10 mtki\">with</span><span class=\"mtk1\"> torch.</span><span class=\"mtk3\">no_grad</span><span class=\"mtk1\">():</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        images </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> images.</span><span class=\"mtk3\">type</span><span class=\"mtk1\">(torch.FloatTensor).</span><span class=\"mtk3\">to</span><span class=\"mtk1\">(device)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pred1 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model1</span><span class=\"mtk1\">(images)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pred2 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model2</span><span class=\"mtk1\">(images)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pred3 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">model3</span><span class=\"mtk1\">(images)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pred </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (pred1 </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> pred2 </span><span class=\"mtk8\">+</span><span class=\"mtk1\"> pred3)</span><span class=\"mtk8\">/</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pred </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> pred.</span><span class=\"mtk3\">argmax</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">dim</span><span class=\"mtk8\">=-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        temp.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(pred)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        all_predictions.</span><span class=\"mtk3\">extend</span><span class=\"mtk1\">(pred.</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">().</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    pred_result.</span><span class=\"mtk3\">append</span><span class=\"mtk1\">(temp)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">submission[</span><span class=\"mtk6\">&#39;ans&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> all_predictions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">PRETRAINED_MODEL_NAME</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot;eff_b4_stkkfold_v4_kfold_arcface&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">file_name </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">f</span><span class=\"mtk6\">&quot;</span><span class=\"mtk7\">{PRETRAINED_MODEL_NAME}</span><span class=\"mtk6\">_submission.csv&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">submission.</span><span class=\"mtk3\">to_csv</span><span class=\"mtk1\">(os.path.</span><span class=\"mtk3\">join</span><span class=\"mtk1\">(</span><span class=\"mtk7\">TEST_DIR</span><span class=\"mtk1\">, file_name), </span><span class=\"mtk4 mtki\">index</span><span class=\"mtk8\">=</span><span class=\"mtk7\">False</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">print</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;test inference is done!&#39;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"3-applying-multihead-modeling\" style=\"position:relative;\"><a href=\"#3-applying-multihead-modeling\" aria-label=\"3 applying multihead modeling permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Applying Multihead Modeling</h3>\n<p>Rather than approaching the question as 18 classes classification problem, note823 suggested to approach it as multi-labeling problem. However that was too costly both computationaly and development-wise, so attaching 3 independent fully connected layers have done its job.</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">class</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MyModel</span><span class=\"mtk1\">(</span><span class=\"mtk11\">nn</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Module</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">super</span><span class=\"mtk1\">(MyModel, </span><span class=\"mtk11\">self</span><span class=\"mtk1\">).</span><span class=\"mtk8\">__init__</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> timm.</span><span class=\"mtk3\">create_model</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;tf_efficientnet_b4&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">pretrained</span><span class=\"mtk8\">=</span><span class=\"mtk7\">True</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.model.classifier </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1792</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1024</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.fc1 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1024</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.fc2 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1024</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.fc3 </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> nn.</span><span class=\"mtk3\">Linear</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1024</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">forward</span><span class=\"mtk1\">(</span><span class=\"mtk11 mtki\">self</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">x</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        fc_output </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">model</span><span class=\"mtk1\">(x)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mask </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">fc1</span><span class=\"mtk1\">(fc_output)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gender </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">fc2</span><span class=\"mtk1\">(fc_output)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        age </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\">.</span><span class=\"mtk3\">fc3</span><span class=\"mtk1\">(fc_output)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10 mtki\">return</span><span class=\"mtk1\"> mask, gender, age</span></span></span></code></pre>\n<p>Ever since the beginning, note823 has been attaching two fully connected layers to the backbone classifier. I was wondering why, but it was later figured out that having another fully connected layer at the end enabled the model to capture the hidden feature of the image.</p>\n<h2 id=\"other-insights\" style=\"position:relative;\"><a href=\"#other-insights\" aria-label=\"other insights permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Other insights</h2>\n<ul>\n<li>Validation Loss the was important KPI compared to validation accuracy or validation f1 score. There were some attempts that fixing individual's id for the train dataset and validation dataset to compare model's performance, but I thought this attempt might degrad the randomization of dataset allocation.</li>\n<li>Spending more time on label correction for the train dataset would have improved the accuracy. It was later found that more or less than 100 labels out of 18900 data was wrong.</li>\n<li>validation dataloader shuffle set to False does affect to the model's performance</li>\n<li>\n<p><strong>Visualization mattered a lot.</strong> It was essential to check the model's performance. Checking labels as such code enabled the model has been evaluated properly or not.</p>\n<pre class=\"grvsc-container one-dark-pro\" data-language=\"python\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">pred_result_iter </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">iter</span><span class=\"mtk1\">(pred_result)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">def</span><span class=\"mtk1\"> </span><span class=\"mtk3\">show_images</span><span class=\"mtk1\">(</span><span class=\"mtk7 mtki\">pred_result_iter</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">n</span><span class=\"mtk1\">=</span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">rows</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">cols</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk7 mtki\">title</span><span class=\"mtk1\"> = </span><span class=\"mtk6\">&#39;Default&#39;</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  plt.</span><span class=\"mtk3\">figure</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">figsize</span><span class=\"mtk8\">=</span><span class=\"mtk1\">(</span><span class=\"mtk7\">16</span><span class=\"mtk1\">,</span><span class=\"mtk7\">10</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  plt.</span><span class=\"mtk3\">suptitle</span><span class=\"mtk1\">(title, </span><span class=\"mtk4 mtki\">fontsize</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">16</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtki\">#     sampleList = random.sample(paths, n)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10 mtki\">for</span><span class=\"mtk1\"> k </span><span class=\"mtk10\">in</span><span class=\"mtk1\"> </span><span class=\"mtk8\">range</span><span class=\"mtk1\">(n):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      img, label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">next</span><span class=\"mtk1\">(pred_result_iter)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      label </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> label.</span><span class=\"mtk3\">cpu</span><span class=\"mtk1\">().</span><span class=\"mtk3\">numpy</span><span class=\"mtk1\">()[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      img </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> Image.</span><span class=\"mtk3\">open</span><span class=\"mtk1\">(img[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      plt.</span><span class=\"mtk3\">subplot</span><span class=\"mtk1\">(rows, cols, k</span><span class=\"mtk8\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      plt.</span><span class=\"mtk3\">imshow</span><span class=\"mtk1\">(img)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      plt.</span><span class=\"mtk3\">axis</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;off&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      plt.</span><span class=\"mtk3\">title</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;label:</span><span class=\"mtk7\">%s</span><span class=\"mtk6\">&quot;</span><span class=\"mtk8\">%</span><span class=\"mtk1\">(label))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">show_images</span><span class=\"mtk1\">(pred_result_iter, </span><span class=\"mtk4 mtki\">n</span><span class=\"mtk8\">=</span><span class=\"mtk7\">50</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">rows</span><span class=\"mtk8\">=</span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">cols</span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">title</span><span class=\"mtk8\">=</span><span class=\"mtk6\">&#39;Test Sample&#39;</span><span class=\"mtk1\">)</span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"should-have\" style=\"position:relative;\"><a href=\"#should-have\" aria-label=\"should have permalink\" class=\"toc-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>Should have</code>?</h2>\n<ul>\n<li>Checking the original label of the dataset should be prioritized rather than attaching the foreign dataset. <a href=\"https://github.com/jinmang2/boostcamp_ai_tech_2/blob/main/assets/ppt/palettai.pdf\">Team 8 was impressive in terms of using 5-fold trained BEiT models to predict the out-of-folds, check the conflicting votes which is regarded as wrong label.</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .one-dark-pro {\n    background-color: #282c34;\n    color: #abb2bf;\n  }\n  .one-dark-pro .mtki { font-style: italic; }\n  .one-dark-pro .mtk10 { color: #C678DD; }\n  .one-dark-pro .mtk1 { color: #ABB2BF; }\n  .one-dark-pro .mtk11 { color: #E5C07B; }\n  .one-dark-pro .mtk8 { color: #56B6C2; }\n  .one-dark-pro .mtk7 { color: #D19A66; }\n  .one-dark-pro .mtk6 { color: #98C379; }\n  .one-dark-pro .mtk3 { color: #61AFEF; }\n  .one-dark-pro .mtk4 { color: #E06C75; }\n  .one-dark-pro .mtk5 { color: #7F848E; }\n  .one-dark-pro .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","tableOfContents":"<ul>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#result\">Result</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#task-description\">Task Description</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#development-environment-settings\">Development Environment Settings</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#choosing-and-comparing-model\">Choosing and Comparing Model</a></li>\n<li>\n<p><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#how-to-resolve-the-class-imbalance-of-train-dataset\">How to resolve the Class Imbalance of train dataset</a></p>\n<ul>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#choosing-loss-for-the-class-imbalance\">Choosing Loss for the Class Imbalance</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#adding-dataset-to-resolve-class-imbalance\">Adding Dataset to resolve class imbalance</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#oversampling-to-alleviate-class-imbalance\">Oversampling to Alleviate Class Imbalance.</a></li>\n</ul>\n</li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#cropping-face-to-reduce-noise\">Cropping face to reduce noise</a></li>\n<li>\n<p><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#other-teammates-ideas--contributions\">Other teammate's ideas &#x26; contributions</a></p>\n<ul>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#1-applying-stratified-k-fold\">1. Applying Stratified K-fold</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#2-applying-out-of-fold-ensemble\">2. Applying Out-of-fold Ensemble</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#3-applying-multihead-modeling\">3. Applying Multihead Modeling</a></li>\n</ul>\n</li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#other-insights\">Other insights</a></li>\n<li><a href=\"/DL&#x26;ML/Mask-Age-Gender-Classification-Competition/#should-have\"><code>Should have</code>?</a></li>\n</ul>","frontmatter":{"date":"2021-09-04","title":"Classification Competition Wrap up report 1","tags":["ComputerVision","Competition"]}}},"pageContext":{"slug":"/DL&ML/Mask-Age-Gender-Classification-Competition/","previous":{"fields":{"slug":"/DL&ML/List-of-My-Questions/"},"frontmatter":{"title":"List of Unnoticed Questions"}},"next":{"fields":{"slug":"/DL&ML/NLP-Clipboard/"},"frontmatter":{"title":"NLP Clipboard"}}}},"staticQueryHashes":["1081905842","3911196313"]}